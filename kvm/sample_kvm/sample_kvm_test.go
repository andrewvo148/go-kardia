package sample_kvm

import (
	"math/big"
	"strings"
	"testing"

	"github.com/kardiachain/go-kardia/kai/state"
	kaidb "github.com/kardiachain/go-kardia/kai/storage"
	"github.com/kardiachain/go-kardia/kvm"
	"github.com/kardiachain/go-kardia/lib/abi"
	"github.com/kardiachain/go-kardia/lib/common"
	"github.com/kardiachain/go-kardia/lib/log"
)

func TestDefaults(t *testing.T) {
	cfg := new(Config)
	setDefaults(cfg)

	if cfg.Time == nil {
		t.Error("expected time to be non nil")
	}
	if cfg.GasLimit == 0 {
		t.Error("didn't expect gaslimit to be zero")
	}
	if cfg.GasPrice == nil {
		t.Error("expected time to be non nil")
	}
	if cfg.Value == nil {
		t.Error("expected time to be non nil")
	}
	if cfg.GetHashFn == nil {
		t.Error("expected time to be non nil")
	}
	if cfg.BlockHeight != 0 {
		t.Error("expected block number to be 0")
	}
}

func TestKVM(t *testing.T) {
	defer func() {
		if r := recover(); r != nil {
			t.Fatalf("crashed with: %v", r)
		}
	}()

	Execute([]byte{
		byte(kvm.TIMESTAMP),
		byte(kvm.GASLIMIT),
		byte(kvm.PUSH1),
		byte(kvm.ORIGIN),
		byte(kvm.BLOCKHASH),
		byte(kvm.COINBASE),
	}, nil, nil)
}

func TestExecute(t *testing.T) {
	ret, _, err := Execute([]byte{
		byte(kvm.PUSH1), 10,
		byte(kvm.PUSH1), 0,
		byte(kvm.MSTORE),
		byte(kvm.PUSH1), 32,
		byte(kvm.PUSH1), 0,
		byte(kvm.RETURN),
	}, nil, nil)
	if err != nil {
		t.Fatal("didn't expect error", err)
	}

	num := new(big.Int).SetBytes(ret)
	if num.Cmp(big.NewInt(10)) != 0 {
		t.Error("Expected 10, got", num)
	}
}

func TestCall(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(kaidb.NewMemStore()))
	address := common.HexToAddress("0x0a")
	state.SetCode(address, []byte{
		byte(kvm.PUSH1), 10,
		byte(kvm.PUSH1), 0,
		byte(kvm.MSTORE),
		byte(kvm.PUSH1), 32,
		byte(kvm.PUSH1), 0,
		byte(kvm.RETURN),
	})

	ret, _, err := Call(address, nil, &Config{State: state})
	if err != nil {
		t.Fatal("didn't expect error", err)
	}

	num := new(big.Int).SetBytes(ret)
	if num.Cmp(big.NewInt(10)) != 0 {
		t.Error("Expected 10, got", num)
	}
}

// Simple counter smart contract to be used for below tests:
/*
- counter.sol:
	pragma solidity ^0.4.24;
	contract Counter {
    	uint8 count;
    	function set(uint8 x) public {
        	count = x;
    	}
    	function get() public view returns (uint8) {
        	return count;
    	}
	}

- compiler: remix: 0.4.24+commit.e67f0147.Emscripten.clang
*/

// Test creating a simple smart contract on KVM.
// Note: Create uses the raw bytecode as generated from compiler
func TestCreateSimpleCounterSmc(t *testing.T) {
	// Add bytecode for counter.sol to create the smc:
	var input = common.Hex2Bytes("608060405234801561001057600080fd5b5060da8061001f6000396000f30060806040526004361060485763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166324b8ba5f8114604d5780636d4ce63c146067575b600080fd5b348015605857600080fd5b50606560ff60043516608f565b005b348015607257600080fd5b50607960a5565b6040805160ff9092168252519081900360200190f35b6000805460ff191660ff92909216919091179055565b60005460ff16905600a165627a7a723058206cc1a54f543612d04d3f16b0bbb49e9ded9ccf6d47f7789fe3577260346ed44d0029")
	_, _, _, err := Create(input, nil)
	if err != nil {
		t.Fatal(err)
	}
}

// Test executing the counter smart contract on KVM
// Note: Call uses the runtime_bytecode from the compiler, unlike the raw bytecode as in the previous unit test
func TestCallSimpleCounterSmc(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(kaidb.NewMemStore()))
	address := common.HexToAddress("0x0a")

	// Add runtime_bytecode for counter.sol to execute the smc:
	var code = common.Hex2Bytes("60806040526004361060485763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166324b8ba5f8114604d5780636d4ce63c146067575b600080fd5b348015605857600080fd5b50606560ff60043516608f565b005b348015607257600080fd5b50607960a5565b6040805160ff9092168252519081900360200190f35b6000805460ff191660ff92909216919091179055565b60005460ff16905600a165627a7a723058206cc1a54f543612d04d3f16b0bbb49e9ded9ccf6d47f7789fe3577260346ed44d0029")
	state.SetCode(address, code)
	var definition = `[
		{"constant":false,"inputs":[{"name":"x","type":"uint8"}],"name":"set","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},
		{"constant":true,"inputs":[],"name":"get","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"}
	]`

	abi, err := abi.JSON(strings.NewReader(definition))
	if err != nil {
		t.Fatal(err)
	}

	// Sets counter to 5
	set, err := abi.Pack("set", uint8(5))
	if err != nil {
		t.Fatal(err)
	}
	_, _, err = Call(address, set, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}

	// Gets counter and verifies it is 5
	get, err := abi.Pack("get")
	if err != nil {
		t.Fatal(err)
	}
	result, _, err := Call(address, get, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}
	num := new(big.Int).SetBytes(result)
	if num.Cmp(big.NewInt(5)) != 0 {
		t.Error("Expected 5, got", num)
	}
}

func TestChangeBalance(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(kaidb.NewMemStore()))
	var address = common.HexToAddress("0x0b")
	state.CreateAccount(address)
	state.AddBalance(address, big.NewInt(500))

	var balance = state.GetBalance(address)
	if balance.Cmp(big.NewInt(500)) != 0 {
		t.Error("error setting balance, expect 500, got", balance)
	}

	state.SubBalance(address, big.NewInt(100))
	balance = state.GetBalance(address)
	if balance.Cmp(big.NewInt(400)) != 0 {
		t.Error("error subtract balance, expect 400, got", balance)
	}
}

func TestCallSmcDeductBalance(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(kaidb.NewMemStore()))
	var sender = common.HexToAddress("0x0b")
	state.CreateAccount(sender)
	state.AddBalance(sender, big.NewInt(500))

	address := common.HexToAddress("0x0a")

	state.SetCode(address, []byte{
		byte(kvm.PUSH1), 10,
		byte(kvm.PUSH1), 0,
		byte(kvm.MSTORE),
		byte(kvm.PUSH1), 32,
		byte(kvm.PUSH1), 0,
		byte(kvm.RETURN),
	})
	ret, _, err := Call(address, nil, &Config{State: state, Origin: sender, Value: big.NewInt(50)})
	if err != nil {
		t.Fatal("didn't expect error", err)
	}

	num := new(big.Int).SetBytes(ret)
	if num.Cmp(big.NewInt(10)) != 0 {
		t.Error("Expected 10, got", num)
	}
	var sender_balance = state.GetBalance(sender)
	if sender_balance.Cmp(big.NewInt(450)) != 0 {
		t.Error("Invalid remaining balance, expect 450, got", sender_balance)
	}
	var contract_balance = state.GetBalance(address)
	if contract_balance.Cmp(big.NewInt(50)) != 0 {
		t.Error("Invalid contract balance, expect 50, got", contract_balance)
	}
}

// Simple voting smart contract to be used for below tests:
/*
- ballot.sol:
	pragma solidity ^0.4.0;
	contract Ballot {

		struct Voter {
			bool voted;
			uint8 vote;
		}
		struct Proposal {
			uint voteCount;
		}

		mapping(address => Voter) voters;
		Proposal[4] proposals;

		/// Give a single vote to proposal $(toProposal).
		function vote(uint8 toProposal) public {
			Voter storage sender = voters[msg.sender];
			if (sender.voted || toProposal >= proposals.length) return;
			sender.voted = true;
			sender.vote = toProposal;
			proposals[toProposal].voteCount += 1;
		}

		function getVote(uint8 toProposal) public view returns (uint) {
			if (toProposal >= proposals.length) return 0;
			return proposals[toProposal].voteCount;
		}

		function winningProposal() public view returns (uint8 _winningProposal) {
			uint256 winningVoteCount = 0;
			for (uint8 prop = 0; prop < proposals.length; prop++)
				if (proposals[prop].voteCount > winningVoteCount) {
					winningVoteCount = proposals[prop].voteCount;
					_winningProposal = prop;
				}
		}
	}

- compiler: remix: 0.4.24+commit.e67f0147.Emscripten.clang
*/

// Test executing the voting smart contract on KVM
// Note: Call uses the runtime_bytecode from the compiler, unlike the raw bytecode as in the previous unit test
func TestExecuteVoteSmc(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(kaidb.NewMemStore()))
	address := common.HexToAddress("0x0a")

	// Add runtime_bytecode for ballot.sol to execute the smc:
	var code = common.Hex2Bytes("608060405260043610610057576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063124474a71461005c578063609ff1bd146100a0578063b3f98adc146100d1575b600080fd5b34801561006857600080fd5b5061008a600480360381019080803560ff169060200190929190505050610101565b6040518082815260200191505060405180910390f35b3480156100ac57600080fd5b506100b5610138565b604051808260ff1660ff16815260200191505060405180910390f35b3480156100dd57600080fd5b506100ff600480360381019080803560ff16906020019092919050505061019e565b005b600060048260ff161015156101195760009050610133565b60018260ff1660048110151561012b57fe5b016000015490505b919050565b6000806000809150600090505b60048160ff161015610199578160018260ff1660048110151561016457fe5b0160000154111561018c5760018160ff1660048110151561018157fe5b016000015491508092505b8080600101915050610145565b505090565b60008060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002090508060000160009054906101000a900460ff1680610201575060048260ff1610155b1561020b5761026a565b60018160000160006101000a81548160ff021916908315150217905550818160000160016101000a81548160ff021916908360ff1602179055506001808360ff1660048110151561025857fe5b01600001600082825401925050819055505b50505600a165627a7a72305820c93a970449b32fe53b59e0ed7cfeda5d52acafd2d1bdd3f2f67093f076acf1c60029")
	state.SetCode(address, code)
	var definition = `[
	{
		"constant": true,
		"inputs": [
			{
				"name": "toProposal",
				"type": "uint8"
			}
		],
		"name": "getVote",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "winningProposal",
		"outputs": [
			{
				"name": "_winningProposal",
				"type": "uint8"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "toProposal",
				"type": "uint8"
			}
		],
		"name": "vote",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	}
]`

	abi, err := abi.JSON(strings.NewReader(definition))
	if err != nil {
		t.Fatal(err)
	}

	//get init winning proposal
	get, err := abi.Pack("winningProposal")
	if err != nil {
		t.Fatal(err)
	}
	result, _, err := Call(address, get, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}
	num := new(big.Int).SetBytes(result)
	if num.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expected 0, got", num)
	}
	vote, err := abi.Pack("vote", uint8(1))
	if err != nil {
		t.Fatal(err)
	}
	result, _, err = Call(address, vote, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}

	result, _, err = Call(address, get, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}
	num = new(big.Int).SetBytes(result)
	if num.Cmp(big.NewInt(1)) != 0 {
		t.Error("Expected 1, got", num)
	}
}

// Test executing the voting smart contract on KVM using different senders
// Note: Call uses the runtime_bytecode from the compiler, unlike the raw bytecode as in the previous unit test
func TestExecuteVoteSmcMultipleTime(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(kaidb.NewMemStore()))
	address := common.HexToAddress("0x0a")

	// Add runtime_bytecode for ballot.sol to execute the smc:
	var code = common.Hex2Bytes("608060405260043610610057576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063124474a71461005c578063609ff1bd146100a0578063b3f98adc146100d1575b600080fd5b34801561006857600080fd5b5061008a600480360381019080803560ff169060200190929190505050610101565b6040518082815260200191505060405180910390f35b3480156100ac57600080fd5b506100b5610138565b604051808260ff1660ff16815260200191505060405180910390f35b3480156100dd57600080fd5b506100ff600480360381019080803560ff16906020019092919050505061019e565b005b600060048260ff161015156101195760009050610133565b60018260ff1660048110151561012b57fe5b016000015490505b919050565b6000806000809150600090505b60048160ff161015610199578160018260ff1660048110151561016457fe5b0160000154111561018c5760018160ff1660048110151561018157fe5b016000015491508092505b8080600101915050610145565b505090565b60008060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002090508060000160009054906101000a900460ff1680610201575060048260ff1610155b1561020b5761026a565b60018160000160006101000a81548160ff021916908315150217905550818160000160016101000a81548160ff021916908360ff1602179055506001808360ff1660048110151561025857fe5b01600001600082825401925050819055505b50505600a165627a7a72305820c93a970449b32fe53b59e0ed7cfeda5d52acafd2d1bdd3f2f67093f076acf1c60029")
	state.SetCode(address, code)
	var definition = `[
	{
		"constant": true,
		"inputs": [
			{
				"name": "toProposal",
				"type": "uint8"
			}
		],
		"name": "getVote",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "winningProposal",
		"outputs": [
			{
				"name": "_winningProposal",
				"type": "uint8"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "toProposal",
				"type": "uint8"
			}
		],
		"name": "vote",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	}
]`

	abi, err := abi.JSON(strings.NewReader(definition))
	if err != nil {
		t.Fatal(err)
	}

	//get init winning proposal, should be 0
	get, err := abi.Pack("winningProposal")
	if err != nil {
		t.Fatal(err)
	}
	result, _, err := Call(address, get, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}
	num := new(big.Int).SetBytes(result)
	if num.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expected 0, got", num)
	}
	//create first vote for second candidate , should be successful
	vote, err := abi.Pack("vote", uint8(1))
	if err != nil {
		t.Fatal(err)
	}
	var sender1 = common.HexToAddress("0x0b")
	state.CreateAccount(sender1)
	state.AddBalance(sender1, big.NewInt(500))
	result, _, err = Call(address, vote, &Config{State: state, Origin: sender1})
	if err != nil {
		t.Fatal(err)
	}

	// now we get count of second candidate , should be 1
	getProposal, err := abi.Pack("getVote", uint8(1))
	if err != nil {
		t.Fatal(err)
	}
	result, _, err = Call(address, getProposal, &Config{State: state, Origin: sender1})

	num = new(big.Int).SetBytes(result)
	if num.Cmp(big.NewInt(1)) != 0 {
		t.Error("Expected 1, got", num)
	}
	//create duplicate vote for 2nd candidate , should be no error
	vote, err = abi.Pack("vote", uint8(1))
	if err != nil {
		t.Fatal(err)
	}
	result, _, err = Call(address, vote, &Config{State: state, Origin: sender1})
	if err != nil {
		t.Fatal(err)
	}

	// now we get vote count of candidate 2th, should be 1 because latter vote was invalid
	getProposal, err = abi.Pack("getVote", uint8(1))
	if err != nil {
		t.Fatal(err)
	}
	result, _, err = Call(address, getProposal, &Config{State: state})

	num = new(big.Int).SetBytes(result)
	if num.Cmp(big.NewInt(1)) != 0 {
		t.Error("Expected 1, got", num)
	}

	// now we create 2 another accounts to vote for 3rd candidate
	var sender2 = common.HexToAddress("0x0c")
	state.CreateAccount(sender2)
	state.AddBalance(sender2, big.NewInt(500))
	var sender3 = common.HexToAddress("0x0d")
	state.CreateAccount(sender3)
	state.AddBalance(sender3, big.NewInt(500))
	vote, err = abi.Pack("vote", uint8(2))
	result, _, err = Call(address, vote, &Config{State: state, Origin: sender2})
	if err != nil {
		t.Fatal(err)
	}
	result, _, err = Call(address, vote, &Config{State: state, Origin: sender3})
	if err != nil {
		t.Fatal(err)
	}
	// now we get the winning candidate, it shoud be 3rd candidate
	result, _, err = Call(address, get, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}
	num = new(big.Int).SetBytes(result)
	if num.Cmp(big.NewInt(2)) != 0 {
		t.Error("Expected 2, got", num)
	}
	// get num of vote of 3rd candidate, should be 2 votes
	getProposal, err = abi.Pack("getVote", uint8(2))
	if err != nil {
		t.Fatal(err)
	}
	result, _, err = Call(address, getProposal, &Config{State: state})

	num = new(big.Int).SetBytes(result)
	if num.Cmp(big.NewInt(2)) != 0 {
		t.Error("Expected 2, got", num)
	}
}

// Test behaviour of master exchange contract to exchange ETH <-> NEO
// Please find solidity source code in smc/Exchange.sol
func TestExecuteMasterExchangeContract(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(kaidb.NewMemStore()))
	address := common.HexToAddress("0x0a")

	// Add runtime_bytecode for Exchange.sol to execute the smc:
	var code = common.Hex2Bytes("6080604052600436106100775763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416630a0306b1811461007c578063323a9243146100a357806344af18e8146100bd5780636e63987d146100d557806386dca334146100ed578063fa8513de14610105575b600080fd5b34801561008857600080fd5b5061009161011a565b60408051918252519081900360200190f35b3480156100af57600080fd5b506100bb600435610139565b005b3480156100c957600080fd5b506100bb600435610154565b3480156100e157600080fd5b506100bb60043561016f565b3480156100f957600080fd5b506100bb60043561017a565b34801561011157600080fd5b50610091610185565b600060015460005411156101315750600154610136565b506000545b90565b60015481111561014857600080fd5b60018054919091039055565b60005481111561016357600080fd5b60008054919091039055565b600180549091019055565b600080549091019055565b60008054600154111561019b5750600054610136565b50600154905600a165627a7a72305820f07bf8b0278729f61585fdeb608ea6ab12a34ae7871ea92bfd2f4199cc5bfd0d0029")
	state.SetCode(address, code)
	var definition = `[
						{"constant": false,"inputs": [{"name": "eth","type": "uint256"}],"name": "matchEth","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},
						{"constant": false,"inputs": [{"name": "neo","type": "uint256"}],"name": "matchNeo","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},
						{"constant": false,"inputs": [{"name": "eth","type": "uint256"}],"name": "removeEth","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},
						{"constant": false,"inputs": [{"name": "neo","type": "uint256"}],"name": "removeNeo","outputs": [],"payable": false,"stateMutability": "nonpayable","type": "function"},
						{"constant": true,"inputs": [],"name": "getEthToSend","outputs": [{"name": "","type": "uint256"}],"payable": false,"stateMutability": "view","type": "function"},
						{"constant": true,"inputs": [],"name": "getNeoToSend","outputs": [{"name": "","type": "uint256"}],"payable": false,"stateMutability": "view","type": "function"}
					]`
	abi, err := abi.JSON(strings.NewReader(definition))
	if err != nil {
		t.Fatal(err)
	}

	// Deposit 10 ETH to exchange for 10 NEO
	matchEthInput, err := abi.Pack("matchEth", big.NewInt(10))
	if err != nil {
		t.Fatal(err)
	}
	_, _, err = Call(address, matchEthInput, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}

	// Deposit 5 NEO to exchange for 5 ETH
	matchNeoInput, err := abi.Pack("matchNeo", big.NewInt(5))
	if err != nil {
		t.Fatal(err)
	}
	_, _, err = Call(address, matchNeoInput, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}

	// Get number of matching ETH quantity
	getEthInput, err := abi.Pack("getEthToSend")
	result, _, err := Call(address, getEthInput, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}
	var ethAmount = new(big.Int).SetBytes(result)
	if ethAmount.Cmp(big.NewInt(5)) != 0 {
		t.Error("Expected 5, got", ethAmount)
	}

	// Assume ETH has been release successfully, update the order list
	removeEthInput, err := abi.Pack("removeEth", big.NewInt(5))
	_, _, err = Call(address, removeEthInput, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}

	removeNeoInput, err := abi.Pack("removeNeo", big.NewInt(5))
	_, _, err = Call(address, removeNeoInput, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}

	// Get number of matching ETH quantity again, it should be 0 because no more NEO order is match
	getEthInput, err = abi.Pack("getEthToSend")
	result, _, err = Call(address, getEthInput, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}
	ethAmount = new(big.Int).SetBytes(result)
	if ethAmount.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expected 0, got", ethAmount)
	}
}

// Test call a contract from inside another contract
// The source code of 2 contracts are in smc/intersmc.
// Contract A is callee, B is caller
func TestExecuteInterContract(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(kaidb.NewMemStore()))
	addressA := common.HexToAddress("0x0a")
	addressB := common.HexToAddress("0x0b")
	// Add runtime_bytecode
	// Contract B
	var codeA = common.Hex2Bytes("60806040526004361060485763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166373d4a13a8114604d578063da358a3c146071575b600080fd5b348015605857600080fd5b50605f6088565b60408051918252519081900360200190f35b348015607c57600080fd5b506086600435608e565b005b60005481565b6000555600a165627a7a72305820408349f58cb50ba37a5c1f89b5c4dacc1077449c09ab590360ea2866dcbc0a460029")
	state.SetCode(addressA, codeA)
	var definitionA = `[{"constant":true,"inputs":[],"name":"data","outputs":[{"name":"","type":"int256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_data","type":"int256"}],"name":"setData","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}]`

	abiA, errParseA := abi.JSON(strings.NewReader(definitionA))
	if errParseA != nil {
		t.Fatal(errParseA)
	}
	// Contract B
	var codeB = common.Hex2Bytes("60806040526004361061004b5763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416635adc75af8114610050578063d32fe93414610077575b600080fd5b34801561005c57600080fd5b506100656100aa565b60408051918252519081900360200190f35b34801561008357600080fd5b506100a873ffffffffffffffffffffffffffffffffffffffff600435166024356100b0565b005b60005481565b60008290508073ffffffffffffffffffffffffffffffffffffffff1663da358a3c836040518263ffffffff167c010000000000000000000000000000000000000000000000000000000002815260040180828152602001915050600060405180830381600087803b15801561012457600080fd5b505af1158015610138573d6000803e3d6000fd5b5050506000929092555050505600a165627a7a723058205824e91fcb7a1f7034282bc72a1641ff48abe2e8a99e0ef68c941da88fdc21a30029")
	state.SetCode(addressB, codeB)
	var definitionB = `[{"constant":true,"inputs":[],"name":"datab","outputs":[{"name":"","type":"int256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"aAddr","type":"address"},{"name":"_data","type":"int256"}],"name":"testData","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}]`
	abiB, errParseB := abi.JSON(strings.NewReader(definitionB))
	if errParseB != nil {
		t.Fatal(errParseB)
	}

	// Add default data to A to be 100
	setData, errPackSetData := abiA.Pack("setData", big.NewInt(100))
	if errPackSetData != nil {
		t.Fatal(errPackSetData)
	}
	_, _, errCallSetData := Call(addressA, setData, &Config{State: state})
	if errCallSetData != nil {
		t.Error(errCallSetData)
	}

	getData, errPackGetData := abiA.Pack("data")

	if errPackGetData != nil {
		t.Fatal(errPackGetData)
	}

	rgetData, _, errCallGetData := Call(addressA, getData, &Config{State: state})
	if errCallSetData != nil {
		t.Error(errCallGetData)
	}

	getValue := new(big.Int).SetBytes(rgetData)
	// Check value of A to check whether it's 100
	if getValue.Cmp(big.NewInt(100)) != 0 {
		t.Error("Error get value, expected 100 got ", getValue)
	}

	// Try to test set Data to A from B, data is set to be 10
	testData, errTestData := abiB.Pack("testData", addressA, big.NewInt(10))
	if errTestData != nil {
		t.Fatal(errTestData)
	}

	_, _, errCallTestData := Call(addressB, testData, &Config{State: state})

	if errCallTestData != nil {
		t.Fatal(errCallTestData)
	}
	// Now we call getData from A again, to check whether it's set to 10
	rgetData2, _, errCallGetData := Call(addressA, getData, &Config{State: state})

	getValue = new(big.Int).SetBytes(rgetData2)
	if errCallGetData != nil {
		t.Fatal(errCallGetData)
	}
	// Data should be 10 after be set from B
	if getValue.Cmp(big.NewInt(10)) != 0 {
		t.Error("Error get value, expected 100 got ", getValue)
	}
}

// This test contains all the test cases for interfaces of the new exchange contract
// Please find the solidity source code at go-kardia/kvm/smc/NewExchange.sol
func TestNewExchangeContract(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(kaidb.NewMemStore()))

	address := common.HexToAddress("0x0a")

	//var code = common.Hex2Bytes("608060405260043610610083576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680632c72bd87146100885780634d78b88e146101055780637fb06000146101b95780638e4a24041461023d578063ab2cb4f9146102ba578063c21d485814610341578063f2b57a28146104c7575b600080fd5b34801561009457600080fd5b506100ef600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610620565b6040518082815260200191505060405180910390f35b34801561011157600080fd5b5061013060048036038101908080359060200190929190505050610771565b6040518084815260200180602001838152602001828103825284818151815260200191508051906020019080838360005b8381101561017c578082015181840152602081019050610161565b50505050905090810190601f1680156101a95780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b3480156101c557600080fd5b50610220600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610a25565b604051808381526020018281526020019250505060405180910390f35b34801561024957600080fd5b506102b8600480360381019080803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192908035906020019092919080359060200190929190505050610b0f565b005b3480156102c657600080fd5b5061032b60048036038101908080359060200190929190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610bab565b6040518082815260200191505060405180910390f35b34801561034d57600080fd5b5061043e600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001909291905050506110bf565b6040518084815260200180602001838152602001828103825284818151815260200191508051906020019080838360005b8381101561048a57808201518184015260208101905061046f565b50505050905090810190601f1680156104b75780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b3480156104d357600080fd5b5061060a600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001909291905050506113ba565b6040518082815260200191505060405180910390f35b6000606060008092506001846040518082805190602001908083835b602083101515610661578051825260208201915060208101905060208303925061063c565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390208054806020026020016040519081016040528092919081815260200182805480156106de57602002820191906000526020600020905b8154815260200190600101908083116106ca575b50505050509150600090505b8151811015610767576000806000848481518110151561070657fe5b90602001906020020151815260200190815260200160002060050154141561075a57600080838381518110151561073957fe5b90602001906020020151815260200190815260200160002060040154830192505b80806001019150506106ea565b8292505050919050565b60006060600080610780612457565b60008087815260200190815260200160002060050154915060008214156107c757600080819150602060405190810160405280600081525090809050945094509450610a1c565b60008083815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561087e5780601f106108535761010080835404028352916020019161087e565b820191906000526020600020905b81548152906001019060200180831161086157829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109205780601f106108f557610100808354040283529160200191610920565b820191906000526020600020905b81548152906001019060200180831161090357829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109c25780601f10610997576101008083540402835291602001916109c2565b820191906000526020600020905b8154815290600101906020018083116109a557829003601f168201915b50505050508152602001600382015481526020016004820154815260200160058201548152602001600682015481525050905060008160c001511415610a1b578181604001518260800151819150945094509450610a1c565b5b50509193909250565b6000806002836040518082805190602001908083835b602083101515610a605780518252602082019150602081019050602083039250610a3b565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600001546002846040518082805190602001908083835b602083101515610acf5780518252602082019150602081019050602083039250610aaa565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206001015491509150915091565b6040805190810160405280838152602001828152506002846040518082805190602001908083835b602083101515610b5c5780518252602082019150602081019050602083039250610b37565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206000820151816000015560208201518160010155905050505050565b6000610bb5612457565b600080600086815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610c6e5780601f10610c4357610100808354040283529160200191610c6e565b820191906000526020600020905b815481529060010190602001808311610c5157829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610d105780601f10610ce557610100808354040283529160200191610d10565b820191906000526020600020905b815481529060010190602001808311610cf357829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610db25780601f10610d8757610100808354040283529160200191610db2565b820191906000526020600020905b815481529060010190602001808311610d9557829003601f168201915b505050505081526020016003820154815260200160048201548152602001600582015481526020016006820154815250509150836040516020018082805190602001908083835b602083101515610e1e5780518252602082019150602081019050602083039250610df9565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083101515610e875780518252602082019150602081019050602083039250610e62565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191682600001516040516020018082805190602001908083835b602083101515610ef55780518252602082019150602081019050602083039250610ed0565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083101515610f5e5780518252602082019150602081019050602083039250610f39565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916141515610f9f57600092506110b7565b600080600087815260200190815260200160002060060154141515610fc757600092506110b7565b6001600080878152602001908152602001600020600601819055506000808681526020019081526020016000206005015490506110b285826000808981526020019081526020016000206000018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156110a85780601f1061107d576101008083540402835291602001916110a8565b820191906000526020600020905b81548152906001019060200180831161108b57829003601f168201915b50505050506115c7565b600192505b505092915050565b6000606060008060006110d0612457565b6110dc8a8a8a8a611970565b9250600083141561110d576000808191506020604051908101604052806000815250908090509550955095506113ad565b60008060008581526020019081526020016000206005015414151561138b5760008084815260200190815260200160002060050154915060008083815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156111fb5780601f106111d0576101008083540402835291602001916111fb565b820191906000526020600020905b8154815290600101906020018083116111de57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561129d5780601f106112725761010080835404028352916020019161129d565b820191906000526020600020905b81548152906001019060200180831161128057829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561133f5780601f106113145761010080835404028352916020019161133f565b820191906000526020600020905b81548152906001019060200180831161132257829003601f168201915b50505050508152602001600382015481526020016004820154815260200160058201548152602001600682015481525050905081816040015182608001518191509550955095506113ad565b6000808191506020604051908101604052806000815250908090509550955095505b5050509450945094915050565b60006113c4612495565b6000806113cf612457565b6113d88a61203b565b93506000846020015114806113f1575060008460000151145b156113ff57600094506115ba565b6003600081546001019190508190555083600001518460200151870281151561142457fe5b04925061143189846120d4565b915060e0604051908101604052808b815260200189815260200188815260200187815260200184815260200183815260200160008152509050806000806003548152602001908152602001600020600082015181600001908051906020019061149b9291906124af565b5060208201518160010190805190602001906114b89291906124af565b5060408201518160020190805190602001906114d59291906124af565b50606082015181600301556080820151816004015560a0820151816005015560c0820151816006015590505060018a6040518082805190602001908083835b6020831015156115395780518252602082019150602081019050602083039250611514565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060035490806001815401808255809150509060018203906000526020600020016000909192909190915055506003546000808481526020019081526020016000206005018190555060035494505b5050505095945050505050565b60606000806001846040518082805190602001908083835b60208310151561160457805182526020820191506020810190506020830392506115df565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902080548060200260200160405190810160405280929190818152602001828054801561168157602002820191906000526020600020905b81548152602001906001019080831161166d575b5050505050925082519150600090505b82518110156116ca578583828151811015156116a957fe5b9060200190602002015114156116bd578091505b8080600101915050611691565b825182101561185e576001846040518082805190602001908083835b60208310151561170b57805182526020820191506020810190506020830392506116e6565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600184510381548110151561174f57fe5b90600052602060002001546001856040518082805190602001908083835b602083101515611792578051825260208201915060208101905060208303925061176d565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020838154811015156117d257fe5b9060005260206000205050506001846040518082805190602001908083835b60208310151561181657805182526020820191506020810190506020830392506117f1565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902080548091906001900361185c919061252f565b505b6001600080888152602001908152602001600020600601541480156118985750600160008087815260200190815260200160002060060154145b1561196857600080878152602001908152602001600020600080820160006118c0919061255b565b6001820160006118d0919061255b565b6002820160006118e0919061255b565b6003820160009055600482016000905560058201600090556006820160009055505060008086815260200190815260200160002060008082016000611925919061255b565b600182016000611935919061255b565b600282016000611945919061255b565b600382016000905560048201600090556005820160009055600682016000905550505b505050505050565b60006060600061197e612457565b6001886040518082805190602001908083835b6020831015156119b65780518252602082019150602081019050602083039250611991565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020805480602002602001604051908101604052809291908181526020018280548015611a3357602002820191906000526020600020905b815481526020019060010190808311611a1f575b50505050509250600091505b825182101561202b576000808484815181101515611a5957fe5b90602001906020020151815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611b165780601f10611aeb57610100808354040283529160200191611b16565b820191906000526020600020905b815481529060010190602001808311611af957829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611bb85780601f10611b8d57610100808354040283529160200191611bb8565b820191906000526020600020905b815481529060010190602001808311611b9b57829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611c5a5780601f10611c2f57610100808354040283529160200191611c5a565b820191906000526020600020905b815481529060010190602001808311611c3d57829003601f168201915b505050505081526020016003820154815260200160048201548152602001600582015481526020016006820154815250509050866040516020018082805190602001908083835b602083101515611cc65780518252602082019150602081019050602083039250611ca1565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083101515611d2f5780518252602082019150602081019050602083039250611d0a565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191681602001516040516020018082805190602001908083835b602083101515611d9d5780518252602082019150602081019050602083039250611d78565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083101515611e065780518252602082019150602081019050602083039250611de1565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916148015611feb5750856040516020018082805190602001908083835b602083101515611e785780518252602082019150602081019050602083039250611e53565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083101515611ee15780518252602082019150602081019050602083039250611ebc565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191681604001516040516020018082805190602001908083835b602083101515611f4f5780518252602082019150602081019050602083039250611f2a565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083101515611fb85780518252602082019150602081019050602083039250611f93565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916145b8015611ffa5750848160600151145b1561201e57828281518110151561200d57fe5b906020019060200201519350612030565b8180600101925050611a3f565b600093505b505050949350505050565b612043612495565b6002826040518082805190602001908083835b60208310151561207b5780518252602082019150602081019050602083039250612056565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020604080519081016040529081600082015481526020016001820154815250509050919050565b6000606060006120e2612457565b6001866040518082805190602001908083835b60208310151561211a57805182526020820191506020810190506020830392506120f5565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902080548060200260200160405190810160405280929190818152602001828054801561219757602002820191906000526020600020905b815481526020019060010190808311612183575b50505050509250600091505b82518210156124495760008084848151811015156121bd57fe5b90602001906020020151815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561227a5780601f1061224f5761010080835404028352916020019161227a565b820191906000526020600020905b81548152906001019060200180831161225d57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561231c5780601f106122f15761010080835404028352916020019161231c565b820191906000526020600020905b8154815290600101906020018083116122ff57829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156123be5780601f10612393576101008083540402835291602001916123be565b820191906000526020600020905b8154815290600101906020018083116123a157829003601f168201915b505050505081526020016003820154815260200160048201548152602001600582015481526020016006820154815250509050848160600151148015612408575060008160a00151145b8015612418575060008160c00151145b1561243c57828281518110151561242b57fe5b90602001906020020151935061244e565b81806001019250506121a3565b600093505b50505092915050565b60e060405190810160405280606081526020016060815260200160608152602001600081526020016000815260200160008152602001600081525090565b604080519081016040528060008152602001600081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106124f057805160ff191683800117855561251e565b8280016001018555821561251e579182015b8281111561251d578251825591602001919060010190612502565b5b50905061252b91906125a3565b5090565b8154818355818111156125565781836000526020600020918201910161255591906125a3565b5b505050565b50805460018160011615610100020316600290046000825580601f1061258157506125a0565b601f01602090049060005260206000209081019061259f91906125a3565b5b50565b6125c591905b808211156125c15760008160009055506001016125a9565b5090565b905600a165627a7a72305820b1ed50527ab39b9832c1ff7d210d0926bf563984470592e5139eecc9b68dc2f40029")
	var code = common.Hex2Bytes("60806040526004361061008e576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680632c72bd871461009357806342e11635146101105780634d78b88e146101ce5780637fb06000146102825780638e4a240414610306578063ab2cb4f914610383578063b41f6a7a1461040a578063f2b57a28146105d6575b600080fd5b34801561009f57600080fd5b506100fa600480360381019080803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929050505061072f565b6040518082815260200191505060405180910390f35b34801561011c57600080fd5b50610177600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610880565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b838110156101ba57808201518184015260208101905061019f565b505050509050019250505060405180910390f35b3480156101da57600080fd5b506101f9600480360381019080803590602001909291905050506109ec565b6040518084815260200180602001838152602001828103825284818151815260200191508051906020019080838360005b8381101561024557808201518184015260208101905061022a565b50505050905090810190601f1680156102725780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b34801561028e57600080fd5b506102e9600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610ca0565b604051808381526020018281526020019250505060405180910390f35b34801561031257600080fd5b50610381600480360381019080803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192908035906020019092919080359060200190929190505050610d8a565b005b34801561038f57600080fd5b506103f460048036038101908080359060200190929190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610e26565b6040518082815260200191505060405180910390f35b34801561041657600080fd5b5061054d600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192908035906020019092919050505061133a565b6040518084815260200180602001838152602001828103825284818151815260200191508051906020019080838360005b8381101561059957808201518184015260208101905061057e565b50505050905090810190601f1680156105c65780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b3480156105e257600080fd5b50610719600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001909291905050506118dc565b6040518082815260200191505060405180910390f35b6000606060008092506001846040518082805190602001908083835b602083101515610770578051825260208201915060208101905060208303925061074b565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390208054806020026020016040519081016040528092919081815260200182805480156107ed57602002820191906000526020600020905b8154815260200190600101908083116107d9575b50505050509150600090505b8151811015610876576000806000848481518110151561081557fe5b90602001906020020151815260200190815260200160002060050154141561086957600080838381518110151561084857fe5b90602001906020020151815260200190815260200160002060040154830192505b80806001019150506107f9565b8292505050919050565b60608060006001846040518082805190602001908083835b6020831015156108bd5780518252602082019150602081019050602083039250610898565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902080548060200260200160405190810160405280929190818152602001828054801561093a57602002820191906000526020600020905b815481526020019060010190808311610926575b50505050509150600a6040519080825280602002602001820160405280156109715781602001602082028038833980820191505090505b509250600090505b81518110156109e257600a8110156109d557600080838381518110151561099c57fe5b9060200190602002015181526020019081526020016000206004015483828151811015156109c657fe5b90602001906020020181815250505b8080600101915050610979565b8292505050919050565b600060606000806109fb612ab8565b6000808781526020019081526020016000206005015491506000821415610a4257600080819150602060405190810160405280600081525090809050945094509450610c97565b60008083815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610af95780601f10610ace57610100808354040283529160200191610af9565b820191906000526020600020905b815481529060010190602001808311610adc57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610b9b5780601f10610b7057610100808354040283529160200191610b9b565b820191906000526020600020905b815481529060010190602001808311610b7e57829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610c3d5780601f10610c1257610100808354040283529160200191610c3d565b820191906000526020600020905b815481529060010190602001808311610c2057829003601f168201915b50505050508152602001600382015481526020016004820154815260200160058201548152602001600682015481525050905060008160c001511415610c96578181604001518260800151819150945094509450610c97565b5b50509193909250565b6000806002836040518082805190602001908083835b602083101515610cdb5780518252602082019150602081019050602083039250610cb6565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600001546002846040518082805190602001908083835b602083101515610d4a5780518252602082019150602081019050602083039250610d25565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206001015491509150915091565b6040805190810160405280838152602001828152506002846040518082805190602001908083835b602083101515610dd75780518252602082019150602081019050602083039250610db2565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206000820151816000015560208201518160010155905050505050565b6000610e30612ab8565b600080600086815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610ee95780601f10610ebe57610100808354040283529160200191610ee9565b820191906000526020600020905b815481529060010190602001808311610ecc57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610f8b5780601f10610f6057610100808354040283529160200191610f8b565b820191906000526020600020905b815481529060010190602001808311610f6e57829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561102d5780601f106110025761010080835404028352916020019161102d565b820191906000526020600020905b81548152906001019060200180831161101057829003601f168201915b505050505081526020016003820154815260200160048201548152602001600582015481526020016006820154815250509150836040516020018082805190602001908083835b6020831015156110995780518252602082019150602081019050602083039250611074565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b60208310151561110257805182526020820191506020810190506020830392506110dd565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191682600001516040516020018082805190602001908083835b602083101515611170578051825260208201915060208101905060208303925061114b565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b6020831015156111d957805182526020820191506020810190506020830392506111b4565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191614151561121a5760009250611332565b6000806000878152602001908152602001600020600601541415156112425760009250611332565b60016000808781526020019081526020016000206006018190555060008086815260200190815260200160002060050154905061132d85826000808981526020019081526020016000206000018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156113235780601f106112f857610100808354040283529160200191611323565b820191906000526020600020905b81548152906001019060200180831161130657829003601f168201915b5050505050611c28565b600192505b505092915050565b60006060600080600061134b612ab8565b6113578b8a8a8a611fd1565b92506000831415611388576000808191506020604051908101604052806000815250908090509550955095506118ce565b60008084815260200190815260200160002060000160405160200180828054600181600116156101000203166002900480156113fb5780601f106113d95761010080835404028352918201916113fb565b820191906000526020600020905b8154815290600101906020018083116113e7575b50509150506040516020818303038152906040526040518082805190602001908083835b602083101515611444578051825260208201915060208101905060208303925061141f565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040518091039020600019168a6040516020018082805190602001908083835b6020831015156114ae5780518252602082019150602081019050602083039250611489565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b60208310151561151757805182526020820191506020810190506020830392506114f2565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191614801561156b575060008060008581526020019081526020016000206005015414155b15611643578260008085815260200190815260200160002060020160008086815260200190815260200160002060040154818054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116315780601f1061160657610100808354040283529160200191611631565b820191906000526020600020905b81548152906001019060200180831161161457829003601f168201915b505050505091509550955095506118ce565b6000808481526020019081526020016000206005015491506000821415156118ac5760008083815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561171c5780601f106116f15761010080835404028352916020019161171c565b820191906000526020600020905b8154815290600101906020018083116116ff57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156117be5780601f10611793576101008083540402835291602001916117be565b820191906000526020600020905b8154815290600101906020018083116117a157829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156118605780601f1061183557610100808354040283529160200191611860565b820191906000526020600020905b81548152906001019060200180831161184357829003601f168201915b50505050508152602001600382015481526020016004820154815260200160058201548152602001600682015481525050905081816040015182608001518191509550955095506118ce565b6000808191506020604051908101604052806000815250908090509550955095505b505050955095509592505050565b60006118e6612af6565b6000806118f1612ab8565b6118fa8a61269c565b9350600084602001511480611913575060008460000151145b156119215760009450611c1b565b6003600081546001019190508190555083600001518460200151870281151561194657fe5b0492506119538984612735565b915060e0604051908101604052808b81526020018981526020018881526020018781526020018481526020018381526020016000815250905080600080600354815260200190815260200160002060008201518160000190805190602001906119bd929190612b10565b5060208201518160010190805190602001906119da929190612b10565b5060408201518160020190805190602001906119f7929190612b10565b50606082015181600301556080820151816004015560a0820151816005015560c0820151816006015590505060018a6040518082805190602001908083835b602083101515611a5b5780518252602082019150602081019050602083039250611a36565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206003549080600181540180825580915050906001820390600052602060002001600090919290919091505550600082141515611c1557600354600080848152602001908152602001600020600501819055506000808381526020019081526020016000206002016040518082805460018160011615610100020316600290048015611b505780601f10611b2e576101008083540402835291820191611b50565b820191906000526020600020905b815481529060010190602001808311611b3c575b50509150506040518091039020896040518082805190602001908083835b602083101515611b935780518252602082019150602081019050602083039250611b6e565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390207f8dc1d65f72533cd068186029d9193e6e49fca64e41f026c18a1317ac6bb0ee898460008087815260200190815260200160002060040154604051808381526020018281526020019250505060405180910390a35b60035494505b5050505095945050505050565b60606000806001846040518082805190602001908083835b602083101515611c655780518252602082019150602081019050602083039250611c40565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020805480602002602001604051908101604052809291908181526020018280548015611ce257602002820191906000526020600020905b815481526020019060010190808311611cce575b5050505050925082519150600090505b8251811015611d2b57858382815181101515611d0a57fe5b906020019060200201511415611d1e578091505b8080600101915050611cf2565b8251821015611ebf576001846040518082805190602001908083835b602083101515611d6c5780518252602082019150602081019050602083039250611d47565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206001845103815481101515611db057fe5b90600052602060002001546001856040518082805190602001908083835b602083101515611df35780518252602082019150602081019050602083039250611dce565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902083815481101515611e3357fe5b9060005260206000205050506001846040518082805190602001908083835b602083101515611e775780518252602082019150602081019050602083039250611e52565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020805480919060019003611ebd9190612b90565b505b600160008088815260200190815260200160002060060154148015611ef95750600160008087815260200190815260200160002060060154145b15611fc95760008087815260200190815260200160002060008082016000611f219190612bbc565b600182016000611f319190612bbc565b600282016000611f419190612bbc565b6003820160009055600482016000905560058201600090556006820160009055505060008086815260200190815260200160002060008082016000611f869190612bbc565b600182016000611f969190612bbc565b600282016000611fa69190612bbc565b600382016000905560048201600090556005820160009055600682016000905550505b505050505050565b600060606000611fdf612ab8565b6001886040518082805190602001908083835b6020831015156120175780518252602082019150602081019050602083039250611ff2565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902080548060200260200160405190810160405280929190818152602001828054801561209457602002820191906000526020600020905b815481526020019060010190808311612080575b50505050509250600091505b825182101561268c5760008084848151811015156120ba57fe5b90602001906020020151815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156121775780601f1061214c57610100808354040283529160200191612177565b820191906000526020600020905b81548152906001019060200180831161215a57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156122195780601f106121ee57610100808354040283529160200191612219565b820191906000526020600020905b8154815290600101906020018083116121fc57829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156122bb5780601f10612290576101008083540402835291602001916122bb565b820191906000526020600020905b81548152906001019060200180831161229e57829003601f168201915b505050505081526020016003820154815260200160048201548152602001600582015481526020016006820154815250509050866040516020018082805190602001908083835b6020831015156123275780518252602082019150602081019050602083039250612302565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083101515612390578051825260208201915060208101905060208303925061236b565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191681602001516040516020018082805190602001908083835b6020831015156123fe57805182526020820191506020810190506020830392506123d9565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b6020831015156124675780518252602082019150602081019050602083039250612442565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191614801561264c5750856040516020018082805190602001908083835b6020831015156124d957805182526020820191506020810190506020830392506124b4565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083101515612542578051825260208201915060208101905060208303925061251d565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191681604001516040516020018082805190602001908083835b6020831015156125b0578051825260208201915060208101905060208303925061258b565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b60208310151561261957805182526020820191506020810190506020830392506125f4565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916145b801561265b5750848160600151145b1561267f57828281518110151561266e57fe5b906020019060200201519350612691565b81806001019250506120a0565b600093505b505050949350505050565b6126a4612af6565b6002826040518082805190602001908083835b6020831015156126dc57805182526020820191506020810190506020830392506126b7565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020604080519081016040529081600082015481526020016001820154815250509050919050565b600060606000612743612ab8565b6001866040518082805190602001908083835b60208310151561277b5780518252602082019150602081019050602083039250612756565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390208054806020026020016040519081016040528092919081815260200182805480156127f857602002820191906000526020600020905b8154815260200190600101908083116127e4575b50505050509250600091505b8251821015612aaa57600080848481518110151561281e57fe5b90602001906020020151815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156128db5780601f106128b0576101008083540402835291602001916128db565b820191906000526020600020905b8154815290600101906020018083116128be57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561297d5780601f106129525761010080835404028352916020019161297d565b820191906000526020600020905b81548152906001019060200180831161296057829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015612a1f5780601f106129f457610100808354040283529160200191612a1f565b820191906000526020600020905b815481529060010190602001808311612a0257829003601f168201915b505050505081526020016003820154815260200160048201548152602001600582015481526020016006820154815250509050848160600151148015612a69575060008160a00151145b8015612a79575060008160c00151145b15612a9d578282815181101515612a8c57fe5b906020019060200201519350612aaf565b8180600101925050612804565b600093505b50505092915050565b60e060405190810160405280606081526020016060815260200160608152602001600081526020016000815260200160008152602001600081525090565b604080519081016040528060008152602001600081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10612b5157805160ff1916838001178555612b7f565b82800160010185558215612b7f579182015b82811115612b7e578251825591602001919060010190612b63565b5b509050612b8c9190612c04565b5090565b815481835581811115612bb757818360005260206000209182019101612bb69190612c04565b5b505050565b50805460018160011615610100020316600290046000825580601f10612be25750612c01565b601f016020900490600052602060002090810190612c009190612c04565b5b50565b612c2691905b80821115612c22576000816000905550600101612c0a565b5090565b905600a165627a7a72305820e867f86f93f232f65d5ca5618d0cea5847f4baf6529cec193670cd48efd5e4f50029")
	state.SetCode(address, code)
	var definition = `[
	{
		"constant": true,
		"inputs": [
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "getAvailableAmountByPair",
		"outputs": [
			{
				"name": "amount",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "getMatchableAmount",
		"outputs": [
			{
				"name": "amounts",
				"type": "uint256[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "requestID",
				"type": "uint256"
			}
		],
		"name": "getUncompletedMatchingRequest",
		"outputs": [
			{
				"name": "matchedRequestID",
				"type": "uint256"
			},
			{
				"name": "destAddress",
				"type": "string"
			},
			{
				"name": "sendAmount",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "getRatePublic",
		"outputs": [
			{
				"name": "sale",
				"type": "uint256"
			},
			{
				"name": "receive",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "pair",
				"type": "string"
			},
			{
				"name": "sale_amount",
				"type": "uint256"
			},
			{
				"name": "receiveAmount",
				"type": "uint256"
			}
		],
		"name": "addRate",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "requestID",
				"type": "uint256"
			},
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "completeRequest",
		"outputs": [
			{
				"name": "success",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "sourcePair",
				"type": "string"
			},
			{
				"name": "interestedPair",
				"type": "string"
			},
			{
				"name": "fromAddress",
				"type": "string"
			},
			{
				"name": "toAddress",
				"type": "string"
			},
			{
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "getMatchingRequestInfo",
		"outputs": [
			{
				"name": "matchedRequestID",
				"type": "uint256"
			},
			{
				"name": "destAddress",
				"type": "string"
			},
			{
				"name": "sendAmount",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "srcPair",
				"type": "string"
			},
			{
				"name": "destPair",
				"type": "string"
			},
			{
				"name": "srcAddress",
				"type": "string"
			},
			{
				"name": "destAddress",
				"type": "string"
			},
			{
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "matchRequest",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"name": "pair",
				"type": "string"
			},
			{
				"indexed": true,
				"name": "addr",
				"type": "string"
			},
			{
				"indexed": false,
				"name": "matchRequestId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"name": "_value",
				"type": "uint256"
			}
		],
		"name": "Release",
		"type": "event"
	}
]`
	abi, err := abi.JSON(strings.NewReader(definition))
	var gas uint64

	if err != nil {
		t.Fatal(err)
	}

	// Try to get non-set rate
	getRateInput, e1 := abi.Pack("getRatePublic", "ETH-NEO")
	if e1 != nil {
		t.Fatal(e1)
	}
	rateResult, _, errCallRate := Call(address, getRateInput, &Config{State: state})

	if errCallRate != nil {
		t.Fatal(errCallRate)
	}
	var rateStruct struct {
		Sale    *big.Int `abi:"sale"`
		Receive *big.Int `abi:"receive"`
	}
	err = abi.Unpack(&rateStruct, "getRatePublic", rateResult)
	if err != nil {
		t.Fatal(err)
	}
	if rateStruct.Sale.Cmp(big.NewInt(0)) != 0 || rateStruct.Receive.Cmp(big.NewInt(0)) != 0 {
		t.Error("Error get value, expected 0, 0 got ", rateStruct.Sale.String(), rateStruct.Receive.String())
	}

	// Now we add rate for ETH-NEO first
	setRateInput, e2 := abi.Pack("addRate", "ETH-NEO", big.NewInt(1), big.NewInt(10))
	if e2 != nil {
		t.Fatal(e2)
	}
	_, _, e3 := Call(address, setRateInput, &Config{State: state})
	if e3 != nil {
		t.Fatal(e3)
	}
	var decodeInput struct {
		Pair          string
		Sale_amount   *big.Int
		ReceiveAmount *big.Int
	}
	e := abi.UnpackInput(&decodeInput, "addRate", setRateInput[4:])
	if e != nil {
		t.Fatal(e)
	}
	rateResult, _, errCallRate = Call(address, getRateInput, &Config{State: state})

	if errCallRate != nil {
		t.Fatal(errCallRate)
	}

	// Call get rate for ETH-NEO again to check if we set it correctly
	err = abi.Unpack(&rateStruct, "getRatePublic", rateResult)
	if err != nil {
		t.Fatal(err)
	}
	if rateStruct.Sale.Cmp(big.NewInt(1)) != 0 || rateStruct.Receive.Cmp(big.NewInt(10)) != 0 {
		t.Error("Error get value, expected 1, 10 got ", rateStruct.Sale.String(), rateStruct.Receive.String())
	}

	// Now we add rate for NEO-ETH to start matching orders
	setRateInput2, e2 := abi.Pack("addRate", "NEO-ETH", big.NewInt(10), big.NewInt(1))
	if e2 != nil {
		t.Fatal(e2)
	}
	_, gas, e3 = Call(address, setRateInput2, &Config{State: state})
	if e3 != nil {
		t.Fatal(e3)
	}

	// Find available amount for NEO-ETH now, should be 0
	getAvailableInput, _ := abi.Pack("getAvailableAmountByPair", "NEO-ETH")
	availableResult, _, err := Call(address, getAvailableInput, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}

	if big.NewInt(0).SetBytes(availableResult).Cmp(big.NewInt(0)) != 0 {
		t.Fatal("Expect available input is 0, got", big.NewInt(0).SetBytes(availableResult).String())
	}
	// Get rate for NEO-ETH
	getRateInput2, e4 := abi.Pack("getRatePublic", "NEO-ETH")
	if e4 != nil {
		t.Fatal(e4)
	}
	rateResult, _, errCallRate = Call(address, getRateInput2, &Config{State: state})
	if errCallRate != nil {
		t.Fatal(errCallRate)
	}

	err = abi.Unpack(&rateStruct, "getRatePublic", rateResult)
	if err != nil {
		t.Fatal(err)
	}

	if rateStruct.Sale.Cmp(big.NewInt(10)) != 0 || rateStruct.Receive.Cmp(big.NewInt(1)) != 0 {
		t.Error("Error get value, expected 10, 1 got ", rateStruct.Sale.String(), rateStruct.Receive.String())
	}

	// Start matching 1 eth for 10 neo
	matchInput1, e5 := abi.Pack("matchRequest", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver1", big.NewInt(1))
	if e5 != nil {
		t.Fatal(e5)
	}
	_, gas, e6 := Call(address, matchInput1, &Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}
	// GetMatching info for recently added order
	getMatchingInput1, e5 := abi.Pack("getMatchingRequestInfo", "ETH-NEO", "ETH-NEO", "ethsender1", "neoReceiver1", big.NewInt(1))
	if e5 != nil {
		t.Fatal(e5)
	}
	matchingResult1, gas, e6 := Call(address, getMatchingInput1, &Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}
	var decodedMatchResult struct {
		MatchedRequestID *big.Int `abi:"matchedRequestID"`
		DestAddress      string   `abi:"destAddress"`
		SendAmount       *big.Int `abi:"sendAmount"`
	}
	unpackErr := abi.Unpack(&decodedMatchResult, "getMatchingRequestInfo", matchingResult1)
	if unpackErr != nil {
		t.Fatal(unpackErr)
	}
	if decodedMatchResult.MatchedRequestID.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expect id 0, got ", decodedMatchResult.MatchedRequestID.String())
	}
	if decodedMatchResult.DestAddress != "" {
		t.Error("Expect address '', got ", decodedMatchResult.DestAddress)
	}
	if decodedMatchResult.SendAmount.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expect send amount 0, got ", decodedMatchResult.SendAmount.String())
	}

	getAvailableInput, _ = abi.Pack("getAvailableAmountByPair", "ETH-NEO")
	availableResult, _, err = Call(address, getAvailableInput, &Config{State: state})
	if err != nil {
		t.Fatal(err)
	}

	if big.NewInt(0).SetBytes(availableResult).Cmp(big.NewInt(10)) != 0 {
		t.Fatal("Expect available input is 10, got", big.NewInt(0).SetBytes(availableResult).String())
	}

	// Match request sell 10 NEO for 1 ETH
	matchInput2, e5 := abi.Pack("matchRequest", "NEO-ETH", "ETH-NEO", "neosender2", "ethReceiver2", big.NewInt(10))
	if e5 != nil {
		t.Fatal(e5)
	}
	_, _, e6 = Call(address, matchInput2, &Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}
	// GetMatching info for 1st added order
	// now should return info of 2nd order
	getMatchingInput1, e5 = abi.Pack("getMatchingRequestInfo", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver1", big.NewInt(1))
	if e5 != nil {
		t.Fatal(e5)
	}
	matchingResult1, _, e6 = Call(address, getMatchingInput1, &Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}

	unpackErr = abi.Unpack(&decodedMatchResult, "getMatchingRequestInfo", matchingResult1)
	if unpackErr != nil {
		t.Fatal(unpackErr)
	}
	if decodedMatchResult.MatchedRequestID.Cmp(big.NewInt(2)) != 0 {
		t.Error("Expect id 2, got ", decodedMatchResult.MatchedRequestID.String())
	}
	if decodedMatchResult.DestAddress != "ethReceiver2" {
		t.Error("Expect address ethReceiver2, got ", decodedMatchResult.DestAddress)
	}
	if decodedMatchResult.SendAmount.Cmp(big.NewInt(1)) != 0 {
		t.Error("Expect send amount 1, got ", decodedMatchResult.SendAmount.String())
	}

	// GetMatching of NEO-ETH matching from NEO side (2nd order)
	// now should return info of 2nd order itself, because it's matched
	getMatchingInput2, e5 := abi.Pack("getMatchingRequestInfo", "NEO-ETH", "NEO-ETH", "neosender2", "ethReceiver2", big.NewInt(10))
	if e5 != nil {
		t.Fatal(e5)
	}
	matchingResult1, _, e6 = Call(address, getMatchingInput2, &Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}

	unpackErr = abi.Unpack(&decodedMatchResult, "getMatchingRequestInfo", matchingResult1)
	if unpackErr != nil {
		t.Fatal(unpackErr)
	}
	if decodedMatchResult.MatchedRequestID.Cmp(big.NewInt(2)) != 0 {
		t.Error("Expect id 2, got ", decodedMatchResult.MatchedRequestID.String())
	}
	if decodedMatchResult.DestAddress != "ethReceiver2" {
		t.Error("Expect address ethReceiver2, got ", decodedMatchResult.DestAddress)
	}
	if decodedMatchResult.SendAmount.Cmp(big.NewInt(1)) != 0 {
		t.Error("Expect send amount 1, got ", decodedMatchResult.SendAmount.String())
	}

	// complete order 1
	completeInput1, e7 := abi.Pack("completeRequest", big.NewInt(1), "ETH-NEO")
	if (e7 != nil) {
		t.Fatal(e7)
	}
	completeResult1, gas, e8 := Call(address, completeInput1, &Config{State: state})
	if (e8 != nil ) {
		t.Fatal(e8)
	}
	if big.NewInt(0).SetBytes(completeResult1).Cmp(big.NewInt(1)) != 0 {
		t.Fatal("Complete order failed")
	}

	// complete order 2
	completeInput1, e7 = abi.Pack("completeRequest", big.NewInt(2), "NEO-ETH")
	if (e7 != nil) {
		t.Fatal(e7)
	}
	completeResult1, gas, e8 = Call(address, completeInput1, &Config{State: state})
	if (e8 != nil ) {
		t.Fatal(e8)
	}
	if big.NewInt(0).SetBytes(completeResult1).Cmp(big.NewInt(1)) != 0 {
		t.Fatal("Complete order failed")
	}

	// Match 2 eth for 20 neo
	matchInput1, e5 = abi.Pack("matchRequest", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver1", big.NewInt(2))
	if e5 != nil {
		t.Fatal(e5)
	}
	_, gas, e6 = Call(address, matchInput1, &Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}
	var matchableAmounts struct {
		Amounts		[]*big.Int	`abi:"amounts"`
	}
	// get matchable amount for NEO, should be 20 NEO
	getMatchAmountsInput, _ := abi.Pack("getMatchableAmount", "ETH-NEO")
	matchAmountsResult, gas, e6 := Call(address, getMatchAmountsInput, &Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}
	err = abi.Unpack(&matchableAmounts, "getMatchableAmount", matchAmountsResult)
	if len(matchableAmounts.Amounts) == 0 {
		t.Fatal("Invalid matchable amount")
	}
	if matchableAmounts.Amounts[0].Cmp(big.NewInt(20)) != 0 {
		t.Error("Expect 1st matchable amount to be 1, got ", matchableAmounts.Amounts[0].String())
	}

	// Match 3 other eth for 30 neo
	matchInput1, e5 = abi.Pack("matchRequest", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver1", big.NewInt(3))
	if e5 != nil {
		t.Fatal(e5)
	}
	_, gas, e6 = Call(address, matchInput1, &Config{State: state})
	if e6 != nil {
		t.Fatal(e6, gas)
	}

	getMatchAmountsInput, _ = abi.Pack("getMatchableAmount", "ETH-NEO")
	matchAmountsResult, gas, e6 = Call(address, getMatchAmountsInput, &Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}
	err = abi.Unpack(&matchableAmounts, "getMatchableAmount", matchAmountsResult)
	if len(matchableAmounts.Amounts) == 0 {
		t.Fatal("Invalid matchable amount")
	}
	if matchableAmounts.Amounts[0].Cmp(big.NewInt(20)) != 0 {
		t.Error("Expect 1st matchable amount to be 20, got ", matchableAmounts.Amounts[0].String())
	}
	if matchableAmounts.Amounts[1].Cmp(big.NewInt(30)) != 0 {
		t.Error("Expect 2nd matchable amount to be 20, got ", matchableAmounts.Amounts[0].String())
	}
	if matchableAmounts.Amounts[2].Cmp(big.NewInt(0)) != 0 {
		t.Error("Expect 3rd matchable amount to be 0, got ", matchableAmounts.Amounts[0].String())
	}
}

func TestExecuteMasterPermissionContract(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(kaidb.NewMemStore()))
	address := common.HexToAddress("0x0a")

	var code= common.Hex2Bytes("60806040526004361061006d576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806302f0697b1461007257806331e51ad414610169578063430ae633146101f0578063813775a31461026d578063fddf283814610390575b600080fd5b34801561007e57600080fd5b50610153600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919080359060200190929190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610417565b6040518082815260200191505060405180910390f35b34801561017557600080fd5b506101da600480360381019080803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929080359060200190929190505050610588565b6040518082815260200191505060405180910390f35b3480156101fc57600080fd5b50610257600480360381019080803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192905050506106bd565b6040518082815260200191505060405180910390f35b34801561027957600080fd5b506102d4600480360381019080803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192905050506107f0565b604051808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200184815260200183815260200180602001828103825283818151815260200191508051906020019080838360005b83811015610352578082015181840152602081019050610337565b50505050905090810190601f16801561037f5780820380516001836020036101000a031916815260200191505b509550505050505060405180910390f35b34801561039c57600080fd5b50610401600480360381019080803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929080359060200190929190505050610ba1565b6040518082815260200191505060405180910390f35b60006001151561042633610dc2565b151514151561043457600080fd5b60a0604051908101604052808673ffffffffffffffffffffffffffffffffffffffff168152602001848152602001858152602001600115158152602001838152506000876040518082805190602001908083835b6020831015156104ad5780518252602082019150602081019050602083039250610488565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550602082015181600101556040820151816002015560608201518160030160006101000a81548160ff0219169083151502179055506080820151816004019080519060200190610577929190612013565b509050506001905095945050505050565b60006105948383610e60565b156105a257600190506106b7565b600015156000846040518082805190602001908083835b6020831015156105de57805182526020820191506020810190506020830392506105b9565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060030160009054906101000a900460ff161515141561063357600090506106b7565b816000846040518082805190602001908083835b60208310151561066c5780518252602082019150602081019050602083039250610647565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206002015414156106b257600190506106b7565b600090505b92915050565b60006106c882610e93565b156106d657600190506107eb565b600015156000836040518082805190602001908083835b60208310151561071257805182526020820191506020810190506020830392506106ed565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060030160009054906101000a900460ff161515141561076757600090506107eb565b600080836040518082805190602001908083835b6020831015156107a0578051825260208201915060208101905060208303925061077b565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206001015414156107e657600090506107eb565b600190505b919050565b60008060006060600061080286610ebe565b9050600a811015610865576108156118a0565b8181518110151561082257fe5b9060200190602002015160646001610838611c9d565b8481518110151561084557fe5b906020019060200201518292508191508090509450945094509450610b99565b600015156000876040518082805190602001908083835b6020831015156108a1578051825260208201915060208101905060208303925061087c565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060030160009054906101000a900460ff161515141561091957600080600082925081915080905060206040519081016040528060008152509450945094509450610b99565b6000866040518082805190602001908083835b602083101515610951578051825260208201915060208101905060208303925061092c565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff166000876040518082805190602001908083835b6020831015156109e057805182526020820191506020810190506020830392506109bb565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600101546000886040518082805190602001908083835b602083101515610a4f5780518252602082019150602081019050602083039250610a2a565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600201546000896040518082805190602001908083835b602083101515610abe5780518252602082019150602081019050602083039250610a99565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600401808054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610b895780601f10610b5e57610100808354040283529160200191610b89565b820191906000526020600020905b815481529060010190602001808311610b6c57829003601f168201915b5050505050905094509450945094505b509193509193565b600060011515610bb033610dc2565b1515141515610bbe57600080fd5b60011515610bcc8484610e60565b15151415610bdd5760009050610dbc565b600015156000846040518082805190602001908083835b602083101515610c195780518252602082019150602081019050602083039250610bf4565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060030160009054906101000a900460ff1615151415610c6e5760009050610dbc565b816000846040518082805190602001908083835b602083101515610ca75780518252602082019150602081019050602083039250610c82565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060020154141515610cee5760009050610dbc565b6000836040518082805190602001908083835b602083101515610d265780518252602082019150602081019050602083039250610d01565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055600182016000905560028201600090556003820160006101000a81549060ff0219169055600482016000610db59190612093565b5050600190505b92915050565b600060606000610dd06118a0565b9150600082511415610de55760009250610e59565b600090505b8151811015610e54578373ffffffffffffffffffffffffffffffffffffffff168282815181101515610e1857fe5b9060200190602002015173ffffffffffffffffffffffffffffffffffffffff161415610e475760019250610e59565b8080600101915050610dea565b600092505b5050919050565b6000600b610e6d84610ebe565b108015610e7a5750600182145b15610e885760019050610e8d565b600090505b92915050565b600080610e9f83610ebe565b9050600a811015610eb35760019150610eb8565b600091505b50919050565b600060606000600a604051908082528060200260200182016040528015610ef957816020015b6060815260200190600190039081610ee45790505b50915060a060405190810160405280608081526020017f376138366532623736323863373666636165373661386233373032356362613681526020017f393861323839613434313032633563303231353934623563396663653333303781526020017f326565376566393932663565303138646334346239386661313166656335333881526020017f3234643739303135373437653861633437346634656531356237666265383630815250826000815181101515610fb457fe5b9060200190602002018190525060a060405190810160405280608081526020017f363630383839653339623337616465353866373839393333393534313233653581526020017f366436343938393836613063643963613633643232336538363664353532316181526020017f616564633965353239386532663438323861356339306634633538666232346581526020017f313936313361343632636130323130646439363238323137393466363330663081525082600181518110151561107957fe5b9060200190602002018190525060a060405190810160405280608081526020017f326536316635373230316563383034663964353239386334363635383434666481526020017f303737613235313663643333656363656134386637626466393364653531383281526020017f646134663537646337623464383837306535653239316331373963303566663081526020017f343130303731386234393138346636346137633064343063633636333433646181525082600281518110151561113e57fe5b9060200190602002018190525060a060405190810160405280608081526020017f666334316137316437613734643836363564626363306634386339613630316581526020017f333062373134656435303634373636396566353263303366373132336632616581526020017f303738646361613336333839653236333665313035356635663630666466333881526020017f643839613232366565383432333466303036623333336361643264326263656581525082600381518110151561120357fe5b9060200190602002018190525060a060405190810160405280608081526020017f656266343666616361373534666339303731366436363565366336666562323081526020017f366361343337633965356631363639306536393035313362333032393335303581526020017f336139643732326238386432616230623937326634363434386633613533333781526020017f38626635636665303162383337336166326535343139376231373631376531638152508260048151811015156112c857fe5b9060200190602002018190525060a060405190810160405280608081526020017f383063346662663635313232643831376433383038616663623638336663363681526020017f643966396531396234373665613065653366373537646361356364313833313681526020017f656362383939396266656134653961356163633939363835303463623931393981526020017f393761356331616236323363356335333363623636323239313134396230613381525082600581518110151561138d57fe5b9060200190602002018190525060a060405190810160405280608081526020017f356437656438313331393136623130656135343561353539616265343634333081526020017f373130396133643632646462653139633336383938386262646231646432333381526020017f306236663362626234373964306264643739656633363064376439313735303081526020017f386439306637643531313232393639323130373933653861373532636563643681525082600681518110151561145257fe5b9060200190602002018190525060a060405190810160405280608081526020017f376563643465613162663465666133346461633431613136643763636431346581526020017f323364333939336464336630613534643732326565373664313730373138616481526020017f626137663234366330383262616461393232633837356666616161343631386581526020017f333037623638653434633238343764346634653362373637383834633032623781525082600781518110151561151757fe5b9060200190602002018190525060a060405190810160405280608081526020017f343835376637393265663737396335313166366437363433663039393134303981526020017f663737653431313234636564313433383532313735333536343133313566356481526020017f633939323765373330316666643761666337616538303235363633653137663581526020017f39333330366164663764336666616337633661613632356332353064653064358152508260088151811015156115dc57fe5b9060200190602002018190525060a060405190810160405280608081526020017f616436376332353032666332373233663264636632356131343037343433383281526020017f656233653465353064376534646439313063343233663761613466653066626281526020017f636332323037643232656636656466343639646436666265613733656661386481526020017f38376234623837366130643665333836633465303062366135316332613366388152508260098151811015156116a157fe5b90602001906020020181905250600090505b600a8110156118945781818151811015156116ca57fe5b906020019060200201516040516020018082805190602001908083835b60208310151561170c57805182526020820191506020810190506020830392506116e7565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b6020831015156117755780518252602082019150602081019050602083039250611750565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916846040516020018082805190602001908083835b6020831015156117df57805182526020820191506020810190506020830392506117ba565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b6020831015156118485780518252602082019150602081019050602083039250611823565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916141561188757809250611899565b80806001019150506116b3565b600a92505b5050919050565b606080600a6040519080825280602002602001820160405280156118d35781602001602082028038833980820191505090505b50905073c1fe56e3f58d3244f606306611a5d10c8333f1f68160008151811015156118fa57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff1681525050737cefc13b6e2aedeedfb7cb6c32457240746baee581600181518110151561195a57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505073ff3dac4f04ddbd24de5d6039f90596f0a8bb08fd8160028151811015156119ba57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505073071e8f5ddddd9f2d4b4bdf8fc970dfe8d9871c28816003815181101515611a1a57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250507394fd535aab6c01302147be7819d07817647f7b63816004815181101515611a7a57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505073a8073c95521a6db54f4b5ca31a04773b093e9274816005815181101515611ada57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505073e94517a4f6f45e80cbaaffbb0b845f4c0fdd7547816006815181101515611b3a57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505073ba30505351c17f4c818d94a990eded95e166474b816007815181101515611b9a57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505073212a83c0d7db5c526303f873d9ceaa32382b55d0816008815181101515611bfa57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff1681525050738db7cf1823fcfa6e9e2063f983b3b96a48eed5a4816009815181101515611c5a57fe5b9060200190602002019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250508091505090565b606080600a604051908082528060200260200182016040528015611cd557816020015b6060815260200190600190039081611cc05790505b5090506040805190810160405280600981526020017f5b3a3a5d3a333030300000000000000000000000000000000000000000000000815250816000815181101515611d1d57fe5b906020019060200201819052506040805190810160405280600981526020017f5b3a3a5d3a333030310000000000000000000000000000000000000000000000815250816001815181101515611d6f57fe5b906020019060200201819052506040805190810160405280600981526020017f5b3a3a5d3a333030320000000000000000000000000000000000000000000000815250816002815181101515611dc157fe5b906020019060200201819052506040805190810160405280600981526020017f5b3a3a5d3a333030330000000000000000000000000000000000000000000000815250816003815181101515611e1357fe5b906020019060200201819052506040805190810160405280600981526020017f5b3a3a5d3a333030340000000000000000000000000000000000000000000000815250816004815181101515611e6557fe5b906020019060200201819052506040805190810160405280600981526020017f5b3a3a5d3a333030350000000000000000000000000000000000000000000000815250816005815181101515611eb757fe5b906020019060200201819052506040805190810160405280600981526020017f5b3a3a5d3a333030360000000000000000000000000000000000000000000000815250816006815181101515611f0957fe5b906020019060200201819052506040805190810160405280600981526020017f5b3a3a5d3a333030370000000000000000000000000000000000000000000000815250816007815181101515611f5b57fe5b906020019060200201819052506040805190810160405280600981526020017f5b3a3a5d3a333030380000000000000000000000000000000000000000000000815250816008815181101515611fad57fe5b906020019060200201819052506040805190810160405280600981526020017f5b3a3a5d3a333030390000000000000000000000000000000000000000000000815250816009815181101515611fff57fe5b906020019060200201819052508091505090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061205457805160ff1916838001178555612082565b82800160010185558215612082579182015b82811115612081578251825591602001919060010190612066565b5b50905061208f91906120db565b5090565b50805460018160011615610100020316600290046000825580601f106120b957506120d8565b601f0160209004906000526020600020908101906120d791906120db565b5b50565b6120fd91905b808211156120f95760008160009055506001016120e1565b5090565b905600a165627a7a72305820fb0c7327a0940b99a7f0124d1b2903d55c6b3dcb515f219d0800099b1b61b87c0029")

	state.SetCode(address, code)
	var definition = `[
		{"constant": true,"inputs": [{"name": "_pubkey","type": "string"},{"name": "_nodeType","type": "uint256"}],
	"name": "isValidNode","outputs": [{"name": "","type": "uint256"}],"payable": false,"stateMutability": "view",
	"type": "function"},
		{"constant": true,"inputs": [{"name": "_pubkey","type": "string"}],"name": "isValidator","outputs": [{"name": "",
	"type": "uint256"}],"payable": false,"stateMutability": "view","type": "function"},
		{"constant": true,"inputs": [{"name": "_pubkey","type": "string"}],"name": "getNodeInfo","outputs": [{"name": "addr",
	"type": "address"},{"name": "votingPower","type": "uint256"},{"name": "nodeType","type": "uint256"}, {"name": "listenAddress","type": "string"}],"payable": false,"stateMutability": "view","type": "function"},
		{"constant": false,"inputs": [{"name": "_pubkey","type": "string"},{"name": "_addr","type": "address"},{"name": "_nodeType",
	"type": "uint256"},{"name": "_votingPower","type": "uint256"},{"name": "listenAddress","type": "string"}],"name": "addNode","outputs": [{"name": "","type": "uint256"}],
	"payable": false,"stateMutability": "nonpayable","type": "function"},
		{"constant": false,"inputs": [{"name": "_pubkey","type": "string"},{"name": "_nodeType","type": "uint256"}],
	"name": "removeNode","outputs": [{"name": "","type": "uint256"}],"payable": false,"stateMutability": "nonpayable","type": "function"
	}
]`
	abi, err := abi.JSON(strings.NewReader(definition))
	if err != nil {
		t.Fatal(err)
	}

	addNodeInput, err := abi.Pack("addNode", "abcdefxyz",
		common.HexToAddress("0x00009"), big.NewInt(2), big.NewInt(0), "[::]:3009")
	// Add node from non-owner account, should return error
	addNodeResult, _, err := Call(address, addNodeInput, &Config{State: state, Origin: common.HexToAddress("0xaa")})
	if err == nil {
		t.Error("Added from non owner, expect error but nil returned")
	}
	// Add node from owner account
	addNodeResult, _, err = Call(address, addNodeInput, &Config{State: state, Origin: common.HexToAddress("0xc1fe56E3F58D3244F606306611a5d10c8333f1f6")})
	if err != nil {
		t.Fatal(err)
	}
	result := big.NewInt(0).SetBytes(addNodeResult)
	if result.Cmp(big.NewInt(1)) != 0 {
		t.Error("Expect add node from owner returns 1, got", result.String())
	}
	// Verify newly added node type
	getNodeInput, err := abi.Pack("getNodeInfo", "abcdefxyz")
	if err != nil {
		t.Fatal(err)
	}
	getNodeResult, _, err := Call(address, getNodeInput, &Config{State: state, Origin: common.HexToAddress("0xc1fe56E3F58D3244F606306611a5d10c8333f1f6")})
	var nodeInfo struct {
		Addr common.Address
		VotingPower *big.Int
		NodeType *big.Int
		ListenAddress string
	}

	err = abi.Unpack(&nodeInfo, "getNodeInfo", getNodeResult)
	if err != nil {
		t.Fatal(err)
	}
	if nodeInfo.Addr != common.HexToAddress("0x00009") {
		t.Error("Expect address 0x00009, got", nodeInfo.Addr.String())
	}
	if nodeInfo.VotingPower.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expect voting power 0, got", nodeInfo.VotingPower.String())
	}
	if nodeInfo.NodeType.Cmp(big.NewInt(2)) != 0 {
		t.Error("Expect node type 2, got", nodeInfo.VotingPower.String())
	}
	if nodeInfo.ListenAddress != "[::]:3009" {
		t.Error("Expect node listen address [::]:3009, got", nodeInfo.ListenAddress)
	}
	// Test if newly added node is valid
	getValidNodeInput, err := abi.Pack("isValidNode", "abcdefxyz",
		big.NewInt(2))
	if err != nil {
		t.Fatal(err)
	}
	getValidNodeResult, _, err := Call(address, getValidNodeInput, &Config{State: state})
	result = big.NewInt(0).SetBytes(getValidNodeResult)
	if result.Cmp(big.NewInt(1)) != 0 {
		t.Error("Expect isValidNode return 1, got", result.String())
	}

	// Test if an arbitrary node is valid
	getValidNodeInput, err = abi.Pack("isValidNode", "abcxyz",
		big.NewInt(2))
	if err != nil {
		t.Fatal(err)
	}
	getValidNodeResult, _, err = Call(address, getValidNodeInput, &Config{State: state})
	result = big.NewInt(0).SetBytes(getValidNodeResult)
	if result.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expect isValidNode return 0, got", result.String())
	}

	// Test if initial validator is correct
	getValidatorInput, err := abi.Pack("isValidator", "7a86e2b7628c76fcae76a8b37025cba698a289a44102c5c021594b5c9fce33072ee7ef992f5e018dc44b98fa11fec53824d79015747e8ac474f4ee15b7fbe860")
	getValidatorResult, _, err := Call(address, getValidatorInput, &Config{State: state})
	result = big.NewInt(0).SetBytes(getValidatorResult)
	if result.Cmp(big.NewInt(1)) != 0 {
		t.Error("Expect isValidator return 1, got", result.String())
	}

	// Test if arbitrary key is regconized as initial validator
	getValidatorInput, err = abi.Pack("isValidator", "arbitrarypubkey")
	getValidatorResult, _, err = Call(address, getValidatorInput, &Config{State: state})
	result = big.NewInt(0).SetBytes(getValidatorResult)
	if result.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expect isValidator return 0, got", result.String())
	}

	// Test remove node with non-owner user
	removeNodeInput, err := abi.Pack("removeNode", "abcdefxyz", big.NewInt(2))
	// remove node called by non-owner user, should return error
	_, _, err = Call(address, removeNodeInput, &Config{State: state, Origin: common.HexToAddress("0xaa")})
	if err == nil {
		t.Error("Remove from non owner, expect error but nil returned")
	}

	// Test remove with owner user, remove an initial node, should return error
	removeNodeInput, err = abi.Pack("removeNode", "7a86e2b7628c76fcae76a8b37025cba698a289a44102c5c021594b5c9fce33072ee7ef992f5e018dc44b98fa11fec53824d79015747e8ac474f4ee15b7fbe860", big.NewInt(1))
	removeResult, _, err := Call(address, removeNodeInput, &Config{State: state, Origin: common.HexToAddress("0xc1fe56E3F58D3244F606306611a5d10c8333f1f6")})
	result = big.NewInt(0).SetBytes(removeResult)
	if result.Cmp(big.NewInt(0)) != 0 {
		t.Error("Remove initial account should return 0 but got", result.String())
	}

	// Remove newly added node with owner user, should success
	removeNodeInput, err = abi.Pack("removeNode", "abcdefxyz", big.NewInt(2))
	removeResult, _, err = Call(address, removeNodeInput, &Config{State: state, Origin: common.HexToAddress("0xc1fe56E3F58D3244F606306611a5d10c8333f1f6")})
	result = big.NewInt(0).SetBytes(removeResult)
	if result.Cmp(big.NewInt(1)) != 0 {
		t.Error("Remove newly added account should return 1 but got", result.String())
	}

	// Get NodeInfo of removed node
	getNodeResult, _, err = Call(address, getNodeInput, &Config{State: state, Origin: common.HexToAddress("0xc1fe56E3F58D3244F606306611a5d10c8333f1f6")})
	err = abi.Unpack(&nodeInfo, "getNodeInfo", getNodeResult)
	if err != nil {
		t.Fatal(err)
	}
	if nodeInfo.Addr != common.HexToAddress("0x") {
		t.Error("Expect address 0x, got", nodeInfo.Addr.String())
	}
	if nodeInfo.VotingPower.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expect voting power 0, got", nodeInfo.VotingPower.String())
	}
	if nodeInfo.NodeType.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expect node type 0, got", nodeInfo.VotingPower.String())
	}

	if nodeInfo.ListenAddress != "" {
		t.Error("Expect node listen address empty, got", nodeInfo.ListenAddress)
	}

	// Add new validator from owner account
	addNodeInput, err = abi.Pack("addNode", "abcdefxyz",
		common.HexToAddress("0x00009"), big.NewInt(1), big.NewInt(100), "[::]:3009")
	addNodeResult, _, err = Call(address, addNodeInput, &Config{State: state, Origin: common.HexToAddress("0xc1fe56E3F58D3244F606306611a5d10c8333f1f6")})
	if err != nil {
		t.Fatal(err)
	}
	result = big.NewInt(0).SetBytes(addNodeResult)
	if result.Cmp(big.NewInt(1)) != 0 {
		t.Error("Expect add node from owner returns 1, got", result.String())
	}

	// Test if newly added node is validator
	getValidatorInput, err = abi.Pack("isValidator", "abcdefxyz")
	getValidatorResult, _, err = Call(address, getValidatorInput, &Config{State: state})
	result = big.NewInt(0).SetBytes(getValidatorResult)
	if result.Cmp(big.NewInt(1)) != 0 {
		t.Error("Expect isValidator return 1, got", result.String())
	}
}
