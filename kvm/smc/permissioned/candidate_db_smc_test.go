/*
 *  Copyright 2018 KardiaChain
 *  This file is part of the go-kardia library.
 *
 *  The go-kardia library is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU Lesser General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  The go-kardia library is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 *  GNU Lesser General Public License for more details.
 *
 *  You should have received a copy of the GNU Lesser General Public License
 *  along with the go-kardia library. If not, see <http://www.gnu.org/licenses/>.
 */

 package kvm

import (
	"strings"
	"testing"

	"encoding/hex"
	"github.com/kardiachain/go-kardia/kai/state"
	kaidb "github.com/kardiachain/go-kardia/kai/storage"
	"github.com/kardiachain/go-kardia/kvm"
	"github.com/kardiachain/go-kardia/kvm/sample_kvm"
	"github.com/kardiachain/go-kardia/lib/abi"
	"github.com/kardiachain/go-kardia/lib/common"
	"github.com/kardiachain/go-kardia/lib/crypto"
	"github.com/kardiachain/go-kardia/lib/log"
	"github.com/kardiachain/go-kardia/mainchain/blockchain"
	"github.com/kardiachain/go-kardia/mainchain/genesis"
	"github.com/kardiachain/go-kardia/tool"
	"github.com/kardiachain/go-kardia/types"
	"math"
	"math/big"
	"time"
	"github.com/kardiachain/go-kardia/kai/base"
)

var code = common.Hex2Bytes("608060405260043610610062576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680631a83260c146100675780634aba9bb11461015c578063945f24671461027e578063b61add9a146103a0575b600080fd5b34801561007357600080fd5b5061015a600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929050505061059f565b005b34801561016857600080fd5b5061027c600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803560ff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929050505061071a565b005b34801561028a57600080fd5b5061039e600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803560ff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192905050506108ed565b005b3480156103ac57600080fd5b50610407600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610ac0565b6040518080602001806020018781526020018673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001851515151581526020018060200184810384528a818151815260200191508051906020019080838360005b83811015610491578082015181840152602081019050610476565b50505050905090810190601f1680156104be5780820380516001836020036101000a031916815260200191505b50848103835289818151815260200191508051906020019080838360005b838110156104f75780820151818401526020810190506104dc565b50505050905090810190601f1680156105245780820380516001836020036101000a031916815260200191505b50848103825285818151815260200191508051906020019080838360005b8381101561055d578082015181840152602081019050610542565b50505050905090810190601f16801561058a5780820380516001836020036101000a031916815260200191505b50995050505050505050505060405180910390f35b7fe2df4c83eef1ab3c88f888395f79598f4f2b295eb4701a77c0278a2027392b3f83838360405180806020018060200180602001848103845287818151815260200191508051906020019080838360005b8381101561060b5780820151818401526020810190506105f0565b50505050905090810190601f1680156106385780820380516001836020036101000a031916815260200191505b50848103835286818151815260200191508051906020019080838360005b83811015610671578082015181840152602081019050610656565b50505050905090810190601f16801561069e5780820380516001836020036101000a031916815260200191505b50848103825285818151815260200191508051906020019080838360005b838110156106d75780820151818401526020810190506106bc565b50505050905090810190601f1680156107045780820380516001836020036101000a031916815260200191505b50965050505050505060405180910390a1505050565b610722610f58565b60e0604051908101604052808781526020018681526020018560ff1681526020018473ffffffffffffffffffffffffffffffffffffffff168152602001600115158152602001838152602001600115158152509050806000866040518082805190602001908083835b6020831015156107b0578051825260208201915060208101905060208303925061078b565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060008201518160000190805190602001906107ff929190610fb3565b50602082015181600101908051906020019061081c929190610fb3565b5060408201518160020160006101000a81548160ff021916908360ff16021790555060608201518160020160016101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060808201518160020160156101000a81548160ff02191690831515021790555060a08201518160030190805190602001906108c1929190610fb3565b5060c08201518160040160006101000a81548160ff021916908315150217905550905050505050505050565b6108f5610f58565b60e0604051908101604052808781526020018681526020018560ff1681526020018473ffffffffffffffffffffffffffffffffffffffff168152602001600015158152602001838152602001600115158152509050806000866040518082805190602001908083835b602083101515610983578051825260208201915060208101905060208303925061095e565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060008201518160000190805190602001906109d2929190610fb3565b5060208201518160010190805190602001906109ef929190610fb3565b5060408201518160020160006101000a81548160ff021916908360ff16021790555060608201518160020160016101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060808201518160020160156101000a81548160ff02191690831515021790555060a0820151816003019080519060200190610a94929190610fb3565b5060c08201518160040160006101000a81548160ff021916908315150217905550905050505050505050565b606080600080600060606000876040518082805190602001908083835b602083101515610b025780518252602082019150602081019050602083039250610add565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060040160009054906101000a900460ff1615610efe576000876040518082805190602001908083835b602083101515610b835780518252602082019150602081019050602083039250610b5e565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600001876000896040518082805190602001908083835b602083101515610bf25780518252602082019150602081019050602083039250610bcd565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060020160009054906101000a900460ff1660008a6040518082805190602001908083835b602083101515610c6e5780518252602082019150602081019050602083039250610c49565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060020160019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1660008b6040518082805190602001908083835b602083101515610cfd5780518252602082019150602081019050602083039250610cd8565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060020160159054906101000a900460ff1660008c6040518082805190602001908083835b602083101515610d795780518252602082019150602081019050602083039250610d54565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600301858054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610e445780601f10610e1957610100808354040283529160200191610e44565b820191906000526020600020905b815481529060010190602001808311610e2757829003601f168201915b505050505095508360ff169350808054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610ee65780601f10610ebb57610100808354040283529160200191610ee6565b820191906000526020600020905b815481529060010190602001808311610ec957829003601f168201915b50505050509050955095509550955095509550610f4f565b60008060006020604051908101604052806000815250929190602060405190810160405280600081525092919082925081915060206040519081016040528060008152509550955095509550955095505b91939550919395565b60e0604051908101604052806060815260200160608152602001600060ff168152602001600073ffffffffffffffffffffffffffffffffffffffff168152602001600015158152602001606081526020016000151581525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610ff457805160ff1916838001178555611022565b82800160010185558215611022579182015b82811115611021578251825591602001919060010190611006565b5b50905061102f9190611033565b5090565b61105591905b80821115611051576000816000905550600101611039565b5090565b905600a165627a7a723058204340a7ceedc1de1d85fe87aee06804595016e1ccf69e8abac6ed23638967cdfa0029")

var definition = `[
	{
		"constant": false,
		"inputs": [
			{
				"name": "_name",
				"type": "string"
			},
			{
				"name": "_email",
				"type": "string"
			},
			{
				"name": "_age",
				"type": "uint8"
			},
			{
				"name": "_addr",
				"type": "address"
			},
			{
				"name": "source",
				"type": "string"
			}
		],
		"name": "updateCandidateInfoFromExternal",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_name",
				"type": "string"
			},
			{
				"name": "_email",
				"type": "string"
			},
			{
				"name": "_age",
				"type": "uint8"
			},
			{
				"name": "_addr",
				"type": "address"
			},
			{
				"name": "source",
				"type": "string"
			}
		],
		"name": "updateCandidateInfo",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_email",
				"type": "string"
			}
		],
		"name": "getCandidateInfo",
		"outputs": [
			{
				"name": "name",
				"type": "string"
			},
			{
				"name": "email",
				"type": "string"
			},
			{
				"name": "age",
				"type": "uint256"
			},
			{
				"name": "addr",
				"type": "address"
			},
			{
				"name": "isExternal",
				"type": "bool"
			},
			{
				"name": "source",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "email",
				"type": "string"
			},
			{
				"name": "_fromOrgId",
				"type": "string"
			},
			{
				"name": "_toOrgId",
				"type": "string"
			}
		],
		"name": "requestCandidateInfo",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "email",
				"type": "string"
			},
			{
				"indexed": false,
				"name": "fromOrgId",
				"type": "string"
			},
			{
				"indexed": false,
				"name": "toOrgId",
				"type": "string"
			}
		],
		"name": "ExternalCandidateInfoRequested",
		"type": "event"
	}
]`

type CandidateInfo struct {
	Name       string
	Email      string
	Age        *big.Int
	Addr       common.Address
	IsExternal bool
	Source     string
}

// For contract of all tests in this file, please find the solidity source code at go-kardia/kvm/smc/permissioned/CandidateDB.sol

// Util function to setup abi for contract
func SetupContractAbi() (*state.StateDB, common.Address, *abi.ABI, error) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(kaidb.NewMemStore()))

	address := common.HexToAddress("0x0a")

	//var code = common.Hex2Bytes("608060405260043610610083576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680632c72bd87146100885780634d78b88e146101055780637fb06000146101b95780638e4a24041461023d578063ab2cb4f9146102ba578063c21d485814610341578063f2b57a28146104c7575b600080fd5b34801561009457600080fd5b506100ef600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610620565b6040518082815260200191505060405180910390f35b34801561011157600080fd5b5061013060048036038101908080359060200190929190505050610771565b6040518084815260200180602001838152602001828103825284818151815260200191508051906020019080838360005b8381101561017c578082015181840152602081019050610161565b50505050905090810190601f1680156101a95780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b3480156101c557600080fd5b50610220600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610a25565b604051808381526020018281526020019250505060405180910390f35b34801561024957600080fd5b506102b8600480360381019080803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192908035906020019092919080359060200190929190505050610b0f565b005b3480156102c657600080fd5b5061032b60048036038101908080359060200190929190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610bab565b6040518082815260200191505060405180910390f35b34801561034d57600080fd5b5061043e600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001909291905050506110bf565b6040518084815260200180602001838152602001828103825284818151815260200191508051906020019080838360005b8381101561048a57808201518184015260208101905061046f565b50505050905090810190601f1680156104b75780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b3480156104d357600080fd5b5061060a600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001909291905050506113ba565b6040518082815260200191505060405180910390f35b6000606060008092506001846040518082805190602001908083835b602083101515610661578051825260208201915060208101905060208303925061063c565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390208054806020026020016040519081016040528092919081815260200182805480156106de57602002820191906000526020600020905b8154815260200190600101908083116106ca575b50505050509150600090505b8151811015610767576000806000848481518110151561070657fe5b90602001906020020151815260200190815260200160002060050154141561075a57600080838381518110151561073957fe5b90602001906020020151815260200190815260200160002060040154830192505b80806001019150506106ea565b8292505050919050565b60006060600080610780612457565b60008087815260200190815260200160002060050154915060008214156107c757600080819150602060405190810160405280600081525090809050945094509450610a1c565b60008083815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561087e5780601f106108535761010080835404028352916020019161087e565b820191906000526020600020905b81548152906001019060200180831161086157829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109205780601f106108f557610100808354040283529160200191610920565b820191906000526020600020905b81548152906001019060200180831161090357829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109c25780601f10610997576101008083540402835291602001916109c2565b820191906000526020600020905b8154815290600101906020018083116109a557829003601f168201915b50505050508152602001600382015481526020016004820154815260200160058201548152602001600682015481525050905060008160c001511415610a1b578181604001518260800151819150945094509450610a1c565b5b50509193909250565b6000806002836040518082805190602001908083835b602083101515610a605780518252602082019150602081019050602083039250610a3b565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600001546002846040518082805190602001908083835b602083101515610acf5780518252602082019150602081019050602083039250610aaa565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206001015491509150915091565b6040805190810160405280838152602001828152506002846040518082805190602001908083835b602083101515610b5c5780518252602082019150602081019050602083039250610b37565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206000820151816000015560208201518160010155905050505050565b6000610bb5612457565b600080600086815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610c6e5780601f10610c4357610100808354040283529160200191610c6e565b820191906000526020600020905b815481529060010190602001808311610c5157829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610d105780601f10610ce557610100808354040283529160200191610d10565b820191906000526020600020905b815481529060010190602001808311610cf357829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610db25780601f10610d8757610100808354040283529160200191610db2565b820191906000526020600020905b815481529060010190602001808311610d9557829003601f168201915b505050505081526020016003820154815260200160048201548152602001600582015481526020016006820154815250509150836040516020018082805190602001908083835b602083101515610e1e5780518252602082019150602081019050602083039250610df9565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083101515610e875780518252602082019150602081019050602083039250610e62565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191682600001516040516020018082805190602001908083835b602083101515610ef55780518252602082019150602081019050602083039250610ed0565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083101515610f5e5780518252602082019150602081019050602083039250610f39565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916141515610f9f57600092506110b7565b600080600087815260200190815260200160002060060154141515610fc757600092506110b7565b6001600080878152602001908152602001600020600601819055506000808681526020019081526020016000206005015490506110b285826000808981526020019081526020016000206000018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156110a85780601f1061107d576101008083540402835291602001916110a8565b820191906000526020600020905b81548152906001019060200180831161108b57829003601f168201915b50505050506115c7565b600192505b505092915050565b6000606060008060006110d0612457565b6110dc8a8a8a8a611970565b9250600083141561110d576000808191506020604051908101604052806000815250908090509550955095506113ad565b60008060008581526020019081526020016000206005015414151561138b5760008084815260200190815260200160002060050154915060008083815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156111fb5780601f106111d0576101008083540402835291602001916111fb565b820191906000526020600020905b8154815290600101906020018083116111de57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561129d5780601f106112725761010080835404028352916020019161129d565b820191906000526020600020905b81548152906001019060200180831161128057829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561133f5780601f106113145761010080835404028352916020019161133f565b820191906000526020600020905b81548152906001019060200180831161132257829003601f168201915b50505050508152602001600382015481526020016004820154815260200160058201548152602001600682015481525050905081816040015182608001518191509550955095506113ad565b6000808191506020604051908101604052806000815250908090509550955095505b5050509450945094915050565b60006113c4612495565b6000806113cf612457565b6113d88a61203b565b93506000846020015114806113f1575060008460000151145b156113ff57600094506115ba565b6003600081546001019190508190555083600001518460200151870281151561142457fe5b04925061143189846120d4565b915060e0604051908101604052808b815260200189815260200188815260200187815260200184815260200183815260200160008152509050806000806003548152602001908152602001600020600082015181600001908051906020019061149b9291906124af565b5060208201518160010190805190602001906114b89291906124af565b5060408201518160020190805190602001906114d59291906124af565b50606082015181600301556080820151816004015560a0820151816005015560c0820151816006015590505060018a6040518082805190602001908083835b6020831015156115395780518252602082019150602081019050602083039250611514565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060035490806001815401808255809150509060018203906000526020600020016000909192909190915055506003546000808481526020019081526020016000206005018190555060035494505b5050505095945050505050565b60606000806001846040518082805190602001908083835b60208310151561160457805182526020820191506020810190506020830392506115df565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902080548060200260200160405190810160405280929190818152602001828054801561168157602002820191906000526020600020905b81548152602001906001019080831161166d575b5050505050925082519150600090505b82518110156116ca578583828151811015156116a957fe5b9060200190602002015114156116bd578091505b8080600101915050611691565b825182101561185e576001846040518082805190602001908083835b60208310151561170b57805182526020820191506020810190506020830392506116e6565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600184510381548110151561174f57fe5b90600052602060002001546001856040518082805190602001908083835b602083101515611792578051825260208201915060208101905060208303925061176d565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020838154811015156117d257fe5b9060005260206000205050506001846040518082805190602001908083835b60208310151561181657805182526020820191506020810190506020830392506117f1565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902080548091906001900361185c919061252f565b505b6001600080888152602001908152602001600020600601541480156118985750600160008087815260200190815260200160002060060154145b1561196857600080878152602001908152602001600020600080820160006118c0919061255b565b6001820160006118d0919061255b565b6002820160006118e0919061255b565b6003820160009055600482016000905560058201600090556006820160009055505060008086815260200190815260200160002060008082016000611925919061255b565b600182016000611935919061255b565b600282016000611945919061255b565b600382016000905560048201600090556005820160009055600682016000905550505b505050505050565b60006060600061197e612457565b6001886040518082805190602001908083835b6020831015156119b65780518252602082019150602081019050602083039250611991565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020805480602002602001604051908101604052809291908181526020018280548015611a3357602002820191906000526020600020905b815481526020019060010190808311611a1f575b50505050509250600091505b825182101561202b576000808484815181101515611a5957fe5b90602001906020020151815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611b165780601f10611aeb57610100808354040283529160200191611b16565b820191906000526020600020905b815481529060010190602001808311611af957829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611bb85780601f10611b8d57610100808354040283529160200191611bb8565b820191906000526020600020905b815481529060010190602001808311611b9b57829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611c5a5780601f10611c2f57610100808354040283529160200191611c5a565b820191906000526020600020905b815481529060010190602001808311611c3d57829003601f168201915b505050505081526020016003820154815260200160048201548152602001600582015481526020016006820154815250509050866040516020018082805190602001908083835b602083101515611cc65780518252602082019150602081019050602083039250611ca1565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083101515611d2f5780518252602082019150602081019050602083039250611d0a565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191681602001516040516020018082805190602001908083835b602083101515611d9d5780518252602082019150602081019050602083039250611d78565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083101515611e065780518252602082019150602081019050602083039250611de1565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916148015611feb5750856040516020018082805190602001908083835b602083101515611e785780518252602082019150602081019050602083039250611e53565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083101515611ee15780518252602082019150602081019050602083039250611ebc565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191681604001516040516020018082805190602001908083835b602083101515611f4f5780518252602082019150602081019050602083039250611f2a565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083101515611fb85780518252602082019150602081019050602083039250611f93565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916145b8015611ffa5750848160600151145b1561201e57828281518110151561200d57fe5b906020019060200201519350612030565b8180600101925050611a3f565b600093505b505050949350505050565b612043612495565b6002826040518082805190602001908083835b60208310151561207b5780518252602082019150602081019050602083039250612056565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020604080519081016040529081600082015481526020016001820154815250509050919050565b6000606060006120e2612457565b6001866040518082805190602001908083835b60208310151561211a57805182526020820191506020810190506020830392506120f5565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902080548060200260200160405190810160405280929190818152602001828054801561219757602002820191906000526020600020905b815481526020019060010190808311612183575b50505050509250600091505b82518210156124495760008084848151811015156121bd57fe5b90602001906020020151815260200190815260200160002060e06040519081016040529081600082018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561227a5780601f1061224f5761010080835404028352916020019161227a565b820191906000526020600020905b81548152906001019060200180831161225d57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561231c5780601f106122f15761010080835404028352916020019161231c565b820191906000526020600020905b8154815290600101906020018083116122ff57829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156123be5780601f10612393576101008083540402835291602001916123be565b820191906000526020600020905b8154815290600101906020018083116123a157829003601f168201915b505050505081526020016003820154815260200160048201548152602001600582015481526020016006820154815250509050848160600151148015612408575060008160a00151145b8015612418575060008160c00151145b1561243c57828281518110151561242b57fe5b90602001906020020151935061244e565b81806001019250506121a3565b600093505b50505092915050565b60e060405190810160405280606081526020016060815260200160608152602001600081526020016000815260200160008152602001600081525090565b604080519081016040528060008152602001600081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106124f057805160ff191683800117855561251e565b8280016001018555821561251e579182015b8281111561251d578251825591602001919060010190612502565b5b50905061252b91906125a3565b5090565b8154818355818111156125565781836000526020600020918201910161255591906125a3565b5b505050565b50805460018160011615610100020316600290046000825580601f1061258157506125a0565b601f01602090049060005260206000209081019061259f91906125a3565b5b50565b6125c591905b808211156125c15760008160009055506001016125a9565b5090565b905600a165627a7a72305820b1ed50527ab39b9832c1ff7d210d0926bf563984470592e5139eecc9b68dc2f40029")
	state.SetCode(address, code)
	abi, err := abi.JSON(strings.NewReader(definition))
	if err != nil {
		return nil, common.Address{}, nil, err
	}
	return state, address, &abi, nil
}

// TestAddCandidateFromExternalChain tests interface to add a candidate to CandidateDB of private chain internally
func TestAddCandidateFromPrivateChain(t *testing.T) {
	state, address, abi, err := SetupContractAbi()
	if err != nil {
		t.Fatal(err)
	}
	// Try to get a non-existing candidate, default values should be returned
	getCandidateInput, err := abi.Pack("getCandidateInfo", "a@gmail.com")
	if err != nil {
		t.Fatal(err)
	}
	var candidateInfo CandidateInfo
	getCandidateResult, _, err := sample_kvm.Call(address, getCandidateInput, &sample_kvm.Config{State: state})
	if err != nil {
		t.Fatal(err)
	}
	err = abi.Unpack(&candidateInfo, "getCandidateInfo", getCandidateResult)
	if err != nil {
		t.Fatal(err)
	}
	if candidateInfo.Name != "" {
		t.Error("Expect name is empty, got ", candidateInfo.Name)
	}
	if candidateInfo.Email != "" {
		t.Error("Expect email is empty, got ", candidateInfo.Name)
	}
	if candidateInfo.Age.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expect age is 0, got ", candidateInfo.Age.String())
	}
	if candidateInfo.Addr != common.HexToAddress("0x") {
		t.Error("Expect address is 0x, got ", candidateInfo.Addr.String())
	}
	if candidateInfo.IsExternal {
		t.Error("Expect isExternal is false, got true")
	}
	if candidateInfo.Source != "" {
		t.Error("Expect source is empty, got ", candidateInfo.Source)
	}
	// Add a candidate via internal private chain, should be success, isExternal should be false
	addCandidateInput, err := abi.Pack("updateCandidateInfo", "c1", "c1@gmail.com", uint8(18),
		common.HexToAddress("0xaa"), "PV1")
	if err != nil {
		t.Fatal(err)
	}
	_, _, err = sample_kvm.Call(address, addCandidateInput, &sample_kvm.Config{State: state})
	if err != nil {
		t.Fatal(err)
	}
	// Get Info of newly added candidate
	getCandidateInput, err = abi.Pack("getCandidateInfo", "c1@gmail.com")
	if err != nil {
		t.Fatal(err)
	}
	getCandidateResult, _, err = sample_kvm.Call(address, getCandidateInput, &sample_kvm.Config{State: state})
	if err != nil {
		t.Fatal(err)
	}
	err = abi.Unpack(&candidateInfo, "getCandidateInfo", getCandidateResult)
	if err != nil {
		t.Fatal(err)
	}
	if candidateInfo.Name != "c1" {
		t.Error("Expect name is c1, got ", candidateInfo.Name)
	}
	if candidateInfo.Email != "c1@gmail.com" {
		t.Error("Expect email is c1@gmail.com, got ", candidateInfo.Name)
	}
	if candidateInfo.Age.Cmp(big.NewInt(18)) != 0 {
		t.Error("Expect age is 18, got ", candidateInfo.Age.String())
	}
	if candidateInfo.Addr != common.HexToAddress("0xaa") {
		t.Error("Expect address is 0xaa, got ", candidateInfo.Addr.String())
	}
	if candidateInfo.IsExternal {
		t.Error("Expect isExternal is false, got true")
	}
	if candidateInfo.Source != "PV1" {
		t.Error("Expect source is PV1, got ", candidateInfo.Source)
	}
}

// TestAddCandidateFromExternalChain tests interface to add a candidate from external chain to CandidateDB of private chain
func TestAddCandidateFromExternalChain(t *testing.T) {
	state, address, abi, err := SetupContractAbi()

	// Add a candidate via external private chain, should be success, isExternal should be false
	addCandidateInput, err := abi.Pack("updateCandidateInfoFromExternal", "c2", "c2@gmail.com", uint8(20),
		common.HexToAddress("0xa1"), "PV2")
	if err != nil {
		t.Fatal(err)
	}
	_, _, err = sample_kvm.Call(address, addCandidateInput, &sample_kvm.Config{State: state})
	if err != nil {
		t.Fatal(err)
	}
	// Get Info of newly added candidate, isExternal should be true
	getCandidateInput, err := abi.Pack("getCandidateInfo", "c2@gmail.com")
	if err != nil {
		t.Fatal(err)
	}
	getCandidateResult, _, err := sample_kvm.Call(address, getCandidateInput, &sample_kvm.Config{State: state})
	if err != nil {
		t.Fatal(err)
	}
	var candidateInfo CandidateInfo
	err = abi.Unpack(&candidateInfo, "getCandidateInfo", getCandidateResult)
	if err != nil {
		t.Fatal(err)
	}
	if candidateInfo.Name != "c2" {
		t.Error("Expect name is c2, got ", candidateInfo.Name)
	}
	if candidateInfo.Email != "c2@gmail.com" {
		t.Error("Expect email is c2@gmail.com, got ", candidateInfo.Name)
	}
	if candidateInfo.Age.Cmp(big.NewInt(20)) != 0 {
		t.Error("Expect age is 20, got ", candidateInfo.Age.String())
	}
	if candidateInfo.Addr != common.HexToAddress("0xa1") {
		t.Error("Expect address is 0xa1, got ", candidateInfo.Addr.String())
	}
	if !candidateInfo.IsExternal {
		t.Error("Expect isExternal is true, got false")
	}
	if candidateInfo.Source != "PV2" {
		t.Error("Expect source is PV2, got ", candidateInfo.Source)
	}
}

// ApplyTransactionReturnLog applies an tx to a blockchain and returns all the logs generated from that tx
func ApplyTransactionReturnLog(bc base.BaseBlockChain, statedb *state.StateDB, tx *types.Transaction) ([]*types.Log, error) {
	var (
		usedGas = new(uint64)
		header  = &types.Header{Time: big.NewInt(time.Now().Unix()), GasLimit: 10000000}
		gp      = new(blockchain.GasPool).AddGas(10000000)
		logger  = log.New()
	)
	statedb.Prepare(tx.Hash(), common.Hash{}, 1)
	receipt, _, err := blockchain.ApplyTransaction(logger, bc, gp, statedb, header, tx, usedGas, kvm.Config{})

	if err != nil {
		return nil, err
	}
	return receipt.Logs, nil
}

func SetupBlockchainForTesting() (*blockchain.BlockChain, error) {
	kaiDb := kaidb.NewMemStore()
	var genesisAccounts = map[string]int64{
		"0xc1fe56E3F58D3244F606306611a5d10c8333f1f6": int64(math.Pow10(18)),
		"0xBA30505351c17F4c818d94a990eDeD95e166474b": int64(math.Pow10(18)),
	}
	g := genesis.DefaulTestnetFullGenesisBlock(genesisAccounts, map[string]string{})
	chainConfig, _, genesisErr := genesis.SetupGenesisBlock(log.New(), kaiDb, g)
	if genesisErr != nil {
		return nil, genesisErr
	}

	bc, err := blockchain.NewBlockChain(log.New(), kaiDb, chainConfig, true)
	return bc, err
}

// TestEmitEvent tests if contract emits correct event and data when there is tx requested external candidate data
func TestEmitEvent(t *testing.T) {
	// Setup blockchain for testing
	bc, err := SetupBlockchainForTesting()
	if err != nil {
		t.Fatal(err)
	}
	statedb, err := bc.State()
	if err != nil {
		t.Fatal(err)
	}
	// Setup contract code into newly generated state
	address := common.HexToAddress("0x0a")
	statedb.SetCode(address, code)
	abi, err := abi.JSON(strings.NewReader(definition))
	if err != nil {
		t.Fatal(err)
	}
	// Create tx to request candidate info from external chain
	requestCandidateInfoInput, err := abi.Pack("requestCandidateInfo", "a@gmail.com", "org1", "org2")
	if err != nil {
		t.Fatal(err)
	}
	addrKeyBytes, _ := hex.DecodeString("8843ebcb1021b00ae9a644db6617f9c6d870e5fd53624cefe374c1d2d710fd06")
	addrKey := crypto.ToECDSAUnsafe(addrKeyBytes)
	tx := tool.GenerateSmcCall(addrKey, address, requestCandidateInfoInput,
		state.ManageState(statedb))
	// Apply tx and get returned logs from that tx
	logs, err := ApplyTransactionReturnLog(bc, statedb, tx)
	if err != nil {
		t.Fatal(err)
	}
	// Check if there is event emitted from previous tx
	if len(logs) == 0 {
		t.Error("Expect length of log > 0, 0 is returned")
	}
	type ExternalCandidateInfoRequested struct {
		Email  string
		FromOrgId string
		ToOrgId string
	}
	var requestEvent ExternalCandidateInfoRequested
	err = abi.Unpack(&requestEvent, "ExternalCandidateInfoRequested", logs[0].Data)
	if err != nil {
		t.Fatal(err)
	}
	// Check if event data is emitted correctly
	if requestEvent.Email != "a@gmail.com" {
		t.Error("Expect request info for a@gmail.com, got ", requestEvent.Email)
	}
	if requestEvent.FromOrgId != "org1" {
		t.Error("Expect FromOrgId is Org1, get ", requestEvent.FromOrgId)
	}
	if requestEvent.ToOrgId != "org2" {
		t.Error("Expect ToOrgId is Org2, get ", requestEvent.ToOrgId)
	}
}
