package smc

import (
	"math/big"
	"strings"
	"testing"

	"github.com/kardiachain/go-kardia/kai/state"
	kaidb "github.com/kardiachain/go-kardia/kai/storage"
	"github.com/kardiachain/go-kardia/kvm/sample_kvm"
	"github.com/kardiachain/go-kardia/lib/abi"
	"github.com/kardiachain/go-kardia/lib/common"
	"github.com/kardiachain/go-kardia/lib/log"
	"math"
)

// This test contains all the test cases for interfaces of the exchange V2 which allows order book and partial matching
// Please find the solidity source code at go-kardia/kvm/smc/ExchangeV2.sol
var code = common.Hex2Bytes("6080604052600436106100a35763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416631112f83681146100a85780631d216962146101fd57806342e11635146102cb5780637fb06000146103745780638e4a2404146103e6578063955982b81461044857806399a1523f1461056f578063aab991d314610606578063c9d0633d1461069d578063fa57983d14610774575b600080fd5b3480156100b457600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526101fb94369492936024939284019190819084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a99988101979196509182019450925082915084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a99988101979196509182019450925082915084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a99988101979196509182019450925082915084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a99988101979196509182019450925082915084018382808284375094975050933594506107cd9350505050565b005b34801561020957600080fd5b506040805160206004803580820135601f8101849004840285018401909552848452610256943694929360249392840191908190840183828082843750949750610e369650505050505050565b6040805160208082528351818301528351919283929083019185019080838360005b83811015610290578181015183820152602001610278565b50505050905090810190601f1680156102bd5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3480156102d757600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526103249436949293602493928401919081908401838280828437509497506113bf9650505050505050565b60408051602080825283518183015283519192839290830191858101910280838360005b83811015610360578181015183820152602001610348565b505050509050019250505060405180910390f35b34801561038057600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526103cd9436949293602493928401919081908401838280828437509497506115cb9650505050505050565b6040805192835260208301919091528051918290030190f35b3480156103f257600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526101fb94369492936024939284019190819084018382808284375094975050843595505050602090920135915061169d9050565b34801561045457600080fd5b506040805160206004803580820135601f810184900484028501840190955284845261055d94369492936024939284019190819084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a99988101979196509182019450925082915084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a99988101979196509182019450925082915084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a99988101979196509182019450925082915084018382808284375094975050933594506117299350505050565b60408051918252519081900360200190f35b34801561057b57600080fd5b506040805160206004803580820135601f810184900484028501840190955284845261025694369492936024939284019190819084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a9998810197919650918201945092508291508401838280828437509497506121729650505050505050565b34801561061257600080fd5b506040805160206004803580820135601f810184900484028501840190955284845261025694369492936024939284019190819084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a9998810197919650918201945092508291508401838280828437509497506128a99650505050505050565b3480156106a957600080fd5b506040805160206004803580820135601f810184900484028501840190955284845261025694369492936024939284019190819084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a99988101979196509182019450925082915084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a9998810197919650918201945092508291508401838280828437509497505093359450612d4f9350505050565b34801561078057600080fd5b506040805160206004803580820135601f810184900484028501840190955284845261025694369492936024939284019190819084018382808284375094975061352b9650505050505050565b6107d56149de565b60008060006107e26149f5565b60006107ed8c61379d565b95506001886040518082805190602001908083835b602083106108215780518252601f199092019160209182019101610802565b51815160209384036101000a600019018019909216911617905292019485525060405193849003019092206008015460ff16159150610861905057610e28565b6020860151158061087157508551155b1561087b57610e28565b85516020870151880281151561088d57fe5b049450610120604051908101604052808d81526020018b81526020018a815260200189815260200188815260200186815260200188815260200160008152602001600115158152509150600060028c6040518082805190602001908083835b6020831061090b5780518252601f1990920191602091820191016108ec565b51815160209384036101000a600019018019909216911617905292019485525060405193849003019092205492909211159150610ab2905057610a78888d8d60028f6040518082805190602001908083835b6020831061097c5780518252601f19909201916020918201910161095d565b51815160209384036101000a60001901801990921691161790529201948552506040805194859003820185208054808402870184019092528186529350915060009084015b82821015610a6c5760008481526020908190208301805460408051601f6002600019610100600187161502019094169390930492830185900485028101850190915281815292830182828015610a585780601f10610a2d57610100808354040283529160200191610a58565b820191906000526020600020905b815481529060010190602001808311610a3b57829003601f168201915b5050505050815260200190600101906109c1565b505050508a8a8f61381e565b90945092506000831115610ab257602086015186518402811515610a9857fe5b04870360c083018190521515610ab257610ab2888d613eba565b5060005b8354811015610c0e576000886040518082805190602001908083835b60208310610af15780518252601f199092019160209182019101610ad2565b51815160209384036101000a60001901801990921691161790529201948552506040519384900301909220865490925086915083908110610b2e57fe5b6000918252602080832084546001818101808855968652929094206006938402909101805490949093020191610b7c9183918591600261010091831615919091026000190190911604614a44565b5060018201816001019080546001816001161561010002031660029004610ba4929190614a44565b5060028281018054610bc9928481019291600019610100600183161502011604614a44565b5060038201816003019080546001816001161561010002031660029004610bf1929190614a44565b506004828101549082015560059182015491015550600101610ab6565b816001896040518082805190602001908083835b60208310610c415780518252601f199092019160209182019101610c22565b51815160209384036101000a6000190180199092169116179052920194855250604051938490038101909320845180519194610c8294508593500190614ac9565b506020828101518051610c9b9260018501920190614ac9565b5060408201518051610cb7916002840191602090910190614ac9565b5060608201518051610cd3916003840191602090910190614ac9565b506080820151600482015560a0820151600582015560c0820151600682015560e08201516007820155610100909101516008909101805460ff19169115159190911790556040518c516002918e91819060208401908083835b60208310610d4b5780518252601f199092019160209182019101610d2c565b51815160209384036101000a60001901801990921691161790529201948552506040519384900381019093208054600181018083556000928352918590208d519295610d9e9550910192508c0190614ac9565b505060048a6040518082805190602001908083835b60208310610dd25780518252601f199092019160209182019101610db3565b51815160209384036101000a60001901801990921691161790529201948552506040519384900381019093208054600181018083556000928352918590208d519295610e259550910192508c0190614ac9565b50505b505050505050505050505050565b6060806000606060006002866040518082805190602001908083835b60208310610e715780518252601f199092019160209182019101610e52565b51815160209384036101000a60001901801990921691161790529201948552506040805194859003820185208054808402870184019092528186529350915060009084015b82821015610f615760008481526020908190208301805460408051601f6002600019610100600187161502019094169390930492830185900485028101850190915281815292830182828015610f4d5780601f10610f2257610100808354040283529160200191610f4d565b820191906000526020600020905b815481529060010190602001808311610f3057829003601f168201915b505050505081526020019060010190610eb6565b505050509350835192508260001415610f8a5760408051602081019091526000815294506113b6565b5050604080516020810190915260008082525b828110156113b2578015156112d0576112c960018583815181101515610fbf57fe5b906020019060200201516040518082805190602001908083835b60208310610ff85780518252601f199092019160209182019101610fd9565b518151600019602094850361010090810a820192831692199390931691909117909252949092019687526040805197889003820188208054610140601f60026001841615909902909601909116969096049384018390049092028801850190526101208701828152909550869450928592508401828280156110bb5780601f10611090576101008083540402835291602001916110bb565b820191906000526020600020905b81548152906001019060200180831161109e57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561115d5780601f106111325761010080835404028352916020019161115d565b820191906000526020600020905b81548152906001019060200180831161114057829003601f168201915b5050509183525050600282810180546040805160206001841615610100026000190190931694909404601f810183900483028501830190915280845293810193908301828280156111ef5780601f106111c4576101008083540402835291602001916111ef565b820191906000526020600020905b8154815290600101906020018083116111d257829003601f168201915b505050918352505060038201805460408051602060026001851615610100026000190190941693909304601f81018490048402820184019092528181529382019392918301828280156112835780601f1061125857610100808354040283529160200191611283565b820191906000526020600020905b81548152906001019060200180831161126657829003601f168201915b50505091835250506004820154602082015260058201546040820152600682015460608201526007820154608082015260089091015460ff16151560a0909101526142d4565b91506113aa565b816112e460018684815181101515610fbf57fe5b6040516020018083805190602001908083835b602083106113165780518252601f1990920191602091820191016112f7565b6001836020036101000a0380198251168184511680821785525050505050509050018060fa60020a601f0281525060010182805190602001908083835b602083106113725780518252601f199092019160209182019101611353565b6001836020036101000a0380198251168184511680821785525050505050509050019250505060405160208183030381529060405291505b600101610f9d565b8194505b50505050919050565b60608060006002846040518082805190602001908083835b602083106113f65780518252601f1990920191602091820191016113d7565b51815160209384036101000a60001901801990921691161790529201948552506040805194859003820185208054808402870184019092528186529350915060009084015b828210156114e65760008481526020908190208301805460408051601f60026000196101006001871615020190941693909304928301859004850281018501909152818152928301828280156114d25780601f106114a7576101008083540402835291602001916114d2565b820191906000526020600020905b8154815290600101906020018083116114b557829003601f168201915b50505050508152602001906001019061143b565b505060408051600a80825261016082019092529395509150506020820161014080388339019050509250600090505b81518110156115c457600a8110156115bc576001828281518110151561153757fe5b906020019060200201516040518082805190602001908083835b602083106115705780518252601f199092019160209182019101611551565b51815160209384036101000a60001901801990921691161790529201948552506040519384900301909220600501548551909250859150839081106115b157fe5b602090810290910101525b600101611515565b5050919050565b6000806003836040518082805190602001908083835b602083106116005780518252601f1990920191602091820191016115e1565b51815160209384036101000a60001901801990921691161790529201948552506040519384900381018420548751909460039450889350918291908401908083835b602083106116615780518252601f199092019160209182019101611642565b51815160209384036101000a60001901801990921691161790529201948552506040519384900301909220600101549296929550919350505050565b6040805190810160405280838152602001828152506003846040518082805190602001908083835b602083106116e45780518252601f1990920191602091820191016116c5565b51815160209384036101000a60001901801990921691161790529201948552506040519384900381019093208451815593909201516001909301929092555050505050565b6000806000806000808a6040518082805190602001908083835b602083106117625780518252601f199092019160209182019101611743565b51815160209384036101000a600019018019909216911617905292019485525060405193849003019092208054909650151591506117a590505760009450612165565b600092505b83548310156121655783838154811015156117c157fe5b906000526020600020906006020160010160405160200180828054600181600116156101000203166002900480156118305780601f1061180e576101008083540402835291820191611830565b820191906000526020600020905b81548152906001019060200180831161181c575b50509150506040516020818303038152906040526040518082805190602001908083835b602083106118735780518252601f199092019160209182019101611854565b51815160209384036101000a60001901801990921691161790526040519190930181900381208d519095508d9450908301928392508401908083835b602083106118ce5780518252601f1990920191602091820191016118af565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083106119315780518252601f199092019160209182019101611912565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916148015611b1b5750838381548110151561197857fe5b906000526020600020906006020160020160405160200180828054600181600116156101000203166002900480156119e75780601f106119c55761010080835404028352918201916119e7565b820191906000526020600020905b8154815290600101906020018083116119d3575b50509150506040516020818303038152906040526040518082805190602001908083835b60208310611a2a5780518252601f199092019160209182019101611a0b565b51815160209384036101000a60001901801990921691161790526040519190930181900381208c519095508c9450908301928392508401908083835b60208310611a855780518252601f199092019160209182019101611a66565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b60208310611ae85780518252601f199092019160209182019101611ac9565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916145b8015611b4557508383815481101515611b3057fe5b90600052602060002090600602016004015486145b1561215a57888484815481101515611b5957fe5b90600052602060002090600602016003019080519060200190611b7d929190614ac9565b5060018484815481101515611b8e57fe5b9060005260206000209060060201600501819055508383815481101515611bb157fe5b90600052602060002090600602016000019150600080836040518082805460018160011615610100020316600290048015611c235780601f10611c01576101008083540402835291820191611c23565b820191906000526020600020905b815481529060010190602001808311611c0f575b5050928352505060405190819003602001902054111561215a575060005b6000826040518082805460018160011615610100020316600290048015611c9f5780601f10611c7d576101008083540402835291820191611c9f565b820191906000526020600020905b815481529060010190602001808311611c8b575b505092835250506040519081900360200190205481101561215a57866040516020018082805190602001908083835b60208310611ced5780518252601f199092019160209182019101611cce565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b60208310611d505780518252601f199092019160209182019101611d31565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040518091039020600019166000836040518082805460018160011615610100020316600290048015611ddf5780601f10611dbd576101008083540402835291820191611ddf565b820191906000526020600020905b815481529060010190602001808311611dcb575b50509283525050604051908190036020019020805483908110611dfe57fe5b90600052602060002090600602016002016040516020018082805460018160011615610100020316600290048015611e6d5780601f10611e4b576101008083540402835291820191611e6d565b820191906000526020600020905b815481529060010190602001808311611e59575b50509150506040516020818303038152906040526040518082805190602001908083835b60208310611eb05780518252601f199092019160209182019101611e91565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916148015611f7b5750856000836040518082805460018160011615610100020316600290048015611f485780601f10611f26576101008083540402835291820191611f48565b820191906000526020600020905b815481529060010190602001808311611f34575b50509283525050604051908190036020019020805483908110611f6757fe5b906000526020600020906006020160040154145b801561201557506000826040518082805460018160011615610100020316600290048015611fe05780601f10611fbe576101008083540402835291820191611fe0565b820191906000526020600020905b815481529060010190602001808311611fcc575b50509283525050604051908190036020019020805482908110611fff57fe5b9060005260206000209060060201600501546000145b15612152578860008360405180828054600181600116156101000203166002900480156120795780601f10612057576101008083540402835291820191612079565b820191906000526020600020905b815481529060010190602001808311612065575b5050928352505060405190819003602001902080548390811061209857fe5b906000526020600020906006020160030190805190602001906120bc929190614ac9565b506001600083604051808280546001816001161561010002031660029004801561211d5780601f106120fb57610100808354040283529182019161211d565b820191906000526020600020905b815481529060010190602001808311612109575b5050928352505060405190819003602001902080548390811061213c57fe5b9060005260206000209060060201600501819055505b600101611c41565b6001909201916117aa565b5050505095945050505050565b606080600080856040518082805190602001908083835b602083106121a85780518252601f199092019160209182019101612189565b51815160209384036101000a60001901801990921691161790529201948552506040805194859003820185208054808402870184019092528186529350915060009084015b8282101561248a5760008481526020908190206040805160068602909201805460026001821615610100026000190190911604601f8101859004909402830160e090810190925260c08301848152929390928492909184918401828280156122965780601f1061226b57610100808354040283529160200191612296565b820191906000526020600020905b81548152906001019060200180831161227957829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156123385780601f1061230d57610100808354040283529160200191612338565b820191906000526020600020905b81548152906001019060200180831161231b57829003601f168201915b5050509183525050600282810180546040805160206001841615610100026000190190931694909404601f810183900483028501830190915280845293810193908301828280156123ca5780601f1061239f576101008083540402835291602001916123ca565b820191906000526020600020905b8154815290600101906020018083116123ad57829003601f168201915b505050918352505060038201805460408051602060026001851615610100026000190190941693909304601f810184900484028201840190925281815293820193929183018282801561245e5780601f106124335761010080835404028352916020019161245e565b820191906000526020600020905b81548152906001019060200180831161244157829003601f168201915b5050505050815260200160048201548152602001600582015481525050815260200190600101906121ed565b5050505091508151600014156124b05760408051602081019091526000815292506128a1565b5060005b81518110156128a157836040516020018082805190602001908083835b602083106124f05780518252601f1990920191602091820191016124d1565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083106125535780518252601f199092019160209182019101612534565b5181516020939093036101000a600019018019909116921691909117905260405192018290039091208551909350859250849150811061258f57fe5b90602001906020020151602001516040516020018082805190602001908083835b602083106125cf5780518252601f1990920191602091820191016125b0565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083106126325780518252601f199092019160209182019101612613565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916141561289957604080516000815260208101918290528051909190819081908082805b602083106126a55780518252601f199092019160209182019101612686565b51815160209384036101000a60001901801990921691161790526040519190930181900381208851909550889450908301928392508401908083835b602083106127005780518252601f1990920191602091820191016126e1565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083106127635780518252601f199092019160209182019101612744565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191614156127c1576127ba82828151811015156127ab57fe5b90602001906020020151614632565b9250612899565b826127d383838151811015156127ab57fe5b6040516020018083805190602001908083835b602083106128055780518252601f1990920191602091820191016127e6565b6001836020036101000a0380198251168184511680821785525050505050509050018060fa60020a601f0281525060010182805190602001908083835b602083106128615780518252601f199092019160209182019101612842565b6001836020036101000a0380198251168184511680821785525050505050509050019250505060405160208183030381529060405292505b6001016124b4565b505092915050565b606080600060606000806004886040518082805190602001908083835b602083106128e55780518252601f1990920191602091820191016128c6565b51815160209384036101000a60001901801990921691161790529201948552506040805194859003820185208054808402870184019092528186529350915060009084015b828210156129d55760008481526020908190208301805460408051601f60026000196101006001871615020190941693909304928301859004850281018501909152818152928301828280156129c15780601f10612996576101008083540402835291602001916129c1565b820191906000526020600020905b8154815290600101906020018083116129a457829003601f168201915b50505050508152602001906001019061292a565b5050505094508451935083600014156129fe576040805160208101909152600081529550612d44565b60206040519081016040528060008152509250866040516020018082805190602001908083835b60208310612a445780518252601f199092019160209182019101612a25565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b60208310612aa75780518252601f199092019160209182019101612a88565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390209150600090505b83811015612d405784518290600190879084908110612af657fe5b906020019060200201516040518082805190602001908083835b60208310612b2f5780518252601f199092019160209182019101612b10565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206000016040516020018082805460018160011615610100020316600290048015612bc35780601f10612ba1576101008083540402835291820191612bc3565b820191906000526020600020905b815481529060010190602001808311612baf575b50509150506040516020818303038152906040526040518082805190602001908083835b60208310612c065780518252601f199092019160209182019101612be7565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040518091039020600019161415612d3857801515612c5e57612c5760018683815181101515610fbf57fe5b9250612d38565b82612c7260018784815181101515610fbf57fe5b6040516020018083805190602001908083835b60208310612ca45780518252601f199092019160209182019101612c85565b6001836020036101000a0380198251168184511680821785525050505050509050018060fa60020a601f0281525060010182805190602001908083835b60208310612d005780518252601f199092019160209182019101612ce1565b6001836020036101000a0380198251168184511680821785525050505050509050019250505060405160208183030381529060405292505b600101612adb565b8295505b505050505092915050565b6060806000612d5c6149f5565b6002886040518082805190602001908083835b60208310612d8e5780518252601f199092019160209182019101612d6f565b51815160209384036101000a60001901801990921691161790529201948552506040805194859003820185208054808402870184019092528186529350915060009084015b82821015612e7e5760008481526020908190208301805460408051601f6002600019610100600187161502019094169390930492830185900485028101850190915281815292830182828015612e6a5780601f10612e3f57610100808354040283529160200191612e6a565b820191906000526020600020905b815481529060010190602001808311612e4d57829003601f168201915b505050505081526020019060010190612dd3565b505050509250600091505b825182101561350e5760018383815181101515612ea257fe5b906020019060200201516040518082805190602001908083835b60208310612edb5780518252601f199092019160209182019101612ebc565b518151600019602094850361010090810a820192831692199390931691909117909252949092019687526040805197889003820188208054610140601f6002600184161590990290960190911696909604938401839004909202880185019052610120870182815290955086945092859250840182828015612f9e5780601f10612f7357610100808354040283529160200191612f9e565b820191906000526020600020905b815481529060010190602001808311612f8157829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156130405780601f1061301557610100808354040283529160200191613040565b820191906000526020600020905b81548152906001019060200180831161302357829003601f168201915b5050509183525050600282810180546040805160206001841615610100026000190190931694909404601f810183900483028501830190915280845293810193908301828280156130d25780601f106130a7576101008083540402835291602001916130d2565b820191906000526020600020905b8154815290600101906020018083116130b557829003601f168201915b505050918352505060038201805460408051602060026001851615610100026000190190941693909304601f81018490048402820184019092528181529382019392918301828280156131665780601f1061313b57610100808354040283529160200191613166565b820191906000526020600020905b81548152906001019060200180831161314957829003601f168201915b50505050508152602001600482015481526020016005820154815260200160068201548152602001600782015481526020016008820160009054906101000a900460ff1615151515815250509050866040516020018082805190602001908083835b602083106131e75780518252601f1990920191602091820191016131c8565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b6020831061324a5780518252601f19909201916020918201910161322b565b51815160209384036101000a60001901801990921691161790526040519190930181900381208684015180519196509450908301928392508401908083835b602083106132a85780518252601f199092019160209182019101613289565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b6020831061330b5780518252601f1990920191602091820191016132ec565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040518091039020600019161480156134d05750856040516020018082805190602001908083835b602083106133775780518252601f199092019160209182019101613358565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083106133da5780518252601f1990920191602091820191016133bb565b51815160209384036101000a600019018019909216911617905260408051929094018290038220938701518051949650945090810192839250908401908083835b6020831061343a5780518252601f19909201916020918201910161341b565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b6020831061349d5780518252601f19909201916020918201910161347e565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916145b80156134df5750848160800151145b156135035782828151811015156134f257fe5b906020019060200201519350613520565b600190910190612e89565b60408051602081019091526000815293505b505050949350505050565b6060806000606060006004866040518082805190602001908083835b602083106135665780518252601f199092019160209182019101613547565b51815160209384036101000a60001901801990921691161790529201948552506040805194859003820185208054808402870184019092528186529350915060009084015b828210156136565760008481526020908190208301805460408051601f60026000196101006001871615020190941693909304928301859004850281018501909152818152928301828280156136425780601f1061361757610100808354040283529160200191613642565b820191906000526020600020905b81548152906001019060200180831161362557829003601f168201915b5050505050815260200190600101906135ab565b50505050935083519250826000141561367f5760408051602081019091526000815294506113b6565b5050604080516020810190915260008082525b828110156113b2578015156136bb576136b460018583815181101515610fbf57fe5b9150613795565b816136cf60018684815181101515610fbf57fe5b6040516020018083805190602001908083835b602083106137015780518252601f1990920191602091820191016136e2565b6001836020036101000a0380198251168184511680821785525050505050509050018060fa60020a601f0281525060010182805190602001908083835b6020831061375d5780518252601f19909201916020918201910161373e565b6001836020036101000a0380198251168184511680821785525050505050509050019250505060405160208183030381529060405291505b600101613692565b6137a56149de565b6003826040518082805190602001908083835b602083106137d75780518252601f1990920191602091820191016137b8565b51815160209384036101000a600019018019909216911617905292019485525060408051948590038201852085820190915280548552600101549084015250909392505050565b60008060008061382c614b37565b6000613836614b37565b600094505b8a518510801561384a57508886105b15613ea95760018b8681518110151561385f57fe5b906020019060200201516040518082805190602001908083835b602083106138985780518252601f199092019160209182019101613879565b51815160209384036101000a60001901801990921691161790529201948552506040519384900301909220600601548b1191506138d790505788613953565b60018b868151811015156138e757fe5b906020019060200201516040518082805190602001908083835b602083106139205780518252601f199092019160209182019101613901565b51815160209384036101000a60001901801990921691161790529201948552506040519384900301909220600601549150505b93506000841115613e9e5760c0604051908101604052808f81526020018e8152602001898152602001602060405190810160405280600081525081526020018581526020016000815250925086839080600181540180825580915050906001820390600052602060002090600602016000909192909190915060008201518160000190805190602001906139e8929190614ac9565b506020828101518051613a019260018501920190614ac9565b5060408201518051613a1d916002840191602090910190614ac9565b5060608201518051613a39916003840191602090910190614ac9565b506080820151600482015560a0909101516005909101555060208a01518a518502811515613a6357fe5b0491508360018c87815181101515613a7757fe5b906020019060200201516040518082805190602001908083835b60208310613ab05780518252601f199092019160209182019101613a91565b51815160209384036101000a6000190180199092169116179052920194855250604051938490030190922060060180549390930390925550508a516001908c9087908110613afa57fe5b906020019060200201516040518082805190602001908083835b60208310613b335780518252601f199092019160209182019101613b14565b51815160209384036101000a600019018019909216911617905292019485525060405193849003019092206006015415159150613b8d905057613b8d8b86815181101515613b7d57fe5b906020019060200201518d613eba565b60c0604051908101604052808c87815181101515613ba757fe5b9060200190602002015181526020018d815260200160018d88815181101515613bcc57fe5b906020019060200201516040518082805190602001908083835b60208310613c055780518252601f199092019160209182019101613be6565b518151600019602094850361010090810a8201928316921993909316919091179092529490920196875260408051978890038201882060029081018054601f600182161590980290950190941604948501829004820288018201905283875290945091925050830182828015613cbc5780601f10613c9157610100808354040283529160200191613cbc565b820191906000526020600020905b815481529060010190602001808311613c9f57829003601f168201915b50505050508152602001602060405190810160405280600081525081526020018381526020016000815250905060008b86815181101515613cf957fe5b906020019060200201516040518082805190602001908083835b60208310613d325780518252601f199092019160209182019101613d13565b51815160209384036101000a600019018019909216911617905292019485525060405193849003810190932080546001810180835560009283529185902086518051939688965060069093029091019350613d939284929190910190614ac9565b506020828101518051613dac9260018501920190614ac9565b5060408201518051613dc8916002840191602090910190614ac9565b5060608201518051613de4916003840191602090910190614ac9565b506080820151600482015560a0909101516005909101555086546001810180895560008981526020908190208451805193948694600690910290920192613e3092849290910190614ac9565b506020828101518051613e499260018501920190614ac9565b5060408201518051613e65916002840191602090910190614ac9565b5060608201518051613e81916003840191602090910190614ac9565b506080820151600482015560a09091015160059091015550948301945b60019094019361383b565b505050505097509795505050505050565b60008060006002846040518082805190602001908083835b60208310613ef15780518252601f199092019160209182019101613ed2565b51815160209384036101000a60001901801990921691161790529201948552506040519384900381018420548951909750899482019350839250908401908083835b60208310613f525780518252601f199092019160209182019101613f33565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b60208310613fb55780518252601f199092019160209182019101613f96565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902091505b828110156142cd5781600019166002856040518082805190602001908083835b602083106140245780518252601f199092019160209182019101614005565b51815160209384036101000a600019018019909216911617905292019485525060405193849003019092208054909250849150811061405f57fe5b9060005260206000200160405160200180828054600181600116156101000203166002900480156140c75780601f106140a55761010080835404028352918201916140c7565b820191906000526020600020905b8154815290600101906020018083116140b3575b50509150506040516020818303038152906040526040518082805190602001908083835b6020831061410a5780518252601f1990920191602091820191016140eb565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191614156142c5576002846040518082805190602001908083835b602083106141735780518252601f199092019160209182019101614154565b51815160209384036101000a60001901801990921691161790529201948552506040519384900301909220805490925085915081106141ae57fe5b906000526020600020016002856040518082805190602001908083835b602083106141ea5780518252601f1990920191602091820191016141cb565b51815160209384036101000a600019018019909216911617905292019485525060405193849003019092208054909250849150811061422557fe5b90600052602060002001908054600181600116156101000203166002900461424e929190614a44565b506002846040518082805190602001908083835b602083106142815780518252601f199092019160209182019101614262565b51815160001960209485036101000a810191821691199290921617909152939091019586526040519586900301909420805494506142c3935091508301614b6e565b505b600101613fe5565b5050505050565b60006101008201526060808080806142ef86608001516148c4565b93506142fe8660a001516148c4565b925061430d8660e001516148c4565b915061431c8660c001516148c4565b90508560000151866020015187604001518860600151878786886040516020018089805190602001908083835b602083106143685780518252601f199092019160209182019101614349565b6001836020036101000a0380198251168184511680821785525050505050509050018060f860020a603b0281525060010188805190602001908083835b602083106143c45780518252601f1990920191602091820191016143a5565b6001836020036101000a0380198251168184511680821785525050505050509050018060f860020a603b0281525060010187805190602001908083835b602083106144205780518252601f199092019160209182019101614401565b6001836020036101000a0380198251168184511680821785525050505050509050018060f860020a603b0281525060010186805190602001908083835b6020831061447c5780518252601f19909201916020918201910161445d565b6001836020036101000a0380198251168184511680821785525050505050509050018060f860020a603b0281525060010185805190602001908083835b602083106144d85780518252601f1990920191602091820191016144b9565b6001836020036101000a0380198251168184511680821785525050505050509050018060f860020a603b0281525060010184805190602001908083835b602083106145345780518252601f199092019160209182019101614515565b6001836020036101000a0380198251168184511680821785525050505050509050018060f860020a603b0281525060010183805190602001908083835b602083106145905780518252601f199092019160209182019101614571565b6001836020036101000a0380198251168184511680821785525050505050509050018060f860020a603b0281525060010182805190602001908083835b602083106145ec5780518252601f1990920191602091820191016145cd565b6001836020036101000a03801982511681845116808217855250505050505090500198505050505050505050604051602081830303815290604052945050505050919050565b606080606061464484608001516148c4565b91506146538460a001516148c4565b9050836000015184602001518560400151866060015185856040516020018087805190602001908083835b6020831061469d5780518252601f19909201916020918201910161467e565b6001836020036101000a038019825116818451168082178552505050505050905001807f3a0000000000000000000000000000000000000000000000000000000000000081525060010186805190602001908083835b602083106147125780518252601f1990920191602091820191016146f3565b6001836020036101000a0380198251168184511680821785525050505050509050018060f860020a603b0281525060010185805190602001908083835b6020831061476e5780518252601f19909201916020918201910161474f565b6001836020036101000a0380198251168184511680821785525050505050509050018060f860020a603b0281525060010184805190602001908083835b602083106147ca5780518252601f1990920191602091820191016147ab565b6001836020036101000a0380198251168184511680821785525050505050509050018060f860020a603b0281525060010183805190602001908083835b602083106148265780518252601f199092019160209182019101614807565b6001836020036101000a0380198251168184511680821785525050505050509050018060f860020a603b0281525060010182805190602001908083835b602083106148825780518252601f199092019160209182019101614863565b6001836020036101000a038019825116818451168082178552505050505050905001965050505050505060405160208183030381529060405292505050919050565b6060600080828185151561490d5760408051808201909152600181527f3000000000000000000000000000000000000000000000000000000000000000602082015294506113b6565b8593505b831561492857600190920191600a84049350614911565b826040519080825280601f01601f191660200182016040528015614956578160200160208202803883390190505b5091505060001982015b85156113b25781516000198201917f01000000000000000000000000000000000000000000000000000000000000006030600a8a0601029184919081106149a357fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350600a86049550614960565b604080518082019091526000808252602082015290565b6101206040519081016040528060608152602001606081526020016060815260200160608152602001600081526020016000815260200160008152602001600081526020016000151581525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10614a7d5780548555614ab9565b82800160010185558215614ab957600052602060002091601f016020900482015b82811115614ab9578254825591600101919060010190614a9e565b50614ac5929150614b97565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10614b0a57805160ff1916838001178555614ab9565b82800160010185558215614ab9579182015b82811115614ab9578251825591602001919060010190614b1c565b60c0604051908101604052806060815260200160608152602001606081526020016060815260200160008152602001600081525090565b815481835581811115614b9257600083815260209020614b92918101908301614bb4565b505050565b614bb191905b80821115614ac55760008155600101614b9d565b90565b614bb191905b80821115614ac5576000614bce8282614bd7565b50600101614bba565b50805460018160011615610100020316600290046000825580601f10614bfd5750614c1b565b601f016020900490600052602060002090810190614c1b9190614b97565b505600a165627a7a72305820b949baee1c4ce553bde2cf60e8452a104aea01dcf5655fde497c5b5ba1e514600029")
var definition = `[
	{
		"constant": false,
		"inputs": [
			{
				"name": "srcPair",
				"type": "string"
			},
			{
				"name": "destPair",
				"type": "string"
			},
			{
				"name": "srcAddress",
				"type": "string"
			},
			{
				"name": "destAddress",
				"type": "string"
			},
			{
				"name": "originalTxId",
				"type": "string"
			},
			{
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "matchOrder",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "getOrderBook",
		"outputs": [
			{
				"name": "orderBook",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "getMatchableAmount",
		"outputs": [
			{
				"name": "amounts",
				"type": "uint256[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "getRatePublic",
		"outputs": [
			{
				"name": "sale",
				"type": "uint256"
			},
			{
				"name": "receive",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "pair",
				"type": "string"
			},
			{
				"name": "sale_amount",
				"type": "uint256"
			},
			{
				"name": "receiveAmount",
				"type": "uint256"
			}
		],
		"name": "addRate",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "originalTxId",
				"type": "string"
			},
			{
				"name": "releaseTxId",
				"type": "string"
			},
			{
				"name": "pair",
				"type": "string"
			},
			{
				"name": "receiveAddress",
				"type": "string"
			},
			{
				"name": "releaseAmount",
				"type": "uint256"
			}
		],
		"name": "completeOrder",
		"outputs": [
			{
				"name": "success",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "originalTxId",
				"type": "string"
			},
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "getReleaseByTxId",
		"outputs": [
			{
				"name": "releaseInfos",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "addr",
				"type": "string"
			},
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "getOrderHistoryByPair",
		"outputs": [
			{
				"name": "orderHistory",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "sourcePair",
				"type": "string"
			},
			{
				"name": "fromAddress",
				"type": "string"
			},
			{
				"name": "toAddress",
				"type": "string"
			},
			{
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "getOrderId",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "addr",
				"type": "string"
			}
		],
		"name": "getOrderHistory",
		"outputs": [
			{
				"name": "orderHistory",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"name": "pair",
				"type": "string"
			},
			{
				"indexed": true,
				"name": "addr",
				"type": "string"
			},
			{
				"indexed": false,
				"name": "matchOrderId",
				"type": "string"
			},
			{
				"indexed": false,
				"name": "_value",
				"type": "uint256"
			}
		],
		"name": "Release",
		"type": "event"
	}
]`

func TestGetOrderBook(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(kaidb.NewMemStore()))
	address := common.HexToAddress("0x0a")
	state.SetCode(address, code)
	abi, err := abi.JSON(strings.NewReader(definition))
	if err != nil {
		t.Fatal(err)
	}
	getRateInput, e1 := abi.Pack("getRatePublic", "ETH-NEO")
	if e1 != nil {
		t.Fatal(e1)
	}
	// Now we add rate for ETH-NEO first
	setRateInput, e2 := abi.Pack("addRate", "ETH-NEO", big.NewInt(1), big.NewInt(10))
	if e2 != nil {
		t.Fatal(e2)
	}
	_, _, e3 := sample_kvm.Call(address, setRateInput, &sample_kvm.Config{State: state})
	if e3 != nil {
		t.Fatal(e3)
	}
	rateResult, _, errCallRate := sample_kvm.Call(address, getRateInput, &sample_kvm.Config{State: state})
	if errCallRate != nil {
		t.Fatal(errCallRate)
	}
	var rateStruct struct {
		Sale    *big.Int `abi:"sale"`
		Receive *big.Int `abi:"receive"`
	}

	// Call get rate for ETH-NEO to check if we set it correctly
	e5 := abi.Unpack(&rateStruct, "getRatePublic", rateResult)
	if e5 != nil {
		t.Fatal(e5)
	}
	if rateStruct.Sale.Cmp(big.NewInt(1)) != 0 || rateStruct.Receive.Cmp(big.NewInt(10)) != 0 {
		t.Error("Error get value, expected 1, 10 got ", rateStruct.Sale.String(), rateStruct.Receive.String())
	}

	// Now we add rate for NEO-ETH to start matching orders
	setRateInput2, e6 := abi.Pack("addRate", "NEO-ETH", big.NewInt(10), big.NewInt(1))
	if e6 != nil {
		t.Fatal(e6)
	}
	_, _, e7 := sample_kvm.Call(address, setRateInput2, &sample_kvm.Config{State: state})
	if e7 != nil {
		t.Fatal(e7)
	}
	originalEthTxId := "ethtxid1"
	// Start matching 1 eth for 10 neo
	matchInput1, e8 := abi.Pack("matchOrder", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver1", originalEthTxId, big.NewInt(1))
	if e8 != nil {
		t.Fatal(e8)
	}
	_, _, e9 := sample_kvm.Call(address, matchInput1, &sample_kvm.Config{State: state})
	if e9 != nil {
		t.Fatal(e9)
	}
	// Now we get order list of eth - neo
	getOrderInput, e10 := abi.Pack("getOrderBook", "ETH-NEO")
	if e10 != nil {
		t.Fatal(e10)
	}
	orderBookResult,_, e11 := sample_kvm.Call(address, getOrderInput, &sample_kvm.Config{State: state})
	if e11 != nil {
		t.Fatal(e11)
	}
	var orders struct {
		OrderBook string
	}
	e12 := abi.Unpack(&orders, "getOrderBook", orderBookResult)
	if e12 != nil {
		t.Fatal(e12)
	}
	if orders.OrderBook != "ETH-NEO;ethsender1;neoReceiver1;ethtxid1;1;10;1;0" {
		t.Fatal("ETH-NEO;ethsender1;neoReceiver1;ethtxid1;1;10;1;0, got ", orders.OrderBook)
	}
	originalEthTxId2 := "ethtxid2"
	// Start matching 2 eth for 20 neo
	matchInput1, e8 = abi.Pack("matchOrder", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver2", originalEthTxId2, big.NewInt(2))
	if e8 != nil {
		t.Fatal(e8)
	}
	_, _, e9 = sample_kvm.Call(address, matchInput1, &sample_kvm.Config{State: state})
	if e9 != nil {
		t.Fatal(e9)
	}
	getOrderInput, e10 = abi.Pack("getOrderBook", "ETH-NEO")
	if e10 != nil {
		t.Fatal(e10)
	}
	orderBookResult,_, e11 = sample_kvm.Call(address, getOrderInput, &sample_kvm.Config{State: state})
	if e11 != nil {
		t.Fatal(e11)
	}
	e12 = abi.Unpack(&orders, "getOrderBook", orderBookResult)
	if e12 != nil {
		t.Fatal(e12)
	}
	if orders.OrderBook != "ETH-NEO;ethsender1;neoReceiver1;ethtxid1;1;10;1;0|ETH-NEO;ethsender1;neoReceiver2;ethtxid2;2;20;2;0" {
		t.Fatal("Expect ETH-NEO;ethsender1;neoReceiver1;ethtxid1;1;10;1;0|ETH-NEO;ethsender1;neoReceiver2;ethtxid2;2;20;2;0, got ", orders.OrderBook)
	}
}

func TestGetOrderHistory(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(kaidb.NewMemStore()))
	address := common.HexToAddress("0x0a")
	state.SetCode(address, code)
	abi, err := abi.JSON(strings.NewReader(definition))
	if err != nil {
		t.Fatal(err)
	}
	getRateInput, e1 := abi.Pack("getRatePublic", "ETH-NEO")
	if e1 != nil {
		t.Fatal(e1)
	}
	// Now we add rate for ETH-NEO first
	setRateInput, e2 := abi.Pack("addRate", "ETH-NEO", big.NewInt(1), big.NewInt(10))
	if e2 != nil {
		t.Fatal(e2)
	}
	_, _, e3 := sample_kvm.Call(address, setRateInput, &sample_kvm.Config{State: state})
	if e3 != nil {
		t.Fatal(e3)
	}
	rateResult, _, errCallRate := sample_kvm.Call(address, getRateInput, &sample_kvm.Config{State: state})
	if errCallRate != nil {
		t.Fatal(errCallRate)
	}
	var rateStruct struct {
		Sale    *big.Int `abi:"sale"`
		Receive *big.Int `abi:"receive"`
	}

	// Call get rate for ETH-NEO to check if we set it correctly
	e5 := abi.Unpack(&rateStruct, "getRatePublic", rateResult)
	if e5 != nil {
		t.Fatal(e5)
	}
	if rateStruct.Sale.Cmp(big.NewInt(1)) != 0 || rateStruct.Receive.Cmp(big.NewInt(10)) != 0 {
		t.Error("Error get value, expected 1, 10 got ", rateStruct.Sale.String(), rateStruct.Receive.String())
	}

	// Now we add rate for NEO-ETH to start matching orders
	setRateInput2, e6 := abi.Pack("addRate", "NEO-ETH", big.NewInt(10), big.NewInt(1))
	if e6 != nil {
		t.Fatal(e6)
	}
	_, _, e7 := sample_kvm.Call(address, setRateInput2, &sample_kvm.Config{State: state})
	if e7 != nil {
		t.Fatal(e7)
	}
	originalEthTxId := "ethtxid1"
	// Start matching 1 eth for 10 neo
	matchInput1, e8 := abi.Pack("matchOrder", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver1", originalEthTxId, big.NewInt(1))
	if e8 != nil {
		t.Fatal(e8)
	}
	_, _, e9 := sample_kvm.Call(address, matchInput1, &sample_kvm.Config{State: state})
	if e9 != nil {
		t.Fatal(e9)
	}

	originalEthTxId2 := "ethtxid2"
	// Start matching 2 eth for 20 neo
	matchInput1, e8 = abi.Pack("matchOrder", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver2", originalEthTxId2, big.NewInt(2))
	if e8 != nil {
		t.Fatal(e8)
	}
	_, _, e9 = sample_kvm.Call(address, matchInput1, &sample_kvm.Config{State: state})
	if e9 != nil {
		t.Fatal(e9)
	}
	getOrderInput, e10 := abi.Pack("getOrderHistoryByPair", "ethsender1", "ETH-NEO")
	if e10 != nil {
		t.Fatal(e10)
	}
	orderBookResult,_, e11 := sample_kvm.Call(address, getOrderInput, &sample_kvm.Config{State: state})
	if e11 != nil {
		t.Fatal(e11)
	}
	var orders struct {
		OrderHistory string
	}
	e12 := abi.Unpack(&orders, "getOrderHistoryByPair", orderBookResult)
	if e12 != nil {
		t.Fatal(e12)
	}
	if orders.OrderHistory != "ETH-NEO;ethsender1;neoReceiver1;ethtxid1;1;10;1;0|ETH-NEO;ethsender1;neoReceiver2;ethtxid2;2;20;2;0" {
		t.Fatal("Expect ETH-NEO;ethsender1;neoReceiver1;ethtxid1;1;10;1;0|ETH-NEO;ethsender1;neoReceiver2;ethtxid2;2;20;2;0, got ", orders.OrderHistory)
	}
}

func TestGetOrderBookDuplicateTxID(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(kaidb.NewMemStore()))
	address := common.HexToAddress("0x0a")
	state.SetCode(address, code)
	abi, err := abi.JSON(strings.NewReader(definition))
	if err != nil {
		t.Fatal(err)
	}
	getRateInput, e1 := abi.Pack("getRatePublic", "ETH-NEO")
	if e1 != nil {
		t.Fatal(e1)
	}
	// Now we add rate for ETH-NEO first
	setRateInput, e2 := abi.Pack("addRate", "ETH-NEO", big.NewInt(1), big.NewInt(10))
	if e2 != nil {
		t.Fatal(e2)
	}
	_, _, e3 := sample_kvm.Call(address, setRateInput, &sample_kvm.Config{State: state})
	if e3 != nil {
		t.Fatal(e3)
	}
	_, _, errCallRate := sample_kvm.Call(address, getRateInput, &sample_kvm.Config{State: state})
	if errCallRate != nil {
		t.Fatal(errCallRate)
	}
	// Now we add rate for NEO-ETH to start matching orders
	setRateInput2, e6 := abi.Pack("addRate", "NEO-ETH", big.NewInt(10), big.NewInt(1))
	if e6 != nil {
		t.Fatal(e6)
	}
	_, _, e7 := sample_kvm.Call(address, setRateInput2, &sample_kvm.Config{State: state})
	if e7 != nil {
		t.Fatal(e7)
	}
	originalEthTxId := "ethtxid1"
	// Start matching 1 eth for 10 neo
	matchInput1, e8 := abi.Pack("matchOrder", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver1", originalEthTxId, big.NewInt(1))
	if e8 != nil {
		t.Fatal(e8)
	}
	_, _, e9 := sample_kvm.Call(address, matchInput1, &sample_kvm.Config{State: state})
	if e9 != nil {
		t.Fatal(e9)
	}
	// Now we get order list of eth - neo
	getOrderInput, e10 := abi.Pack("getOrderBook", "ETH-NEO")
	if e10 != nil {
		t.Fatal(e10)
	}
	orderBookResult,_, e11 := sample_kvm.Call(address, getOrderInput, &sample_kvm.Config{State: state})
	if e11 != nil {
		t.Fatal(e11)
	}
	var orders struct {
		OrderBook string
	}
	e12 := abi.Unpack(&orders, "getOrderBook", orderBookResult)
	if e12 != nil {
		t.Fatal(e12)
	}
	if orders.OrderBook != "ETH-NEO;ethsender1;neoReceiver1;ethtxid1;1;10;1;0" {
		t.Fatal("ETH-NEO;ethsender1;neoReceiver1;ethtxid1;1;10;1;0, got ", orders.OrderBook)
	}
	// Start matching 2 eth for 20 neo with old txid
	matchInput1, e8 = abi.Pack("matchOrder", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver2", originalEthTxId, big.NewInt(2))
	if e8 != nil {
		t.Fatal(e8)
	}
	_, _, e9 = sample_kvm.Call(address, matchInput1, &sample_kvm.Config{State: state})
	if e9 != nil {
		t.Fatal(e9)
	}
	getOrderInput, e10 = abi.Pack("getOrderBook", "ETH-NEO")
	if e10 != nil {
		t.Fatal(e10)
	}
	orderBookResult,_, e11 = sample_kvm.Call(address, getOrderInput, &sample_kvm.Config{State: state})
	if e11 != nil {
		t.Fatal(e11)
	}
	e12 = abi.Unpack(&orders, "getOrderBook", orderBookResult)
	if e12 != nil {
		t.Fatal(e12)
	}
	// Order book should return only the first order
	if orders.OrderBook != "ETH-NEO;ethsender1;neoReceiver1;ethtxid1;1;10;1;0" {
		t.Fatal("Expect ETH-NEO;ethsender1;neoReceiver1;ethtxid1;1;10;1;0, got ", orders.OrderBook)
	}
}

func TestPartialMatching1(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(kaidb.NewMemStore()))
	address := common.HexToAddress("0x0a")
	state.SetCode(address, code)
	abi, err := abi.JSON(strings.NewReader(definition))
	if err != nil {
		t.Fatal(err)
	}
	getRateInput, e1 := abi.Pack("getRatePublic", "ETH-NEO")
	if e1 != nil {
		t.Fatal(e1)
	}
	// Now we add rate for ETH-NEO first
	setRateInput, e2 := abi.Pack("addRate", "ETH-NEO", big.NewInt(1), big.NewInt(10))
	if e2 != nil {
		t.Fatal(e2)
	}
	_, _, e3 := sample_kvm.Call(address, setRateInput, &sample_kvm.Config{State: state})
	if e3 != nil {
		t.Fatal(e3)
	}
	_, _, errCallRate := sample_kvm.Call(address, getRateInput, &sample_kvm.Config{State: state})
	if errCallRate != nil {
		t.Fatal(errCallRate)
	}
	// Now we add rate for NEO-ETH to start matching orders
	setRateInput2, e6 := abi.Pack("addRate", "NEO-ETH", big.NewInt(10), big.NewInt(1))
	if e6 != nil {
		t.Fatal(e6)
	}
	_, _, e7 := sample_kvm.Call(address, setRateInput2, &sample_kvm.Config{State: state})
	if e7 != nil {
		t.Fatal(e7)
	}
	originalEthTxId := "ethtxid1"
	println("Matching 5 eth : ethtxid1")
	// Start matching 5 eth for 50 neo
	matchInput1, e8 := abi.Pack("matchOrder", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver1", originalEthTxId, big.NewInt(5))
	if e8 != nil {
		t.Fatal(e8)
	}
	_, _, e9 := sample_kvm.Call(address, matchInput1, &sample_kvm.Config{State: state})
	if e9 != nil {
		t.Fatal(e9)
	}
	// Start matching 20 neo for 2 eth
	println("Matching 20 neo : neotxid1")
	originalNeoTxId := "neotxid1"
	matchInput1, e8 = abi.Pack("matchOrder", "NEO-ETH", "ETH-NEO", "neoSender2", "ethReceiver2", originalNeoTxId, big.NewInt(20))
	if e8 != nil {
		t.Fatal(e8)
	}
	_, _, e13 := sample_kvm.Call(address, matchInput1, &sample_kvm.Config{State: state})
	if e13 != nil {
		t.Fatal(e13)
	}

	// Get release info of newly added order, should have 1 release with 2 eth for NEO-ETH and 1 release with 20 neo for ETH-NEO
	getReleaseInput1, e14 := abi.Pack("getReleaseByTxId", originalNeoTxId, "ETH-NEO")
	if e14 != nil {
		t.Fatal(e14)
	}
	getReleaseResult1, _, e15 := sample_kvm.Call(address, getReleaseInput1, &sample_kvm.Config{State: state})
	if e15 != nil {
		t.Fatal(e15)
	}
	var releases struct {
		ReleaseInfos string
	}
	e16 := abi.Unpack(&releases, "getReleaseByTxId", getReleaseResult1)
	if e16 != nil {
		t.Fatal(e16)
	}
	if releases.ReleaseInfos != "ethtxid1:ETH-NEO;neoReceiver1;;20;0" {
		t.Error("Invalid release info, ethtxid1:ETH-NEO;neoReceiver1;;20;0 , got ", releases.ReleaseInfos)
	}
	println("Release info of ", originalNeoTxId, " from ETH to NEO :", releases.ReleaseInfos)
	getReleaseInput1, e14 = abi.Pack("getReleaseByTxId", originalNeoTxId, "NEO-ETH")
	if e14 != nil {
		t.Fatal(e14)
	}
	getReleaseResult1, _, e15 = sample_kvm.Call(address, getReleaseInput1, &sample_kvm.Config{State: state})
	if e15 != nil {
		t.Fatal(e15)
	}

	e16 = abi.Unpack(&releases, "getReleaseByTxId", getReleaseResult1)
	if e16 != nil {
		t.Fatal(e16)
	}
	if releases.ReleaseInfos != "neotxid1:NEO-ETH;ethReceiver2;;2;0" {
		t.Error("Invalid release info, expect neotxid1:NEO-ETH;ethReceiver2;;2;0 , got ", releases.ReleaseInfos)
	}
	println("Release info of ", originalNeoTxId, " from NEO to ETH :", releases.ReleaseInfos)
	// get release info of 1st added order with direction neo-eth , should have 1 release  with 10 neo and completed to
	getReleaseInput1, e14 = abi.Pack("getReleaseByTxId", "ethtxid1", "ETH-NEO")
	if e14 != nil {
		t.Fatal(e14)
	}
	getReleaseResult1, _, e15 = sample_kvm.Call(address, getReleaseInput1, &sample_kvm.Config{State: state})
	if e15 != nil {
		t.Fatal(e15)
	}
	e16 = abi.Unpack(&releases, "getReleaseByTxId", getReleaseResult1)
	if e16 != nil {
		t.Fatal(e16)
	}
	if releases.ReleaseInfos != "ethtxid1:ETH-NEO;neoReceiver1;;20;0" {
		t.Error("Invalid release info, expect ethtxid:ETH-NEO;neoReceiver1;;20;0 , got ", releases.ReleaseInfos)
	}

	// Match more 10 NEO to see what happens
	originalNeoTxId = "neotxid2"
	matchInput1, e8 = abi.Pack("matchOrder", "NEO-ETH", "ETH-NEO", "neoSender2", "ethReceiver2", originalNeoTxId, big.NewInt(10))
	if e8 != nil {
		t.Fatal(e8)
	}
	_, _, e13 = sample_kvm.Call(address, matchInput1, &sample_kvm.Config{State: state})
	if e13 != nil {
		t.Fatal(e13)
	}

	// We get release info of the 1st order from eth
	getReleaseInput1, e14 = abi.Pack("getReleaseByTxId", originalEthTxId, "ETH-NEO")
	if e14 != nil {
		t.Fatal(e14)
	}
	getReleaseResult1, _, e15 = sample_kvm.Call(address, getReleaseInput1, &sample_kvm.Config{State: state})
	if e15 != nil {
		t.Fatal(e15)
	}

	e16 = abi.Unpack(&releases, "getReleaseByTxId", getReleaseResult1)
	if e16 != nil {
		t.Fatal(e16)
	}
	println("release info of ethtxid1:", releases.ReleaseInfos)
	//Complete ETH-NEO part of neotxid1
	completeInput, e17 := abi.Pack("completeOrder", "neotxid1", "releaseNeoTxId","ETH-NEO", "neoReceiver1", big.NewInt(20))
	if e17 != nil {
		t.Fatal(e17)
	}
	_, _, e18 := sample_kvm.Call(address, completeInput, &sample_kvm.Config{State: state})
	if e18 != nil {
		t.Fatal(e18)
	}
	// get release info of the order neotxid1 , should have 1 release with 20 neo and completed
	getReleaseInput1, e14 = abi.Pack("getReleaseByTxId", "neotxid1", "ETH-NEO")
	if e14 != nil {
		t.Fatal(e14)
	}
	getReleaseResult1, _, e15 = sample_kvm.Call(address, getReleaseInput1, &sample_kvm.Config{State: state})
	if e15 != nil {
		t.Fatal(e15)
	}
	e16 = abi.Unpack(&releases, "getReleaseByTxId", getReleaseResult1)
	if e16 != nil {
		t.Fatal(e16)
	}
	println(releases.ReleaseInfos)
	if releases.ReleaseInfos != "ethtxid1:ETH-NEO;neoReceiver1;releaseNeoTxId;20;1" {
		t.Error("Invalid release info, expect ethtxid1:ETH-NEO;neoReceiver1;releaseNeoTxId;20;1 , got ", releases.ReleaseInfos)
	}
	// get release info of 1st added order with direction neo-eth , should have 1 release  with 10 neo and completed to
	getReleaseInput1, e14 = abi.Pack("getReleaseByTxId", "ethtxid1", "ETH-NEO")
	if e14 != nil {
		t.Fatal(e14)
	}
	getReleaseResult1, _, e15 = sample_kvm.Call(address, getReleaseInput1, &sample_kvm.Config{State: state})
	if e15 != nil {
		t.Fatal(e15)
	}
	e16 = abi.Unpack(&releases, "getReleaseByTxId", getReleaseResult1)
	if e16 != nil {
		t.Fatal(e16)
	}
	if releases.ReleaseInfos != "ethtxid1:ETH-NEO;neoReceiver1;releaseNeoTxId;20;1|ethtxid1:ETH-NEO;neoReceiver1;;10;0" {
		t.Error("Invalid release info, expect ethtxid1:ETH-NEO;neoReceiver1;releaseNeoTxId;20;1|ethtxid1:ETH-NEO;neoReceiver1;;10;0 , got ", releases.ReleaseInfos)
	}
}

func FloatToBigInt(val float64) *big.Int {
	bigval := new(big.Float)
	bigval.SetFloat64(val)
	// Set precision if required.
	// bigval.SetPrec(64)

	coin := new(big.Float)
	coin.SetInt(big.NewInt(1000000000000000000))

	bigval.Mul(bigval, coin)

	result := new(big.Int)
	bigval.Int(result) // store converted number in result

	return result
}

func TestRate(t *testing.T) {
	amountEth := 0.06482133 * 2 * math.Pow(10, 18)
	amountEthBig := big.NewInt(int64(math.Floor(amountEth)))
	rateEth := big.NewInt(100000000)
	rateNeo := big.NewInt(6482133)

	temp := big.NewInt(1)
	TenPoweredByTen := big.NewInt(1).Exp(big.NewInt(10), big.NewInt(10), nil)

	convertedAmount := temp.Mul(amountEthBig, rateEth)
	convertedAmount = temp.Div(convertedAmount, rateNeo)
	convertedAmount = temp.Div(convertedAmount, TenPoweredByTen)
	println(convertedAmount.Int64())

	amountNeo := big.NewInt(200000000)
	releasedAmount := temp.Mul(amountNeo, TenPoweredByTen)
	releasedAmount = temp.Mul(amountNeo, rateNeo)
	releasedAmount = temp.Div(releasedAmount, rateEth)
	println(releasedAmount.Int64())
}
