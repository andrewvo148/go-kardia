package smc

import (
	"math/big"
	"strings"
	"testing"

	"github.com/kardiachain/go-kardia/kai/state"
	kaidb "github.com/kardiachain/go-kardia/kai/storage"
	"github.com/kardiachain/go-kardia/kvm/sample_kvm"
	"github.com/kardiachain/go-kardia/lib/abi"
	"github.com/kardiachain/go-kardia/lib/common"
	"github.com/kardiachain/go-kardia/lib/log"
)

// This test contains all the test cases for interfaces of the new exchange contract
// Please find the solidity source code at go-kardia/kvm/smc/NewExchange.sol


var code = common.Hex2Bytes("6080604052600436106100af576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680630b6a4da7146100b45780631112f836146101775780631d216962146103165780632c72bd87146103f857806342e11635146104755780634828c97e146105335780637fb06000146106885780638e4a24041461070c578063aab991d314610789578063b6c3b936146108b1578063fa57983d14610a06575b600080fd5b3480156100c057600080fd5b50610161600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050610ae8565b6040518082815260200191505060405180910390f35b34801561018357600080fd5b50610300600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929080359060200190929190505050611189565b6040518082815260200191505060405180910390f35b34801561032257600080fd5b5061037d600480360381019080803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929050505061191b565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156103bd5780820151818401526020810190506103a2565b50505050905090810190601f1680156103ea5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561040457600080fd5b5061045f600480360381019080803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192905050506123c0565b6040518082815260200191505060405180910390f35b34801561048157600080fd5b506104dc600480360381019080803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192905050506127b0565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b8381101561051f578082015181840152602081019050610504565b505050509050019250505060405180910390f35b34801561053f57600080fd5b5061059a600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050612a06565b604051808060200180602001848152602001838103835286818151815260200191508051906020019080838360005b838110156105e45780820151818401526020810190506105c9565b50505050905090810190601f1680156106115780820380516001836020036101000a031916815260200191505b50838103825285818151815260200191508051906020019080838360005b8381101561064a57808201518184015260208101905061062f565b50505050905090810190601f1680156106775780820380516001836020036101000a031916815260200191505b509550505050505060405180910390f35b34801561069457600080fd5b506106ef600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050613164565b604051808381526020018281526020019250505060405180910390f35b34801561071857600080fd5b50610787600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001909291908035906020019092919050505061324e565b005b34801561079557600080fd5b50610836600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192905050506132ea565b6040518080602001828103825283818151815260200191508051906020019080838360005b8381101561087657808201518184015260208101905061085b565b50505050905090810190601f1680156108a35780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3480156108bd57600080fd5b50610918600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290505050613fcc565b604051808060200180602001848152602001838103835286818151815260200191508051906020019080838360005b83811015610962578082015181840152602081019050610947565b50505050905090810190601f16801561098f5780820380516001836020036101000a031916815260200191505b50838103825285818151815260200191508051906020019080838360005b838110156109c85780820151818401526020810190506109ad565b50505050905090810190601f1680156109f55780820380516001836020036101000a031916815260200191505b509550505050505060405180910390f35b348015610a1257600080fd5b50610a6d600480360381019080803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919291929050505061467f565b6040518080602001828103825283818151815260200191508051906020019080838360005b83811015610aad578082015181840152602081019050610a92565b50505050905090810190601f168015610ada5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6000610af2615e8e565b6000846040518082805190602001908083835b602083101515610b2a5780518252602082019150602081019050602083039250610b05565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206101206040519081016040529081600082018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610c035780601f10610bd857610100808354040283529160200191610c03565b820191906000526020600020905b815481529060010190602001808311610be657829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610ca55780601f10610c7a57610100808354040283529160200191610ca5565b820191906000526020600020905b815481529060010190602001808311610c8857829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610d475780601f10610d1c57610100808354040283529160200191610d47565b820191906000526020600020905b815481529060010190602001808311610d2a57829003601f168201915b50505050508152602001600382018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610de95780601f10610dbe57610100808354040283529160200191610de9565b820191906000526020600020905b815481529060010190602001808311610dcc57829003601f168201915b505050505081526020016004820154815260200160058201548152602001600682018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610e9f5780601f10610e7457610100808354040283529160200191610e9f565b820191906000526020600020905b815481529060010190602001808311610e8257829003601f168201915b50505050508152602001600782015481526020016008820160009054906101000a900460ff1615151515815250509050826040516020018082805190602001908083835b602083101515610f085780518252602082019150602081019050602083039250610ee3565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083101515610f715780518252602082019150602081019050602083039250610f4c565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191681600001516040516020018082805190602001908083835b602083101515610fdf5780518252602082019150602081019050602083039250610fba565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b6020831015156110485780518252602082019150602081019050602083039250611023565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040518091039020600019161415156110895760009150611182565b600080856040518082805190602001908083835b6020831015156110c2578051825260208201915060208101905060208303925061109d565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600701541415156111095760009150611182565b60016000856040518082805190602001908083835b602083101515611143578051825260208201915060208101905060208303925061111e565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060070181905550600191505b5092915050565b6000611193615edd565b6000606061119f615e8e565b6111a88b615124565b93506000846020015114806111c1575060008460000151145b156111cf576000945061190d565b600460008154600101919050819055508360000151846020015187028115156111f457fe5b0492506112018a846151bd565b9150610120604051908101604052808c81526020018a815260200189815260200188815260200187815260200184815260200183815260200160008152602001600115158152509050806000886040518082805190602001908083835b602083101515611283578051825260208201915060208101905060208303925061125e565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060008201518160000190805190602001906112d2929190615ef7565b5060208201518160010190805190602001906112ef929190615ef7565b50604082015181600201908051906020019061130c929190615ef7565b506060820151816003019080519060200190611329929190615ef7565b506080820151816004015560a0820151816005015560c082015181600601908051906020019061135a929190615ef7565b5060e082015181600701556101008201518160080160006101000a81548160ff02191690831515021790555090505060018b6040518082805190602001908083835b6020831015156113c1578051825260208201915060208101905060208303925061139c565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902087908060018154018082558091505090600182039060005260206000200160009091929091909150908051906020019061142f929190615f77565b50506003896040518082805190602001908083835b6020831015156114695780518252602082019150602081019050602083039250611444565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390208790806001815401808255809150509060018203906000526020600020016000909192909190915090805190602001906114d7929190615f77565b50506040516020018060000190506040516020818303038152906040526040518082805190602001908083835b6020831015156115295780518252602082019150602081019050602083039250611504565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040518091039020600019168160c001516040516020018082805190602001908083835b6020831015156115975780518252602082019150602081019050602083039250611572565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b60208310151561160057805182526020820191506020810190506020830392506115db565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191614151561190757866000836040518082805190602001908083835b602083101515611671578051825260208201915060208101905060208303925061164c565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060060190805190602001906116ba929190615f77565b506000826040518082805190602001908083835b6020831015156116f357805182526020820191506020810190506020830392506116ce565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060020160405180828054600181600116156101000203166002900480156117845780601f10611762576101008083540402835291820191611784565b820191906000526020600020905b815481529060010190602001808311611770575b505091505060405180910390208a6040518082805190602001908083835b6020831015156117c757805182526020820191506020810190506020830392506117a2565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390207fe098f1a1864cc8bfe9a75a52c8185d277d809ca67a0f542f39114f77faba1339846000866040518082805190602001908083835b60208310151561184e5780518252602082019150602081019050602083039250611829565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600501546040518080602001838152602001828103825284818151815260200191508051906020019080838360005b838110156118cb5780820151818401526020810190506118b0565b50505050905090810190601f1680156118f85780820380516001836020036101000a031916815260200191505b50935050505060405180910390a35b60045494505b505050509695505050505050565b6060806000606060006001866040518082805190602001908083835b60208310151561195c5780518252602082019150602081019050602083039250611937565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020805480602002602001604051908101604052809291908181526020016000905b82821015611a6b578382906000526020600020018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611a575780601f10611a2c57610100808354040283529160200191611a57565b820191906000526020600020905b815481529060010190602001808311611a3a57829003601f168201915b5050505050815260200190600101906119af565b505050509350835192506000831415611a9657602060405190810160405280600081525094506123b7565b60206040519081016040528060008152509150600090505b828110156123b3576000811415611ec057611eb960008583815181101515611ad257fe5b906020019060200201516040518082805190602001908083835b602083101515611b115780518252602082019150602081019050602083039250611aec565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206101206040519081016040529081600082018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611bea5780601f10611bbf57610100808354040283529160200191611bea565b820191906000526020600020905b815481529060010190602001808311611bcd57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611c8c5780601f10611c6157610100808354040283529160200191611c8c565b820191906000526020600020905b815481529060010190602001808311611c6f57829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611d2e5780601f10611d0357610100808354040283529160200191611d2e565b820191906000526020600020905b815481529060010190602001808311611d1157829003601f168201915b50505050508152602001600382018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611dd05780601f10611da557610100808354040283529160200191611dd0565b820191906000526020600020905b815481529060010190602001808311611db357829003601f168201915b505050505081526020016004820154815260200160058201548152602001600682018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611e865780601f10611e5b57610100808354040283529160200191611e86565b820191906000526020600020905b815481529060010190602001808311611e6957829003601f168201915b50505050508152602001600782015481526020016008820160009054906101000a900460ff1615151515815250506158df565b91506123a6565b816122bb60008684815181101515611ed457fe5b906020019060200201516040518082805190602001908083835b602083101515611f135780518252602082019150602081019050602083039250611eee565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206101206040519081016040529081600082018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611fec5780601f10611fc157610100808354040283529160200191611fec565b820191906000526020600020905b815481529060010190602001808311611fcf57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561208e5780601f106120635761010080835404028352916020019161208e565b820191906000526020600020905b81548152906001019060200180831161207157829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156121305780601f1061210557610100808354040283529160200191612130565b820191906000526020600020905b81548152906001019060200180831161211357829003601f168201915b50505050508152602001600382018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156121d25780601f106121a7576101008083540402835291602001916121d2565b820191906000526020600020905b8154815290600101906020018083116121b557829003601f168201915b505050505081526020016004820154815260200160058201548152602001600682018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156122885780601f1061225d57610100808354040283529160200191612288565b820191906000526020600020905b81548152906001019060200180831161226b57829003601f168201915b50505050508152602001600782015481526020016008820160009054906101000a900460ff1615151515815250506158df565b6040516020018083805190602001908083835b6020831015156122f357805182526020820191506020810190506020830392506122ce565b6001836020036101000a038019825116818451168082178552505050505050905001807f7c0000000000000000000000000000000000000000000000000000000000000081525060010182805190602001908083835b60208310151561236e5780518252602082019150602081019050602083039250612349565b6001836020036101000a0380198251168184511680821785525050505050509050019250505060405160208183030381529060405291505b8080600101915050611aae565b8194505b50505050919050565b60006060600080600093506001856040518082805190602001908083835b60208310151561240357805182526020820191506020810190506020830392506123de565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020805480602002602001604051908101604052809291908181526020016000905b82821015612512578382906000526020600020018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156124fe5780601f106124d3576101008083540402835291602001916124fe565b820191906000526020600020905b8154815290600101906020018083116124e157829003601f168201915b505050505081526020019060010190612456565b5050505092506040516020018060000190506040516020818303038152906040526040518082805190602001908083835b6020831015156125685780518252602082019150602081019050602083039250612543565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390209150600090505b82518110156127a5578160001916600084838151811015156125ba57fe5b906020019060200201516040518082805190602001908083835b6020831015156125f957805182526020820191506020810190506020830392506125d4565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600601604051602001808280546001816001161561010002031660029004801561268d5780601f1061266b57610100808354040283529182019161268d565b820191906000526020600020905b815481529060010190602001808311612679575b50509150506040516020818303038152906040526040518082805190602001908083835b6020831015156126d657805182526020820191506020810190506020830392506126b1565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040518091039020600019161415612798576000838281518110151561271d57fe5b906020019060200201516040518082805190602001908083835b60208310151561275c5780518252602082019150602081019050602083039250612737565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060050154840193505b808060010191505061259c565b839350505050919050565b60608060006001846040518082805190602001908083835b6020831015156127ed57805182526020820191506020810190506020830392506127c8565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020805480602002602001604051908101604052809291908181526020016000905b828210156128fc578382906000526020600020018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156128e85780601f106128bd576101008083540402835291602001916128e8565b820191906000526020600020905b8154815290600101906020018083116128cb57829003601f168201915b505050505081526020019060010190612840565b505050509150600a6040519080825280602002602001820160405280156129325781602001602082028038833980820191505090505b509250600090505b81518110156129fc57600a8110156129ef576000828281518110151561295c57fe5b906020019060200201516040518082805190602001908083835b60208310151561299b5780518252602082019150602081019050602083039250612976565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206005015483828151811015156129e057fe5b90602001906020020181815250505b808060010191505061293a565b8292505050919050565b60608060006060612a15615e8e565b600015156000876040518082805190602001908083835b602083101515612a515780518252602082019150602081019050602083039250612a2c565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060080160009054906101000a900460ff1615151415612ad157600060206040519081016040528060008152509060206040519081016040528060008152509080905094509450945061315b565b6000866040518082805190602001908083835b602083101515612b095780518252602082019150602081019050602083039250612ae4565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206006018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015612bd35780601f10612ba857610100808354040283529160200191612bd3565b820191906000526020600020905b815481529060010190602001808311612bb657829003601f168201915b505050505091506040516020018060000190506040516020818303038152906040526040518082805190602001908083835b602083101515612c2a5780518252602082019150602081019050602083039250612c05565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916826040516020018082805190602001908083835b602083101515612c945780518252602082019150602081019050602083039250612c6f565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b602083101515612cfd5780518252602082019150602081019050602083039250612cd8565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206000191614151561312b576000826040518082805190602001908083835b602083101515612d6d5780518252602082019150602081019050602083039250612d48565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206101206040519081016040529081600082018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015612e465780601f10612e1b57610100808354040283529160200191612e46565b820191906000526020600020905b815481529060010190602001808311612e2957829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015612ee85780601f10612ebd57610100808354040283529160200191612ee8565b820191906000526020600020905b815481529060010190602001808311612ecb57829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015612f8a5780601f10612f5f57610100808354040283529160200191612f8a565b820191906000526020600020905b815481529060010190602001808311612f6d57829003601f168201915b50505050508152602001600382018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561302c5780601f106130015761010080835404028352916020019161302c565b820191906000526020600020905b81548152906001019060200180831161300f57829003601f168201915b505050505081526020016004820154815260200160058201548152602001600682018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156130e25780601f106130b7576101008083540402835291602001916130e2565b820191906000526020600020905b8154815290600101906020018083116130c557829003601f168201915b50505050508152602001600782015481526020016008820160009054906101000a900460ff16151515158152505090508181604001518260a0015181915094509450945061315b565b60006020604051908101604052806000815250906020604051908101604052806000815250908090509450945094505b50509193909250565b6000806002836040518082805190602001908083835b60208310151561319f578051825260208201915060208101905060208303925061317a565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600001546002846040518082805190602001908083835b60208310151561320e57805182526020820191506020810190506020830392506131e9565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206001015491509150915091565b6040805190810160405280838152602001828152506002846040518082805190602001908083835b60208310151561329b5780518252602082019150602081019050602083039250613276565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206000820151816000015560208201518160010155905050505050565b606080600060606000806003886040518082805190602001908083835b60208310151561332c5780518252602082019150602081019050602083039250613307565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020805480602002602001604051908101604052809291908181526020016000905b8282101561343b578382906000526020600020018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156134275780601f106133fc57610100808354040283529160200191613427565b820191906000526020600020905b81548152906001019060200180831161340a57829003601f168201915b50505050508152602001906001019061337f565b5050505094508451935060008414156134665760206040519081016040528060008152509550613fc1565b60206040519081016040528060008152509250866040516020018082805190602001908083835b6020831015156134b2578051825260208201915060208101905060208303925061348d565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b60208310151561351b57805182526020820191506020810190506020830392506134f6565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390209150600090505b83811015613fbd5781600019166000868381518110151561356c57fe5b906020019060200201516040518082805190602001908083835b6020831015156135ab5780518252602082019150602081019050602083039250613586565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600001604051602001808280546001816001161561010002031660029004801561363f5780601f1061361d57610100808354040283529182019161363f565b820191906000526020600020905b81548152906001019060200180831161362b575b50509150506040516020818303038152906040526040518082805190602001908083835b6020831015156136885780518252602082019150602081019050602083039250613663565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040518091039020600019161415613fb0576000811415613ac957613ac2600086838151811015156136db57fe5b906020019060200201516040518082805190602001908083835b60208310151561371a57805182526020820191506020810190506020830392506136f5565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206101206040519081016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156137f35780601f106137c8576101008083540402835291602001916137f3565b820191906000526020600020905b8154815290600101906020018083116137d657829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156138955780601f1061386a57610100808354040283529160200191613895565b820191906000526020600020905b81548152906001019060200180831161387857829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156139375780601f1061390c57610100808354040283529160200191613937565b820191906000526020600020905b81548152906001019060200180831161391a57829003601f168201915b50505050508152602001600382018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156139d95780601f106139ae576101008083540402835291602001916139d9565b820191906000526020600020905b8154815290600101906020018083116139bc57829003601f168201915b505050505081526020016004820154815260200160058201548152602001600682018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015613a8f5780601f10613a6457610100808354040283529160200191613a8f565b820191906000526020600020905b815481529060010190602001808311613a7257829003601f168201915b50505050508152602001600782015481526020016008820160009054906101000a900460ff1615151515815250506158df565b9250613faf565b82613ec460008784815181101515613add57fe5b906020019060200201516040518082805190602001908083835b602083101515613b1c5780518252602082019150602081019050602083039250613af7565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206101206040519081016040529081600082018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015613bf55780601f10613bca57610100808354040283529160200191613bf5565b820191906000526020600020905b815481529060010190602001808311613bd857829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015613c975780601f10613c6c57610100808354040283529160200191613c97565b820191906000526020600020905b815481529060010190602001808311613c7a57829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015613d395780601f10613d0e57610100808354040283529160200191613d39565b820191906000526020600020905b815481529060010190602001808311613d1c57829003601f168201915b50505050508152602001600382018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015613ddb5780601f10613db057610100808354040283529160200191613ddb565b820191906000526020600020905b815481529060010190602001808311613dbe57829003601f168201915b505050505081526020016004820154815260200160058201548152602001600682018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015613e915780601f10613e6657610100808354040283529160200191613e91565b820191906000526020600020905b815481529060010190602001808311613e7457829003601f168201915b50505050508152602001600782015481526020016008820160009054906101000a900460ff1615151515815250506158df565b6040516020018083805190602001908083835b602083101515613efc5780518252602082019150602081019050602083039250613ed7565b6001836020036101000a038019825116818451168082178552505050505050905001807f7c0000000000000000000000000000000000000000000000000000000000000081525060010182805190602001908083835b602083101515613f775780518252602082019150602081019050602083039250613f52565b6001836020036101000a0380198251168184511680821785525050505050509050019250505060405160208183030381529060405292505b5b808060010191505061354f565b8295505b505050505092915050565b60608060006060613fdb615e8e565b6000866040518082805190602001908083835b6020831015156140135780518252602082019150602081019050602083039250613fee565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206006018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156140dd5780601f106140b2576101008083540402835291602001916140dd565b820191906000526020600020905b8154815290600101906020018083116140c057829003601f168201915b505050505091506040516020018060000190506040516020818303038152906040526040518082805190602001908083835b602083101515614134578051825260208201915060208101905060208303925061410f565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916826040516020018082805190602001908083835b60208310151561419e5780518252602082019150602081019050602083039250614179565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b60208310151561420757805182526020820191506020810190506020830392506141e2565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040518091039020600019161415614272576000602060405190810160405280600081525090602060405190810160405280600081525090809050945094509450614676565b6000826040518082805190602001908083835b6020831015156142aa5780518252602082019150602081019050602083039250614285565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206101206040519081016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156143835780601f1061435857610100808354040283529160200191614383565b820191906000526020600020905b81548152906001019060200180831161436657829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156144255780601f106143fa57610100808354040283529160200191614425565b820191906000526020600020905b81548152906001019060200180831161440857829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156144c75780601f1061449c576101008083540402835291602001916144c7565b820191906000526020600020905b8154815290600101906020018083116144aa57829003601f168201915b50505050508152602001600382018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156145695780601f1061453e57610100808354040283529160200191614569565b820191906000526020600020905b81548152906001019060200180831161454c57829003601f168201915b505050505081526020016004820154815260200160058201548152602001600682018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561461f5780601f106145f45761010080835404028352916020019161461f565b820191906000526020600020905b81548152906001019060200180831161460257829003601f168201915b50505050508152602001600782015481526020016008820160009054906101000a900460ff161515151581525050905060008160e001511415614675578181604001518260a00151819150945094509450614676565b5b50509193909250565b6060806000606060006003866040518082805190602001908083835b6020831015156146c0578051825260208201915060208101905060208303925061469b565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020805480602002602001604051908101604052809291908181526020016000905b828210156147cf578382906000526020600020018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156147bb5780601f10614790576101008083540402835291602001916147bb565b820191906000526020600020905b81548152906001019060200180831161479e57829003601f168201915b505050505081526020019060010190614713565b5050505093508351925060008314156147fa576020604051908101604052806000815250945061511b565b60206040519081016040528060008152509150600090505b82811015615117576000811415614c2457614c1d6000858381518110151561483657fe5b906020019060200201516040518082805190602001908083835b6020831015156148755780518252602082019150602081019050602083039250614850565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206101206040519081016040529081600082018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561494e5780601f106149235761010080835404028352916020019161494e565b820191906000526020600020905b81548152906001019060200180831161493157829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156149f05780601f106149c5576101008083540402835291602001916149f0565b820191906000526020600020905b8154815290600101906020018083116149d357829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015614a925780601f10614a6757610100808354040283529160200191614a92565b820191906000526020600020905b815481529060010190602001808311614a7557829003601f168201915b50505050508152602001600382018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015614b345780601f10614b0957610100808354040283529160200191614b34565b820191906000526020600020905b815481529060010190602001808311614b1757829003601f168201915b505050505081526020016004820154815260200160058201548152602001600682018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015614bea5780601f10614bbf57610100808354040283529160200191614bea565b820191906000526020600020905b815481529060010190602001808311614bcd57829003601f168201915b50505050508152602001600782015481526020016008820160009054906101000a900460ff1615151515815250506158df565b915061510a565b8161501f60008684815181101515614c3857fe5b906020019060200201516040518082805190602001908083835b602083101515614c775780518252602082019150602081019050602083039250614c52565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206101206040519081016040529081600082018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015614d505780601f10614d2557610100808354040283529160200191614d50565b820191906000526020600020905b815481529060010190602001808311614d3357829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015614df25780601f10614dc757610100808354040283529160200191614df2565b820191906000526020600020905b815481529060010190602001808311614dd557829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015614e945780601f10614e6957610100808354040283529160200191614e94565b820191906000526020600020905b815481529060010190602001808311614e7757829003601f168201915b50505050508152602001600382018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015614f365780601f10614f0b57610100808354040283529160200191614f36565b820191906000526020600020905b815481529060010190602001808311614f1957829003601f168201915b505050505081526020016004820154815260200160058201548152602001600682018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015614fec5780601f10614fc157610100808354040283529160200191614fec565b820191906000526020600020905b815481529060010190602001808311614fcf57829003601f168201915b50505050508152602001600782015481526020016008820160009054906101000a900460ff1615151515815250506158df565b6040516020018083805190602001908083835b6020831015156150575780518252602082019150602081019050602083039250615032565b6001836020036101000a038019825116818451168082178552505050505050905001807f7c0000000000000000000000000000000000000000000000000000000000000081525060010182805190602001908083835b6020831015156150d257805182526020820191506020810190506020830392506150ad565b6001836020036101000a0380198251168184511680821785525050505050509050019250505060405160208183030381529060405291505b8080600101915050614812565b8194505b50505050919050565b61512c615edd565b6002826040518082805190602001908083835b602083101515615164578051825260208201915060208101905060208303925061513f565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020604080519081016040529081600082015481526020016001820154815250509050919050565b60608060006151ca615e8e565b6001866040518082805190602001908083835b60208310151561520257805182526020820191506020810190506020830392506151dd565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020805480602002602001604051908101604052809291908181526020016000905b82821015615311578382906000526020600020018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156152fd5780601f106152d2576101008083540402835291602001916152fd565b820191906000526020600020905b8154815290600101906020018083116152e057829003601f168201915b505050505081526020019060010190615255565b505050509250600091505b82518210156158c2576000838381518110151561533557fe5b906020019060200201516040518082805190602001908083835b602083101515615374578051825260208201915060208101905060208303925061534f565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206101206040519081016040529081600082018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561544d5780601f106154225761010080835404028352916020019161544d565b820191906000526020600020905b81548152906001019060200180831161543057829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156154ef5780601f106154c4576101008083540402835291602001916154ef565b820191906000526020600020905b8154815290600101906020018083116154d257829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156155915780601f1061556657610100808354040283529160200191615591565b820191906000526020600020905b81548152906001019060200180831161557457829003601f168201915b50505050508152602001600382018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156156335780601f1061560857610100808354040283529160200191615633565b820191906000526020600020905b81548152906001019060200180831161561657829003601f168201915b505050505081526020016004820154815260200160058201548152602001600682018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156156e95780601f106156be576101008083540402835291602001916156e9565b820191906000526020600020905b8154815290600101906020018083116156cc57829003601f168201915b50505050508152602001600782015481526020016008820160009054906101000a900460ff161515151581525050905084816080015114801561588157506040516020018060000190506040516020818303038152906040526040518082805190602001908083835b6020831015156157775780518252602082019150602081019050602083039250615752565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040518091039020600019168160c001516040516020018082805190602001908083835b6020831015156157e557805182526020820191506020810190506020830392506157c0565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040516020818303038152906040526040518082805190602001908083835b60208310151561584e5780518252602082019150602081019050602083039250615829565b6001836020036101000a038019825116818451168082178552505050505050905001915050604051809103902060001916145b8015615891575060008160e00151145b156158b55782828151811015156158a457fe5b9060200190602002015193506158d6565b818060010192505061531c565b602060405190810160405280600081525093505b50505092915050565b6060806060806000856101000190151590811515815250156159135760206040519081016040528060008152509350615d2f565b6159208560800151615d37565b925061592f8560a00151615d37565b915061593e8560e00151615d37565b9050846000015185602001518660400151876060015186868a60c00151876040516020018089805190602001908083835b602083101515615994578051825260208201915060208101905060208303925061596f565b6001836020036101000a038019825116818451168082178552505050505050905001807f3b0000000000000000000000000000000000000000000000000000000000000081525060010188805190602001908083835b602083101515615a0f57805182526020820191506020810190506020830392506159ea565b6001836020036101000a038019825116818451168082178552505050505050905001807f3b0000000000000000000000000000000000000000000000000000000000000081525060010187805190602001908083835b602083101515615a8a5780518252602082019150602081019050602083039250615a65565b6001836020036101000a038019825116818451168082178552505050505050905001807f3b0000000000000000000000000000000000000000000000000000000000000081525060010186805190602001908083835b602083101515615b055780518252602082019150602081019050602083039250615ae0565b6001836020036101000a038019825116818451168082178552505050505050905001807f3b0000000000000000000000000000000000000000000000000000000000000081525060010185805190602001908083835b602083101515615b805780518252602082019150602081019050602083039250615b5b565b6001836020036101000a038019825116818451168082178552505050505050905001807f3b0000000000000000000000000000000000000000000000000000000000000081525060010184805190602001908083835b602083101515615bfb5780518252602082019150602081019050602083039250615bd6565b6001836020036101000a038019825116818451168082178552505050505050905001807f3b0000000000000000000000000000000000000000000000000000000000000081525060010183805190602001908083835b602083101515615c765780518252602082019150602081019050602083039250615c51565b6001836020036101000a038019825116818451168082178552505050505050905001807f3b0000000000000000000000000000000000000000000000000000000000000081525060010182805190602001908083835b602083101515615cf15780518252602082019150602081019050602083039250615ccc565b6001836020036101000a0380198251168184511680821785525050505050509050019850505050505050505060405160208183030381529060405293505b505050919050565b60606000806060600080861415615d85576040805190810160405280600181526020017f30000000000000000000000000000000000000000000000000000000000000008152509450615e85565b8593505b600084141515615daf578280600101935050600a84811515615da757fe5b049350615d89565b826040519080825280601f01601f191660200182016040528015615de25781602001602082028038833980820191505090505b5091506001830390505b600086141515615e8157600a86811515615e0257fe5b066030017f010000000000000000000000000000000000000000000000000000000000000002828280600190039350815181101515615e3d57fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350600a86811515615e7957fe5b049550615dec565b8194505b50505050919050565b6101206040519081016040528060608152602001606081526020016060815260200160608152602001600081526020016000815260200160608152602001600081526020016000151581525090565b604080519081016040528060008152602001600081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10615f3857805160ff1916838001178555615f66565b82800160010185558215615f66579182015b82811115615f65578251825591602001919060010190615f4a565b5b509050615f739190615ff7565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10615fb857805160ff1916838001178555615fe6565b82800160010185558215615fe6579182015b82811115615fe5578251825591602001919060010190615fca565b5b509050615ff39190615ff7565b5090565b61601991905b80821115616015576000816000905550600101615ffd565b5090565b905600a165627a7a72305820effe492d3a979cf1a8bc519dd3c27f657e95dbe7745fd668757a50af581a0bfd0029")
var definition = `[
	{
		"constant": false,
		"inputs": [
			{
				"name": "orderID",
				"type": "string"
			},
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "completeOrder",
		"outputs": [
			{
				"name": "success",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "srcPair",
				"type": "string"
			},
			{
				"name": "destPair",
				"type": "string"
			},
			{
				"name": "srcAddress",
				"type": "string"
			},
			{
				"name": "destAddress",
				"type": "string"
			},
			{
				"name": "originalTxId",
				"type": "string"
			},
			{
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "matchOrder",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "getOrderBook",
		"outputs": [
			{
				"name": "orderBook",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "getAvailableAmountByPair",
		"outputs": [
			{
				"name": "amount",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "getMatchableAmount",
		"outputs": [
			{
				"name": "amounts",
				"type": "uint256[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "orderID",
				"type": "string"
			}
		],
		"name": "getMatchingOrderInfo",
		"outputs": [
			{
				"name": "matchedOrderID",
				"type": "string"
			},
			{
				"name": "destAddress",
				"type": "string"
			},
			{
				"name": "sendAmount",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "getRatePublic",
		"outputs": [
			{
				"name": "sale",
				"type": "uint256"
			},
			{
				"name": "receive",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "pair",
				"type": "string"
			},
			{
				"name": "sale_amount",
				"type": "uint256"
			},
			{
				"name": "receiveAmount",
				"type": "uint256"
			}
		],
		"name": "addRate",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "addr",
				"type": "string"
			},
			{
				"name": "pair",
				"type": "string"
			}
		],
		"name": "getOrderHistoryByPair",
		"outputs": [
			{
				"name": "orderHistory",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "orderID",
				"type": "string"
			}
		],
		"name": "getUncompletedMatchingOrder",
		"outputs": [
			{
				"name": "matchedOrderID",
				"type": "string"
			},
			{
				"name": "destAddress",
				"type": "string"
			},
			{
				"name": "sendAmount",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "addr",
				"type": "string"
			}
		],
		"name": "getOrderHistory",
		"outputs": [
			{
				"name": "orderHistory",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"name": "pair",
				"type": "string"
			},
			{
				"indexed": true,
				"name": "addr",
				"type": "string"
			},
			{
				"indexed": false,
				"name": "matchOrderId",
				"type": "string"
			},
			{
				"indexed": false,
				"name": "_value",
				"type": "uint256"
			}
		],
		"name": "Release",
		"type": "event"
	}
]`

func TestNewExchangeContract(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(kaidb.NewMemStore()))
	address := common.HexToAddress("0x0a")
	state.SetCode(address, code)
	abi, err := abi.JSON(strings.NewReader(definition))
	if err != nil {
		t.Fatal(err)
	}

	// Try to get non-set rate
	getRateInput, e1 := abi.Pack("getRatePublic", "ETH-NEO")
	if e1 != nil {
		t.Fatal(e1)
	}
	rateResult, _, errCallRate := sample_kvm.Call(address, getRateInput, &sample_kvm.Config{State: state})

	if errCallRate != nil {
		t.Fatal(errCallRate)
	}
	var rateStruct struct {
		Sale    *big.Int `abi:"sale"`
		Receive *big.Int `abi:"receive"`
	}
	err = abi.Unpack(&rateStruct, "getRatePublic", rateResult)
	if err != nil {
		t.Fatal(err)
	}
	if rateStruct.Sale.Cmp(big.NewInt(0)) != 0 || rateStruct.Receive.Cmp(big.NewInt(0)) != 0 {
		t.Error("Error get value, expected 0, 0 got ", rateStruct.Sale.String(), rateStruct.Receive.String())
	}

	// Now we add rate for ETH-NEO first
	setRateInput, e2 := abi.Pack("addRate", "ETH-NEO", big.NewInt(1), big.NewInt(10))
	if e2 != nil {
		t.Fatal(e2)
	}
	_, _, e3 := sample_kvm.Call(address, setRateInput, &sample_kvm.Config{State: state})
	if e3 != nil {
		t.Fatal(e3)
	}
	var decodeInput struct {
		Pair          string
		Sale_amount   *big.Int
		ReceiveAmount *big.Int
	}
	setRateInput = common.FromHex("0x8e4a24040000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000074e454f2d45544800000000000000000000000000000000000000000000000000")
	e := abi.UnpackInput(&decodeInput, "addRate", setRateInput[4:])
	if e != nil {
		t.Fatal(e)
	}
	rateResult, _, errCallRate = sample_kvm.Call(address, getRateInput, &sample_kvm.Config{State: state})

	if errCallRate != nil {
		t.Fatal(errCallRate)
	}

	// Call get rate for ETH-NEO again to check if we set it correctly
	err = abi.Unpack(&rateStruct, "getRatePublic", rateResult)
	if err != nil {
		t.Fatal(err)
	}
	if rateStruct.Sale.Cmp(big.NewInt(1)) != 0 || rateStruct.Receive.Cmp(big.NewInt(10)) != 0 {
		t.Error("Error get value, expected 1, 10 got ", rateStruct.Sale.String(), rateStruct.Receive.String())
	}

	// Now we add rate for NEO-ETH to start matching orders
	setRateInput2, e2 := abi.Pack("addRate", "NEO-ETH", big.NewInt(10), big.NewInt(1))
	if e2 != nil {
		t.Fatal(e2)
	}
	_, _, e3 = sample_kvm.Call(address, setRateInput2, &sample_kvm.Config{State: state})
	if e3 != nil {
		t.Fatal(e3)
	}

	// Find available amount for NEO-ETH now, should be 0
	getAvailableInput, _ := abi.Pack("getAvailableAmountByPair", "NEO-ETH")
	availableResult, _, err := sample_kvm.Call(address, getAvailableInput, &sample_kvm.Config{State: state})
	if err != nil {
		t.Fatal(err)
	}

	if big.NewInt(0).SetBytes(availableResult).Cmp(big.NewInt(0)) != 0 {
		t.Fatal("Expect available input is 0, got", big.NewInt(0).SetBytes(availableResult).String())
	}
	// Get rate for NEO-ETH
	getRateInput2, e4 := abi.Pack("getRatePublic", "NEO-ETH")
	if e4 != nil {
		t.Fatal(e4)
	}
	rateResult, _, errCallRate = sample_kvm.Call(address, getRateInput2, &sample_kvm.Config{State: state})
	if errCallRate != nil {
		t.Fatal(errCallRate)
	}

	err = abi.Unpack(&rateStruct, "getRatePublic", rateResult)
	if err != nil {
		t.Fatal(err)
	}

	if rateStruct.Sale.Cmp(big.NewInt(10)) != 0 || rateStruct.Receive.Cmp(big.NewInt(1)) != 0 {
		t.Error("Error get value, expected 10, 1 got ", rateStruct.Sale.String(), rateStruct.Receive.String())
	}
	originalEthTxID := "ethtxid1"
	// Start matching 1 eth for 10 neo
	matchInput1, e5 := abi.Pack("matchOrder", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver1", originalEthTxID, big.NewInt(1))
	if e5 != nil {
		t.Fatal(e5)
	}
	_, gas, e6 := sample_kvm.Call(address, matchInput1, &sample_kvm.Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}
	// GetMatching info for recently added order
	getMatchingInput1, e5 := abi.Pack("getMatchingOrderInfo", originalEthTxID)
	if e5 != nil {
		t.Fatal(e5)
	}
	matchingResult1, gas, e6 := sample_kvm.Call(address, getMatchingInput1, &sample_kvm.Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}
	var decodedMatchResult struct {
		MatchedOrderID 	 string `abi:"matchedOrderID"`
		DestAddress      string   `abi:"destAddress"`
		SendAmount       *big.Int `abi:"sendAmount"`
	}
	unpackErr := abi.Unpack(&decodedMatchResult, "getMatchingOrderInfo", matchingResult1)
	if unpackErr != nil {
		t.Fatal(unpackErr)
	}
	if decodedMatchResult.MatchedOrderID != "" {
		t.Error("Expect id 0, got ", decodedMatchResult.MatchedOrderID)
	}
	if decodedMatchResult.DestAddress != "" {
		t.Error("Expect address '', got ", decodedMatchResult.DestAddress)
	}
	if decodedMatchResult.SendAmount.Cmp(big.NewInt(0)) != 0 {
		t.Error("Expect send amount 0, got ", decodedMatchResult.SendAmount.String())
	}

	getAvailableInput, _ = abi.Pack("getAvailableAmountByPair", "ETH-NEO")
	availableResult, _, err = sample_kvm.Call(address, getAvailableInput, &sample_kvm.Config{State: state})
	if err != nil {
		t.Fatal(err)
	}

	if big.NewInt(0).SetBytes(availableResult).Cmp(big.NewInt(10)) != 0 {
		t.Fatal("Expect available input is 10, got", big.NewInt(0).SetBytes(availableResult).String())
	}

	originalNeoTxId := "originalNeoTxId"
	// Match request sell 10 NEO for 1 ETH
	matchInput2, e5 := abi.Pack("matchOrder", "NEO-ETH", "ETH-NEO", "neosender2", "ethReceiver2", originalNeoTxId, big.NewInt(10))
	if e5 != nil {
		t.Fatal(e5)
	}
	_, _, e6 = sample_kvm.Call(address, matchInput2, &sample_kvm.Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}
	// GetMatching info for 1st added order
	// now should return info of 2nd order
	getMatchingInput1, e5 = abi.Pack("getMatchingOrderInfo", originalEthTxID)
	if e5 != nil {
		t.Fatal(e5)
	}
	matchingResult1, _, e6 = sample_kvm.Call(address, getMatchingInput1, &sample_kvm.Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}

	unpackErr = abi.Unpack(&decodedMatchResult, "getMatchingOrderInfo", matchingResult1)
	if unpackErr != nil {
		t.Fatal(unpackErr)
	}
	if decodedMatchResult.MatchedOrderID != originalNeoTxId {
		t.Error("Expect id  ", originalNeoTxId, " got ", decodedMatchResult.MatchedOrderID)
	}
	if decodedMatchResult.DestAddress != "ethReceiver2" {
		t.Error("Expect address ethReceiver2, got ", decodedMatchResult.DestAddress)
	}
	if decodedMatchResult.SendAmount.Cmp(big.NewInt(1)) != 0 {
		t.Error("Expect send amount 1, got ", decodedMatchResult.SendAmount.String())
	}

	// GetMatching of NEO-ETH matching from NEO side (2nd order)
	// now should return info of 1st order from ETH -> NEO
	getMatchingInput2, e5 := abi.Pack("getMatchingOrderInfo", originalNeoTxId)
	if e5 != nil {
		t.Fatal(e5)
	}
	matchingResult1, _, e6 = sample_kvm.Call(address, getMatchingInput2, &sample_kvm.Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}

	unpackErr = abi.Unpack(&decodedMatchResult, "getMatchingOrderInfo", matchingResult1)
	if unpackErr != nil {
		t.Fatal(unpackErr)
	}
	if decodedMatchResult.MatchedOrderID != originalEthTxID {
		t.Error("Expect id ", originalEthTxID, " got ", decodedMatchResult.MatchedOrderID)
	}
	if decodedMatchResult.DestAddress != "neoReceiver1" {
		t.Error("Expect address neoReceiver1, got ", decodedMatchResult.DestAddress)
	}
	if decodedMatchResult.SendAmount.Cmp(big.NewInt(10)) != 0 {
		t.Error("Expect send amount 10, got ", decodedMatchResult.SendAmount.String())
	}

	// complete order 1
	completeInput1, e7 := abi.Pack("completeOrder", originalEthTxID, "ETH-NEO")
	if (e7 != nil) {
		t.Fatal(e7)
	}
	completeResult1, gas, e8 := sample_kvm.Call(address, completeInput1, &sample_kvm.Config{State: state})
	if (e8 != nil ) {
		t.Fatal(e8)
	}
	if big.NewInt(0).SetBytes(completeResult1).Cmp(big.NewInt(1)) != 0 {
		t.Fatal("Complete order failed")
	}

	// complete order 2
	completeInput1, e7 = abi.Pack("completeOrder", originalNeoTxId, "NEO-ETH")
	if (e7 != nil) {
		t.Fatal(e7)
	}
	completeResult1, gas, e8 = sample_kvm.Call(address, completeInput1, &sample_kvm.Config{State: state})
	if (e8 != nil ) {
		t.Fatal(e8)
	}
	if big.NewInt(0).SetBytes(completeResult1).Cmp(big.NewInt(1)) != 0 {
		t.Fatal("Complete order failed")
	}
	originalEthTxId2 := "ethtxid2"
	// Match 2 eth for 20 neo
	matchInput1, e5 = abi.Pack("matchOrder", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver1", originalEthTxId2, big.NewInt(2))
	if e5 != nil {
		t.Fatal(e5)
	}
	_, gas, e6 = sample_kvm.Call(address, matchInput1, &sample_kvm.Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}
	var matchableAmounts struct {
		Amounts		[]*big.Int	`abi:"amounts"`
	}
	// get matchable amount for NEO, should be 20 NEO
	getMatchAmountsInput, _ := abi.Pack("getMatchableAmount", "ETH-NEO")
	matchAmountsResult, gas, e6 := sample_kvm.Call(address, getMatchAmountsInput, &sample_kvm.Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}
	err = abi.Unpack(&matchableAmounts, "getMatchableAmount", matchAmountsResult)
	if len(matchableAmounts.Amounts) == 0 {
		t.Fatal("Invalid matchable amount")
	}
	if matchableAmounts.Amounts[0].Cmp(big.NewInt(10)) != 0 {
		t.Error("Expect 1st matchable amount to be 10, got ", matchableAmounts.Amounts[0].String())
	}
	originalEthTxId3 := "ethtxid3"
	// Match 3 other eth for 30 neo
	matchInput1, e5 = abi.Pack("matchOrder", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver1", originalEthTxId3, big.NewInt(3))
	if e5 != nil {
		t.Fatal(e5)
	}
	_, gas, e6 = sample_kvm.Call(address, matchInput1, &sample_kvm.Config{State: state})
	if e6 != nil {
		t.Fatal(e6, gas)
	}

	getMatchAmountsInput, _ = abi.Pack("getMatchableAmount", "ETH-NEO")
	matchAmountsResult, gas, e6 = sample_kvm.Call(address, getMatchAmountsInput, &sample_kvm.Config{State: state})
	if e6 != nil {
		t.Fatal(e6)
	}
	err = abi.Unpack(&matchableAmounts, "getMatchableAmount", matchAmountsResult)
	if len(matchableAmounts.Amounts) == 0 {
		t.Fatal("Invalid matchable amount")
	}
	
	if matchableAmounts.Amounts[0].Cmp(big.NewInt(10)) != 0 {
		t.Error("Expect 1st matchable amount to be 10, got ", matchableAmounts.Amounts[0].String())
	}
	if matchableAmounts.Amounts[1].Cmp(big.NewInt(20)) != 0 {
		t.Error("Expect 2nd matchable amount to be 20, got ", matchableAmounts.Amounts[1].String())
	}
	if matchableAmounts.Amounts[2].Cmp(big.NewInt(30)) != 0 {
		t.Error("Expect 3rd matchable amount to be 30, got ", matchableAmounts.Amounts[2].String())
	}
}

func TestGetOrderBook(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(kaidb.NewMemStore()))
	address := common.HexToAddress("0x0a")
	state.SetCode(address, code)
	abi, err := abi.JSON(strings.NewReader(definition))
	if err != nil {
		t.Fatal(err)
	}
	getRateInput, e1 := abi.Pack("getRatePublic", "ETH-NEO")
	if e1 != nil {
		t.Fatal(e1)
	}
	// Now we add rate for ETH-NEO first
	setRateInput, e2 := abi.Pack("addRate", "ETH-NEO", big.NewInt(1), big.NewInt(10))
	if e2 != nil {
		t.Fatal(e2)
	}
	_, _, e3 := sample_kvm.Call(address, setRateInput, &sample_kvm.Config{State: state})
	if e3 != nil {
		t.Fatal(e3)
	}
	rateResult, _, errCallRate := sample_kvm.Call(address, getRateInput, &sample_kvm.Config{State: state})
	if errCallRate != nil {
		t.Fatal(errCallRate)
	}
	var rateStruct struct {
		Sale    *big.Int `abi:"sale"`
		Receive *big.Int `abi:"receive"`
	}

	// Call get rate for ETH-NEO to check if we set it correctly
	e5 := abi.Unpack(&rateStruct, "getRatePublic", rateResult)
	if e5 != nil {
		t.Fatal(e5)
	}
	if rateStruct.Sale.Cmp(big.NewInt(1)) != 0 || rateStruct.Receive.Cmp(big.NewInt(10)) != 0 {
		t.Error("Error get value, expected 1, 10 got ", rateStruct.Sale.String(), rateStruct.Receive.String())
	}

	// Now we add rate for NEO-ETH to start matching orders
	setRateInput2, e6 := abi.Pack("addRate", "NEO-ETH", big.NewInt(10), big.NewInt(1))
	if e6 != nil {
		t.Fatal(e6)
	}
	_, _, e7 := sample_kvm.Call(address, setRateInput2, &sample_kvm.Config{State: state})
	if e7 != nil {
		t.Fatal(e7)
	}
	originalEthTxId := "ethtxid1"
	// Start matching 1 eth for 10 neo
	matchInput1, e8 := abi.Pack("matchOrder", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver1", originalEthTxId, big.NewInt(1))
	if e8 != nil {
		t.Fatal(e8)
	}
	_, _, e9 := sample_kvm.Call(address, matchInput1, &sample_kvm.Config{State: state})
	if e9 != nil {
		t.Fatal(e9)
	}
	// Now we get order list of eth - neo
	getOrderInput, e10 := abi.Pack("getOrderBook", "ETH-NEO")
	if e10 != nil {
		t.Fatal(e10)
	}
	orderBookResult,_, e11 := sample_kvm.Call(address, getOrderInput, &sample_kvm.Config{State: state})
	if e11 != nil {
		t.Fatal(e11)
	}
	var orders struct {
		OrderBook string
	}
	e12 := abi.Unpack(&orders, "getOrderBook", orderBookResult)
	if e12 != nil {
		t.Fatal(e12)
	}
	if orders.OrderBook != "ETH-NEO;ethsender1;neoReceiver1;ethtxid1;1;10;;0" {
		t.Fatal("ETH-NEO;ethsender1;neoReceiver1;ethtxid1;1;10;;0, got ", orders.OrderBook)
	}
	originalEthTxId2 := "ethtxid2"
	// Start matching 2 eth for 20 neo
	matchInput1, e8 = abi.Pack("matchOrder", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver2", originalEthTxId2, big.NewInt(2))
	if e8 != nil {
		t.Fatal(e8)
	}
	_, _, e9 = sample_kvm.Call(address, matchInput1, &sample_kvm.Config{State: state})
	if e9 != nil {
		t.Fatal(e9)
	}
	getOrderInput, e10 = abi.Pack("getOrderBook", "ETH-NEO")
	if e10 != nil {
		t.Fatal(e10)
	}
	orderBookResult,_, e11 = sample_kvm.Call(address, getOrderInput, &sample_kvm.Config{State: state})
	if e11 != nil {
		t.Fatal(e11)
	}
	e12 = abi.Unpack(&orders, "getOrderBook", orderBookResult)
	if e12 != nil {
		t.Fatal(e12)
	}
	if orders.OrderBook != "ETH-NEO;ethsender1;neoReceiver1;ethtxid1;1;10;;0|ETH-NEO;ethsender1;neoReceiver2;ethtxid2;2;20;;0" {
		t.Fatal("Expect ETH-NEO;ethsender1;neoReceiver1;ethtxid1;1;10;;0|ETH-NEO;ethsender1;neoReceiver2;ethtxid2;2;20;;0, got ", orders.OrderBook)
	}
}

func TestGetOrderHistory(t *testing.T) {
	state, _ := state.New(log.New(), common.Hash{}, state.NewDatabase(kaidb.NewMemStore()))
	address := common.HexToAddress("0x0a")
	state.SetCode(address, code)
	abi, err := abi.JSON(strings.NewReader(definition))
	if err != nil {
		t.Fatal(err)
	}
	getRateInput, e1 := abi.Pack("getRatePublic", "ETH-NEO")
	if e1 != nil {
		t.Fatal(e1)
	}
	// Now we add rate for ETH-NEO first
	setRateInput, e2 := abi.Pack("addRate", "ETH-NEO", big.NewInt(1), big.NewInt(10))
	if e2 != nil {
		t.Fatal(e2)
	}
	_, _, e3 := sample_kvm.Call(address, setRateInput, &sample_kvm.Config{State: state})
	if e3 != nil {
		t.Fatal(e3)
	}
	rateResult, _, errCallRate := sample_kvm.Call(address, getRateInput, &sample_kvm.Config{State: state})
	if errCallRate != nil {
		t.Fatal(errCallRate)
	}
	var rateStruct struct {
		Sale    *big.Int `abi:"sale"`
		Receive *big.Int `abi:"receive"`
	}

	// Call get rate for ETH-NEO to check if we set it correctly
	e5 := abi.Unpack(&rateStruct, "getRatePublic", rateResult)
	if e5 != nil {
		t.Fatal(e5)
	}
	if rateStruct.Sale.Cmp(big.NewInt(1)) != 0 || rateStruct.Receive.Cmp(big.NewInt(10)) != 0 {
		t.Error("Error get value, expected 1, 10 got ", rateStruct.Sale.String(), rateStruct.Receive.String())
	}

	// Now we add rate for NEO-ETH to start matching orders
	setRateInput2, e6 := abi.Pack("addRate", "NEO-ETH", big.NewInt(10), big.NewInt(1))
	if e6 != nil {
		t.Fatal(e6)
	}
	_, _, e7 := sample_kvm.Call(address, setRateInput2, &sample_kvm.Config{State: state})
	if e7 != nil {
		t.Fatal(e7)
	}
	originalEthTxId := "ethtxid1"
	// Start matching 1 eth for 10 neo
	matchInput1, e8 := abi.Pack("matchOrder", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver1", originalEthTxId, big.NewInt(1))
	if e8 != nil {
		t.Fatal(e8)
	}
	_, _, e9 := sample_kvm.Call(address, matchInput1, &sample_kvm.Config{State: state})
	if e9 != nil {
		t.Fatal(e9)
	}

	originalEthTxId2 := "ethtxid2"
	// Start matching 2 eth for 20 neo
	matchInput1, e8 = abi.Pack("matchOrder", "ETH-NEO", "NEO-ETH", "ethsender1", "neoReceiver2", originalEthTxId2, big.NewInt(2))
	if e8 != nil {
		t.Fatal(e8)
	}
	_, _, e9 = sample_kvm.Call(address, matchInput1, &sample_kvm.Config{State: state})
	if e9 != nil {
		t.Fatal(e9)
	}
	getOrderInput, e10 := abi.Pack("getOrderHistoryByPair", "ethsender1", "ETH-NEO")
	if e10 != nil {
		t.Fatal(e10)
	}
	orderBookResult,_, e11 := sample_kvm.Call(address, getOrderInput, &sample_kvm.Config{State: state})
	if e11 != nil {
		t.Fatal(e11)
	}
	var orders struct {
		OrderHistory string
	}
	e12 := abi.Unpack(&orders, "getOrderHistoryByPair", orderBookResult)
	if e12 != nil {
		t.Fatal(e12)
	}
	if orders.OrderHistory != "ETH-NEO;ethsender1;neoReceiver1;ethtxid1;1;10;;0|ETH-NEO;ethsender1;neoReceiver2;ethtxid2;2;20;;0" {
		t.Fatal("Expect ETH-NEO;ethsender1;neoReceiver1;ethtxid1;1;10;;0|ETH-NEO;ethsender1;neoReceiver2;ethtxid2;2;20;;0, got ", orders.OrderHistory)
	}
}
